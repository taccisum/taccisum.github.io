<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>用 Wireshark 抓包 Redis</title>
      <link href="/redis-wireshark.html"/>
      <url>/redis-wireshark.html</url>
      <content type="html"><![CDATA[<p>Redis 有自己的一套传输协议（RESP），因此想通过 Wireshark 抓包 Redis 得先安装插件，具体步骤如下：</p><ol><li>找到你的 Wireshark 安装目录下的 <code>init.lua</code> 所在的文件夹</li></ol><p>例如我的是 MacOS，通过 DMG 安装的，是在 <code>/Applications/Wireshark.app/Contents/Resources/share/wireshark</code> 目录下</p><ol start="2"><li><p>把 <a href="https://github.com/jzwinck/redis-wireshark/blob/master/redis-wireshark.lua" target="_blank" rel="noopener">redis-wireshark.conf</a> 整个文件 copy 放在上述目录下</p></li><li><p>编辑 <code>init.lua</code> 添加以下内容，加载第 2 步放进去的 lua 脚本</p></li></ol><pre class="line-numbers language-lua"><code class="language-lua"><span class="token comment" spellcheck="true">-- 其它内容...</span><span class="token keyword">if</span> <span class="token keyword">not</span> running_superuser <span class="token keyword">or</span> run_user_scripts_when_superuser <span class="token keyword">then</span>    <span class="token function">dofile</span><span class="token punctuation">(</span>DATA_DIR<span class="token operator">..</span><span class="token string">"console.lua"</span><span class="token punctuation">)</span>    <span class="token function">dofile</span><span class="token punctuation">(</span>DATA_DIR<span class="token operator">..</span><span class="token string">"redis-wireshark.lua"</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">-- 这行是你要新加的，其它都是原有的</span><span class="token keyword">end</span><span class="token comment" spellcheck="true">-- 其它内容...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li><p>重启 Wireshark 或使用 UI 上的 <code>Analyse -&gt; Reload Lua Plugins</code> 功能（CMD + SHIFT + L）重新加载插件</p></li><li><p>启动抓包，用 <code>redis-cli</code> 连接你的 Redis，随便输入一些命令（我这里示例是 <code>get tac</code>），在 Wireshark filter 框框中输入 <code>redis</code> 过滤协议，看到以下数据说明成功了</p></li></ol><p><img src="images/redis-wireshark/example.jpg" alt="redis-wireshark-example"></p>]]></content>
      
      <categories>
          
          <category> middlewire </category>
          
          <category> redis </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>只靠一个米家门窗传感器搞定浴室自动化</title>
      <link href="/bathroom_automation.html"/>
      <url>/bathroom_automation.html</url>
      <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近心血来潮买了个<a href="https://www.xiaomiyoupin.com/detail?gid=101464" target="_blank" rel="noopener">米家门窗传感器</a>，打算用在浴室实现一种<strong>人来灯亮，人走灯灭</strong>的效果，但买回来后却发现实际场景比我想象中要复杂得多。为啥呢？门窗传感器最大的问题在于只能感知开/合两种状态，所以无法得知是否有人在浴室内。如果你仅靠闭门来触发关灯的话，就会有一个大问题：当你触发开门的时候灯亮了，然后你走进浴室，这时关门，pa 的一下，灯灭了。。尴尬。。</p><h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><p>如果要解决这个问题，首先想到的是再买个人体红外感应器配合来用。但一来吧，总觉得为了这一个小自动化功能买两个传感器不经济；二来红外感应器在浴室的表现并不好（覆盖角度有限制而且有些浴室设计还是分区的，加上浴室水蒸气有时会干扰红外检）因此不是个很好的方案。</p><p>但东西都买回来了，总不能丢一边吃灰吧。好在办法总比困难多。门窗传感器本身虽然不足以检测到人，但米家给我们提供了其它逻辑工具啊~</p><p>来看看这个问题，其实可以抽象成如何设计一个<strong>有限状态机（Finite Automate）</strong>以保证浴室自动化符合我们的要求的问题，其中：</p><p>要处理的浴室状态有：</p><ul><li><strong>close_out</strong>: 室内无人且门属于关闭状态（此状态时灯与排气扇关闭）</li><li><strong>open_wait</strong>: 室内无人且门属于打开等待进入状态（此状态时灯与排气扇打开）</li><li><strong>close_in</strong>: 室内有人且门属于关闭状态（此状态时灯与排气扇保持打开）</li><li><strong>open_in</strong>: 室内有人且门属于打开状态（此状态时灯与排气扇区保持打开）</li></ul><blockquote><p>tips: 因为还要考虑人是否在内，所以要考虑的状态有四个而非简单的开和闭两个。</p></blockquote><p>影响状态变换的条件有：</p><ul><li><strong>open</strong>: 浴室门打开</li><li><strong>close</strong>: 浴室门关闭</li></ul><p>但实际上还有个隐藏条件可以利用：</p><ul><li><strong>time_elaspe</strong>: 时间流逝 ns（比如我们假定现实中 90% 的场景下人进入浴室，都会在 15s 内关上门）</li></ul><p>如果把人工干预也算上，那还可以加上：</p><ul><li><strong>manual</strong>: 检测到手动操作（例如，手动关灯）</li></ul><p>最终设计出来的状态变换图如下</p><p><img src="/images/toilet_fa/tfa.jpg" alt="toilet fa"></p><p>其中 <code>close_out</code> 即是起始状态也是最终状态。</p><p>对应状态转换表如下</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center"><strong>open</strong></th><th style="text-align:center"><strong>close</strong></th><th style="text-align:center"><strong>time elaspe</strong></th><th style="text-align:center"><strong>manual</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong>close_out</strong></td><td style="text-align:center">open_wait</td><td style="text-align:center">-</td><td style="text-align:center">-</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><strong>open_wait</strong></td><td style="text-align:center">-</td><td style="text-align:center">close_out</td><td style="text-align:center">open_in</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><strong>close_in</strong></td><td style="text-align:center">close_out</td><td style="text-align:center">-</td><td style="text-align:center">-</td><td style="text-align:center">close_out</td></tr><tr><td style="text-align:center"><strong>open_in</strong></td><td style="text-align:center">-</td><td style="text-align:center">close_out</td><td style="text-align:center">-</td><td style="text-align:center">-</td></tr></tbody></table><blockquote><p>横杠 - 表示该状态下不接受此输入的意思</p></blockquote><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>接下来我们把要处理的场景跑一遍，看上述 FA 能否满足我们的要求。</p><p>为了简化表述，我们把状态和条件均用数字代替：</p><ul><li>state set: close_out(1), open_wait(2), close_in(3), open_in(4)</li><li>criteria: open(1), close(2), time_elaspe(3)</li></ul><p><img src="/images/toilet_fa/tfa_num.jpg" alt="toilet fa with numbers"></p><h3 id="场景一：长时间事务，会关门进行（如洗澡，蹲坑）"><a href="#场景一：长时间事务，会关门进行（如洗澡，蹲坑）" class="headerlink" title="场景一：长时间事务，会关门进行（如洗澡，蹲坑）"></a>场景一：长时间事务，会关门进行（如洗澡，蹲坑）</h3><p>输入：1, 2, 1, 2<br>状态变换过程：1-&gt;2-&gt;3-&gt;4-&gt;1</p><p><img src="/images/toilet_fa/tfa_scene1.jpg" alt="toilet fa scene 1"></p><p>最终状态为 <code>close_out</code>，可接受，符合预期</p><h4 id="子场景-1-1：人在里边临时开门（不超时）"><a href="#子场景-1-1：人在里边临时开门（不超时）" class="headerlink" title="子场景 1.1：人在里边临时开门（不超时）"></a>子场景 1.1：人在里边临时开门（不超时）</h4><p>输入：1, 2, 1, 2<br>状态变换过程：1-&gt;2-&gt;3-&gt;4-&gt;1<br>最终状态为为 <code>close_out</code>，可接受，但<strong>不符合预期</strong>（预期状态是保持 <code>close_in</code>），需要将输入调整为 1, 2, 1, 2, 1, 2（也就是临时开门后再执行一次开关门，中间会经历一次灯断电，体验稍差）<br>状态变换过程：1-&gt;2-&gt;3-&gt;4-&gt;1-&gt;2-&gt;3，符合预期</p><p><img src="/images/toilet_fa/tfa_scene1_1.jpg" alt="toilet fa scene 1.1"></p><h3 id="场景二：短时间事务，不关门（如洗手，时间足以触发条件-3）"><a href="#场景二：短时间事务，不关门（如洗手，时间足以触发条件-3）" class="headerlink" title="场景二：短时间事务，不关门（如洗手，时间足以触发条件 3）"></a>场景二：短时间事务，不关门（如洗手，时间足以触发条件 3）</h3><p>输入：1, 3, 2<br>状态变换过程：1-&gt;2-&gt;4-&gt;1</p><p><img src="/images/toilet_fa/tfa_scene2.jpg" alt="toilet fa scene 2"></p><p>最终状态为 <code>close_out</code>，可接受，符合预期</p><h3 id="场景三：误操作，开门后立马关门（时间不足以触发条件-3）"><a href="#场景三：误操作，开门后立马关门（时间不足以触发条件-3）" class="headerlink" title="场景三：误操作，开门后立马关门（时间不足以触发条件 3）"></a>场景三：误操作，开门后立马关门（时间不足以触发条件 3）</h3><p>输入：1, 2<br>状态变换过程：1-&gt;2-&gt;3<br>最终状态为 <code>close_in</code>，非可接受状态，因此要人工介入，使得</p><p>输入变为： 1, 2, 4<br>状态变换过程：1-&gt;2-&gt;3-&gt;1</p><p><img src="/images/toilet_fa/tfa_scene3.jpg" alt="toilet fa scene 3"></p><p>最终状态回到 <code>close_out</code>，可接受，符合预期</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>可以看到在场景 1.1 &amp; 3 下若没有人工介入依然是无法很好地处理的。好在 1&amp;2 占了我们日常场景的 90% 以上，总的来说此方案还是利大于弊。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>由于笔者使用的是米家 APP，因此这里仅展示基于米家『场景』模块的实现（理论上只要支持上述触发条件的平台都能实现）</p><blockquote><p>这里的场景指的是米家 APP 上的『场景』模块，与我们文章上述提到的场景并非同一概念<br>米家场景分为自动（又称作<strong>智能</strong>）和手动两类，手类执行的场景除了手动操作外，还可以通过自动场景来触发</p></blockquote><p>我们把浴室的状态与米家的场景对应起来（有些状态可能会对应多个场景），得到以下场景</p><h3 id="close-out"><a href="#close-out" class="headerlink" title="close_out"></a>close_out</h3><ul><li>触发条件：门窗传感器开</li><li>执行动作：<ol><li>开浴室灯 &amp; 排气扇（这块可以根据实际需求自行调整）</li><li>关闭智能 <code>close_out</code></li><li>开启智能 <code>open_wait</code></li><li>关闭智能 <code>open_in</code></li><li>执行手动场景 <code>open_wait.time_elaspe</code></li></ol></li></ul><blockquote><p>tips: 其中命名 <code>close_out</code> 代表该米家场景打开时我们的浴室是处在状态 <code>close_out</code> 的，一旦检测到门窗传感器打开将执行相应动作。动作 2&amp;3 组合起来实现了状态切换的效果（关闭当前智能，打开目标状态对应的智能，也就是 <code>open_in</code>）；动作 5 是模拟以时间条件为输入的效果，详见 <code>open_wait.time_elaspe</code> 的配置<br>此外，这里还出现了一个看似没啥用的动作 <strong>关闭 open_in</strong>，将在后面作解答</p></blockquote><h3 id="open-wait-time-elaspe"><a href="#open-wait-time-elaspe" class="headerlink" title="open_wait.time_elaspe"></a>open_wait.time_elaspe</h3><ul><li>触发条件：手动触发</li><li>执行动作：<ol><li>延时 15s（时间可以自行调整成符合家庭习惯的数值）</li><li>开启 <code>open_in</code></li></ol></li></ul><h3 id="open-wait"><a href="#open-wait" class="headerlink" title="open_wait"></a>open_wait</h3><ul><li>触发条件：门窗传感器关</li><li>执行动作：<ol><li>关闭智能 <code>open_wait</code></li><li>开启智能 <code>close_in</code></li><li>开启智能 <code>close_in.manual</code></li><li>关闭智能 <code>open_in</code></li></ol></li></ul><blockquote><p>tips: 这里的状态切换是由动作 1&amp;2&amp;3 共同组成的，这是因为在我们的状态转换表里面 <code>close_in</code> 状态是可以被条件 <code>open</code> / <code>manual</code> 任其一触发转换到其它状态，所以状态 <code>close_in</code> 其实是对应了两个米家智能，这两个智能只能是<strong>同时开启</strong>或<strong>同时关闭</strong>，才能保证自动化不会出现混乱</p></blockquote><h3 id="close-in"><a href="#close-in" class="headerlink" title="close_in"></a>close_in</h3><ul><li>触发条件：门窗传感器开</li><li>执行动作：<ol><li>关闭智能 <code>close_in</code></li><li>关闭智能 <code>close_in.manual</code></li><li>开启智能 <code>open_in</code></li></ol></li></ul><h3 id="close-in-manual"><a href="#close-in-manual" class="headerlink" title="close_in.manual"></a>close_in.manual</h3><ul><li>触发条件：浴室灯 or 排气扇任一关闭（这块可以根据实际需求自行调整）</li><li>执行动作：<ol><li>关浴室灯 &amp; 排气扇（这块可以根据实际需求自行调整）</li><li>关闭智能 <code>close_in</code></li><li>关闭智能 <code>close_in.manual</code></li><li>开启智能 <code>close_out</code></li><li>关闭智能 <code>open_in</code></li></ol></li></ul><h3 id="open-in"><a href="#open-in" class="headerlink" title="open_in"></a>open_in</h3><ul><li>触发条件：门窗传感器关</li><li>执行动作：<ol><li>关浴室灯 &amp; 排气扇（这块可以根据实际需求自行调整）</li><li>关闭智能 <code>open_in</code></li><li>开启智能 <code>close_out</code></li></ol></li></ul><p>最后，还记得上面提到的 <strong>关闭 open_in</strong> 这个看似没啥用的动作吗，其实不仅在 <code>close_out</code> 状态中，在除 <code>open_in</code> 外的每一个状态动作执行时都要加上这个动作。这是因为利用米家 APP 的延时模拟时间条件的输入这个是无法取消的，即是说一旦执行了 <code>open_wait.time_elaspe</code>，15s 后必定会打开 <code>open_in</code> 场景，而这时我们的浴室可能处在任何一个状态。为了避免因此导致的混乱，我们才需要在每个状态的动作加入此动作</p><blockquote><p>tips: 超时效果也可以通过门窗传感器自带的超时未关通知能力来实现，这样就相当于是可中断的，不需要上述的的补偿操作了。但有个问题是，目前我这款传感器好像只支持配置分钟时间粒度</p></blockquote><p>手机截图如下</p><p><img src="/images/toilet_fa/tfa_mihome.JPG" alt="toilet fa scene 1"></p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>以上配置对于普通用户（尤其是没有编程基础的）来说还是有些过于复杂了，建议厂家可以将状态机直接集成到门窗传感器中的，用户只要决定用或不用即可。</p><p>另外，米家平台提供的基础能力也比较有限（可能是基于易用性及安全性的考虑？），导致很多效果实现起来还是比较困难。不管怎样，希望希望米家能加入一些变量能力，可以通过动作来设置变量值，也可以根据变量值的不同来触发不同的智能，这样会有更高的可玩性。</p>]]></content>
      
      <categories>
          
          <category> home automation </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 智能家居 </tag>
            
            <tag> 米家 </tag>
            
            <tag> 有限状态机 </tag>
            
            <tag> DFA </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>记一次 springfox 扩展之旅 —— 动态 api 文档</title>
      <link href="/%E8%AE%B0%E4%B8%80%E6%AC%A1%20springfox%20%E6%89%A9%E5%B1%95%E4%B9%8B%E6%97%85%20%E2%80%94%E2%80%94%20%E5%8A%A8%E6%80%81%20api%20%E6%96%87%E6%A1%A3.html"/>
      <url>/%E8%AE%B0%E4%B8%80%E6%AC%A1%20springfox%20%E6%89%A9%E5%B1%95%E4%B9%8B%E6%97%85%20%E2%80%94%E2%80%94%20%E5%8A%A8%E6%80%81%20api%20%E6%96%87%E6%A1%A3.html</url>
      <content type="html"><![CDATA[<p>出于 <a href="https://github.com/pigeon-cp/pigeon" target="_blank" rel="noopener">Pigeon</a> 项目的需要，我需要把通过插件支持的扩展信息在 swagger api 文档中动态展示出来。</p><p>项目使用的是 springfox 框架生成的 swagger 文档，众所周知 springfox 是注解型的文档框架，而且文档内容是直接写死的，不支持动态化，估摸着是需要自己扩展了。</p><p>按照惯例，先了解代码架构（由于以前都是使用为主，没有深入了解，也不知道有哪些拓展点）。发现 springfox 其实是在应用启动时 scan 带有 swagger 注解的类和字段，生成一个叫 <code>Documentation</code> 的类，然后通过 mapper 转换成相应的 swagger model（v1.2 or v2）。</p><p>可见，我们要分析的 code 可以缩小到 Docuementation 生成的过程，主要关注 @ApiParam, @ApiPropertyModel 这几个注解的解析步骤。</p><p>继续深入，发现 Documentation 的生成是通过 DocumentationPlugin 来做的，而调度 plugins 则是在 DocumentationPluginsBootstrapper 中。DocumentationPluginsBootstrapper 又是从哪里被调用的呢？没错，是通过 SpringfoxWebMvcConfiguration scan package <code>springfox.documentation.spring.web.plugins</code> 时被加载到 spring context 中的，由于这是一个 SmartLifecycle，因此会自动执行 <code>#start</code> 方法。在这个方法中会 foreach plugins，通过 plugin 得到的文档 context（context 中包含了 api 信息，而这些信息其实正是 spring mvc 维护着的 request handlers），再经由 scanner scan 整个 context 生成 Documentation 后加入到 DocumentationCache 中，后续通过 <code>/api-v2/docs</code> 接口访问时就是直接从 cache 中去获取到 Documentation 的。</p><p>上面提到的 plugins 又是什么呢？这个概念大家可能比较陌生，但只要是用过 springfox 的小伙伴，对 <code>Docket</code> 这个类肯定不陌生。没错，Docket 其实也是实现了 DocumentationPlugin 的一个类，根据官方的描述</p><blockquote><p>Docket is a builder which is intended to be the primary interface into the Springfox framework.<br>Provides sensible defaults and convenience methods for configuration.</p></blockquote><p>回归主题，DocumentationPluginsBootstrapper 使用的 scanner 是 ApiDocumentationScanner。追踪源码发现，这个 scanner 中又细分为 ApiListingReferenceScanner（扫描引用 model 的）ApiListingScanner （扫描 apis 的），后者正是关键类。继续深入，在 ApiListingScanner -&gt; ApiDescriptionReader -&gt; ApiOperationReader 中发现，Operation（即维护 api 的路径、参数等具体描述的类）正是在其中通过 20+ OperationBuilderPlugin 组成的 filter 器链共同构建而成。根据名称大概筛选了一下，最终锁定了 OperationParameterReader 这个类。该类在处理参数时又会分成需要 expand 的（@RequestBody 之流）和不需要 expand 的（@ApiParam 直接标注的参数）。</p><p>先来看不需要 expand 的，最终会交由 ParameterBuilderPlugin 链处理，因此我简单写了一个扩展</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PigeonExtendParamBuilder</span> <span class="token keyword">implements</span> <span class="token class-name">ParameterBuilderPlugin</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span>ParameterContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">resolvedMethodParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInstanceOf</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            context<span class="token punctuation">.</span><span class="token function">parameterBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">allowableValues</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AllowableListValues</span><span class="token punctuation">(</span>Lists<span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token string">"MAIL"</span><span class="token punctuation">,</span> <span class="token string">"SMS"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"String"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span>DocumentationType documentationType<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>跑下程序，果然所有 @ApiParam 标注的 string 类型参数都被加上了 Available values : MAIL, SMS 限制。但在 body 定义里面的参数没有效果，一开始推测是跟上述的 expand 概念有关，但后来发现不是，而是这类参数最终会指向一个 ModelRef，因此应该是与 Model 的解析有关。那 Model 的解析是在什么时候呢，同样是在 <code>ApiListingScanner#scan</code> 方法中，交由 ApiModelReader 完成。 ApiModelReader 会通过由 Spring MVC 维护的 RequestMapping 信息提取 model 信息（例如 @RequestBody, @Requestpart 之流），然后交给  <code>ModelProvied#modelFor</code> 转换成 springfox 的 Model 对象，此 Model 对象即是 ModelRef 引用的 Model。</p><p>在 <code>#modelFor</code> 中，会通过反射解析出 Model 对应的 class 中的所有字段信息（称为 ModelProperty），而这个过程则是交给 <code>ModelPropertiesProvider#propertiesFor</code> 完成的，其中细节比较多，但总的来说，最终都是交由 <code>ModelPropertyBuilderPlugin</code> 链来处理的，这个类也正是我们要找的扩展点。后续简单验证了一下，确实是有效的。</p><p>最终效果：</p>]]></content>
      
      
    </entry>
    
    <entry>
      <title>有关沟通成本的一点点思考</title>
      <link href="/thinking_about_cost_of_communication.html"/>
      <url>/thinking_about_cost_of_communication.html</url>
      <content type="html"><![CDATA[<blockquote><p>团队协作最大的成本是沟通成本。如何降低沟通成本，是管理者需要持续思考的问题。</p></blockquote><p>日常沟通的本质，究其根本其实是由<strong>一系列的逻辑推理构成</strong>。而所谓的达成一致意见，即是我们<strong>对同一个命题推导出了同样的结论</strong>。</p><p>对于这一点，可能有些同学并不认同。这是因为我们的交流往往不会以十分正式的逻辑推理过程进行，而是更多的<strong>口语化</strong>进行。</p><p><strong>比方说</strong>：今天应该会下雨。这样简单的一句话就包括了逻辑推理，只是大前提小前提均没有明确而以，需要我们根据当时聊天的语境来确定。假如你是因为昨天看了天气预报，那你的大前提是：按以往经验，如果天气预报预测说会下雨，那大概率会下雨；小前提是：昨天的天气预报说今天会下雨；结论就是：今天应该会下雨。如果换一种场景，是因为你看到今天的天空，那你的大前提是：阴云密布的天气大概念会下雨；小前提是：今天是阴天；结论就是：今天应该会下雨。</p><p>可见，简单的一句话，也是包含了完整的逻辑推理在内的。只不过出于方便，我们在交流时往往会简化许多步骤，并通过我们的大脑运算去补全其它的信息。否则，我们在沟通时的对话便会冗长而啰嗦，<strong>有效信息比低</strong>，因而沟通成本高。</p><p>但这样做也有缺点，就是我们有可能意会错别人的意思，这时就出现了所谓的<strong>误解</strong>。</p><p>假设甲对乙说今天应该会下雨，实际上是因为甲昨天看了天气预报。但乙并没有看，而且乙今天出门时看到天气晴朗，因此并不同意甲的说法。此时要保证沟通顺畅，需要甲补充自己的大前提。如果甲也并没有意识到这个问题，不去向乙解析清楚，那么两个人之间就产生了分岐，产生的原因是沟通中信息的缺失。</p><p>除了信息缺失外，<strong>信息畸变</strong>（想要传递的信息，因为表述不当，导致别人理解错误）也会带来误解，这可能是有意的（偷换概念），也可能是无意的（混淆概念），但导致的结果一样。像同样是偷，偷窃、偷笑就完全不是同一个概念。</p><p>上面讨论的是在信息传递本身，但如果沟通本身<strong>缺少主题</strong>（即没有要讨论的命题），自然也谈不上得出结论，就是在白白浪费时间而以。</p><p>知道了原因，我们便可以确定下来沟通中<strong>应尽力遵守的一些原则</strong>：</p><ul><li><strong>讨论前确定命题</strong>（有时比较迷茫的时候，想借讨论过程本身找到问题其实也是一个命题）</li><li><strong>尽可能使用术语</strong>（术语即是某个领域中的专用概念，保证双方都理解术语的前提下，使用术语可以很有效地降低沟通成本）</li><li><strong>尽可能复用现有术语</strong>（少用一些不常见或自创的概念）</li><li><strong>有意识地创造一些概念</strong>，但需要做到<ul><li>尽力保证其定义准确</li><li>做好概念普及工作，让团队能在一个上下文沟通</li><li>一经确定便不要再修改，这容易带来混乱</li></ul></li><li><strong>避免大量创造不准确、难以理解的概念</strong>（这点在编码中的类、方法、变量命名尤为常见）</li></ul><h2 id="用人过程中常见的雷区"><a href="#用人过程中常见的雷区" class="headerlink" title="用人过程中常见的雷区"></a>用人过程中常见的雷区</h2><h3 id="专业基础太差"><a href="#专业基础太差" class="headerlink" title="专业基础太差"></a>专业基础太差</h3><p>专业基础太差的另一种解释是：<strong>对这个专业领域的概念理解得太少</strong>。</p><p>这会导致你在解释一些问题给他听的时候，需要费非常大的工夫。因为逻辑推理是一层嵌一层的结果，一个上层概念往往是由无数下层概念支撑起来的，如果他对下层概念的理解不够，他是很难去理解一个上层概念的。</p><p>我听到很多朋友问过我一个问题：什么是 Java？内行人士可能完全能理解什么是 Java，但是如果让你向外行解释清楚，你会发现这其实是很困难的一件事。</p><p>这是为什么？因为<strong>我们要真正理解一个概念，不仅要知道其定义，更要理解其内涵</strong>。</p><p>Java 是一个上层概念，它是一门静态的、面向对象的编程语言。但如果你照搬此定义向你的朋友解释，他听完肯定依然一脸懵圈。要对这个概念有深刻的理解，你首先要理解更下一层的概念：语法、框架、虚拟机、IDE 等等。而要理解下一层的概念又要理解更下一层的概念，比如：</p><ul><li>语法的下一层概念有：修饰符、关键字、变量、常量、类、方法等等</li><li>虚拟机的下一层概念有：字节码、堆、栈、class 文件、垃圾回收、操作系统、等等</li></ul><p>如此循环往复，每个上层概念都会牵扯出一堆组成<strong>树状结构</strong>的概念，在不理解底层概念的情况下试图直接去理解上层概念，那必然会非常困难而且理解得也不深刻。</p><p>这些下层的概念其实都已经内化在内行人士心中了，所以跟他们交流时无需过多地解释。但对于外行则完全不一样，这就导致很多时候我们面对这种问题非常无奈。</p><h3 id="理解能力太差"><a href="#理解能力太差" class="headerlink" title="理解能力太差"></a>理解能力太差</h3><p>专业基础差还有一种情况，就是许多概念都知道一点，但不深入，或者理解有错误。这种情况其实比上面更可怕，不懂的人会直接表现出来，而理解有偏差的人，不仅不会表现出来，他们往往还会表现得自己是正确的一样，进而把不明就理的人带歪。</p><p>这也是为什么有人主张在面试的时候，遇到不懂的问题，直接说不懂也好过硬答。</p><h3 id="学习能力太差"><a href="#学习能力太差" class="headerlink" title="学习能力太差"></a>学习能力太差</h3><p>这是个信息爆炸的时代，每天都有新的知识产生、旧的知识消失，学习能力差的人终究会逐渐无法跟上时代的脚步。</p><p>但这个问题会在相对而言的中长期才体现出来，应该视团队当前情况决定是否要与此类人共事。</p><h3 id="三观不合"><a href="#三观不合" class="headerlink" title="三观不合"></a>三观不合</h3><p>所谓三观不合，其实是在一些<strong>基础认知上存在分岐</strong>。比如甲是一个追求完美的人，而乙是一个得过且过的人，那他们在同一个问题上就很可能出现意见不合。而所谓江山易改、本性难移，基础认知是没那么容易改变的。多数人在某一个团队工作短则几月长也就几年，这点时间你是很难去改变一个人的。</p><p>最好的方法是不要与三观不合的人一起共事，这并不一定因为他的认知是错的，只是你们不适合。</p>]]></content>
      
      <categories>
          
          <category> 个人思考 </category>
          
          <category> 软件工程 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>程序猿加班真的是常态吗? —— 浅谈如何治理一个复杂软件系统</title>
      <link href="/how_to_manage_a_complex_software_system.html"/>
      <url>/how_to_manage_a_complex_software_system.html</url>
      <content type="html"><![CDATA[<p>经常听到一些<strong>程序猿加班是常态</strong>的言论，在这里我想尝试下进行反驳。</p><p>先来分析一下这个命题：</p><blockquote><p>程序猿加班是常态 =&gt; 程序猿的工作量巨大 =&gt; 软件系统过于复杂，难以处理。</p></blockquote><p>可见，反驳这个命题的关键就在于回答『<strong>如何治理一个复杂的软件系统</strong>』这个问题。</p><p>接下来深入看下这个问题。<strong>软件系统是什么</strong>？我认为软件系统无非是一个<strong>巨大的逻辑体</strong>。你的任何操作（如点击 web 的一个按钮），其实背后都是一层又一层的逻辑堆砌的结果。</p><p>以浏览器渲染一个按钮（<code>&lt;button&gt;click&lt;/button&gt;</code>）为例，这其实是浏览器解析 HTML 代码的结果。HTML 本身是有逻辑可循的，你必须要按照他的规则编写才能正确地展示 UI，而 HTML 本身又需要浏览器进行解析，这个过程需要用到许多更低一层的逻辑（比如语法解释器，比如图形渲染的接口），这些被依赖的逻辑本身又会依赖更底层的逻辑（比如显卡接口）。 这些逻辑一层嵌一层的，直至最底层的 CPU 指令集。</p><p><strong>因此任何一个复杂系统，本质上其实就是一个庞大的逻辑体</strong>。而这个逻辑体，必然是<strong>分层</strong>的（你见过谁直接用 GPU 的接口来渲染网站吗），否则描述它的复杂度就是<strong>指数级增长</strong>了，以人脑的计算能力很快就无法处理这么复杂的系统了（这就好比在概率论里面，让你连续抛掷10次硬币，再用文字表示其样本空间，你要是用枚举法来表示，可能得写到手软，但要是用笛卡尔积来表示，只需要一行即可）。</p><p>整个网站开发，其实也是分层的，其中最经典的莫过于<strong>三层架构</strong>了（视图层、业务逻辑层、持久层），演化到今天，视图层独立出去成了前端领域，业务逻辑与持久层则归为后端领域（当然，还有更底层的东西，比如说数据库，操作系统，只是大多数开发仔都不需要参与这一块的开发）。</p><p>看起来很完美，前人已经把分层都设计好了，并且那些高难度的底层开发工作往往也有开源组织在承担，稳定性都是经过验证的。我们做应用开发的，只要搞定视图层（前端）跟业务逻辑层（后端）不就好了吗？这点事情都搞不定吗？问题究竟出在哪呢？</p><p>其一是，<strong>单独某一层内的复杂度，其实很多时候是超乎我们想象的，因此需要进一步分层</strong>。</p><p>以业务逻辑层为例，一个简单的用户注册，可能就包括了验证码校验，密码复杂度检测，手机绑定，注册成功欢迎邮件发送，发放优惠券等等业务逻辑，以及缓存、冗余之类的非业务逻辑。这些被依赖的逻辑其实也是同属于业务逻辑层的，并且也会被其他业务逻辑依赖，一旦没有做好划分，那又是重复造轮子，复杂度和工作量都会指数级增长！关于这一块，不同领域的解决方案不同，前端是组件化，而后端是面向对象（虽然是很标准的答案，但我认为真正掌握这两技能的研发同学其实很少，最典型的莫过于拿着面向对象语言，写着面向过程代码），非要抽象出一个更通用的方案的话，我认为可以称之为『<strong>建模</strong>』。前端通过建模，将视图层进一步分拆出<strong>组件层</strong>；后端通过建模，将业务逻辑层进一步分拆出<strong>领域模型层</strong>（在微服务架构中亦称之为<strong>业务中台</strong>）。</p><p>其二则是工程问题了，即<strong>沟通成本的问题</strong>。举个例子，HTML 语言提供了 button 标签，但这个标签除了渲染一个按钮外，还会同时渲染一个文本输入框给我们。这显然不是我们需要的，好在这个标签同时提供了一个配置给我们，可能显式地指定避免渲染文本框（额外的工作是你需要指定该配置 <code>&lt;button disable-input=&#39;true&#39;&gt;click&lt;/button&gt;</code>）。这样子虽然最终实现了想要的效果，但却让代码变得不优雅，不仅你花费了不必要的时间，还导致后来的维护者看到会迷惑，沟通成本由此产生。 尝试把这个现象无限放大，如果你在代码中看到的每一个概念定义都是不可信的，都是与现实世界有偏差的，那么当你要解决一个问题或开发一个新功能的时候，你工作中花在的这些无谓的沟通中的时间就会成倍地提升（尤其是当没有人或文档能解答你的问题的时候），最终远远大于你的编码时间。</p><p>问题分析到这，答案也就出来了。如何治理一个复杂的软件系统？私以为<strong>关键在于做好模型设计，以及维护好概念一致性</strong>。前者可以通过组合逻辑空间的不同维度，使得复杂度的表示难度指数下降，最终达到人脑可以处理的水平。后者则保证模型中的概念跟现实世界是一致的，易于理解，可减少不必要的沟通成本。两者任一没有处理好，均会导致复杂度指数上升，进而导致工作量增大，因此程序猿加班也就成了常态了。经常加班的猿们，都应该先反问下自己，这两点是不是都做得足够好了？如果是，再来问是不是人手不够之类的问题。</p><p>当然现实往往更复杂，很多同学都会以业务方不给时间，上级不支持为由，写出一堆烂代码来。确实这也是一些阻力，但并不能成为人云亦云的借口。有这种想法的同学，要么是选择躺平了，不想去改变现状；要么是缺乏对事物发展规律的认识的，推荐学习一下教员的《<strong>矛盾论</strong>》。</p>]]></content>
      
      <categories>
          
          <category> 个人思考 </category>
          
          <category> 软件工程 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>一个很好用的Spring Boot Starter Swagger</title>
      <link href="/my_swagger_spring_boot_starter.html"/>
      <url>/my_swagger_spring_boot_starter.html</url>
      <content type="html"><![CDATA[<h1 id="Spring-Boot-Starter-Swagger"><a href="#Spring-Boot-Starter-Swagger" class="headerlink" title="Spring Boot Starter Swagger"></a>Spring Boot Starter Swagger</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Swagger与Spring Boot现在在Java Web开发领域是再常用不过的两个框架了。集成这两者的Starter现在在Github上也存在很多（基本都是非官方的，官方好像没有提供Starter），但是大多数或多或少都存在以下问题：</p><ul><li><strong>整合程度低</strong>，许多Springfox-Swagger2提供的功能无法通过Spring Boot的方式进行配置或者配置方式复杂</li><li><strong>项目疏于维护</strong>，许多Issue没人去解决</li><li><strong>扩展性不足</strong>，当用户出现一些需求时只能祈求项目更新或者自行修改源码</li><li><strong>无法同时兼容Spring Boot1.x和Spring Boot2.x</strong></li></ul><p>我曾在Github上找了许久都没找到，索性自行开发了一个。</p><p>这个Starter具有以下特点：</p><ul><li>完美适配springfox-swagger2，几乎支持通过yaml文件进行所有配置</li><li>提供拦截器，允许用户自行扩展自定义配置</li><li>同时支持spring boot1和spring boot2</li><li>扩展了一些小功能，如展示当前hostname等</li></ul><p><a href="https://github.com/taccisum/spring-boot-starter-swagger" target="_blank" rel="noopener"><strong>项目地址</strong></a></p><h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><p>引入依赖</p><p><strong>pom.xml</strong></p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- spring boot1用户 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.github.taccisum<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>swagger-spring-boot1-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>{lastest.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token comment" spellcheck="true">&lt;!-- spring boot2用户 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.github.taccisum<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>swagger-spring-boot2-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>{lastest.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>application.yml</strong></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">swagger</span><span class="token punctuation">:</span>  <span class="token key atrule">base-package</span><span class="token punctuation">:</span> com.github.taccisum.controller<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>启动项目，打开 <a href="http://localhost:8080/swagger-ui.html" target="_blank" rel="noopener">http://localhost:8080/swagger-ui.html</a> 即可查看API文档。</p><p>更多功能可以到 <a href="https://github.com/taccisum/spring-boot-starter-swagger" target="_blank" rel="noopener">https://github.com/taccisum/spring-boot-starter-swagger</a> 了解。</p>]]></content>
      
      <categories>
          
          <category> framework </category>
          
          <category> starter </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>flowable启动流程解析（spring boot）</title>
      <link href="/sourece/flowable/startup/spring_boot.html"/>
      <url>/sourece/flowable/startup/spring_boot.html</url>
      <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>flowable engine一共有5种：App, CMMN, DMN, Form, Process(即BPMN)。</p><p><code>flowable-spring-boot-starter</code>提供了零配置集成flowable的功能，主要包括各类型engine的自动配置、流程/表单定义自动部署，其次还有rest-api，spring boot aucuator集成等。</p><p>这篇文章主要是解析flowable在spring boot环境下的启动流程，不涉及flowable内部原理。</p><h1 id="flowable相关的AutoConfiguration"><a href="#flowable相关的AutoConfiguration" class="headerlink" title="flowable相关的AutoConfiguration"></a>flowable相关的AutoConfiguration</h1><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># flowable-spring-boot-autoconfigure: spring.factories</span><span class="token attr-name">org.springframework.boot.env.EnvironmentPostProcessor</span><span class="token punctuation">=</span><span class="token attr-value">\  org.flowable.spring.boot.environment.FlowableDefaultPropertiesEnvironmentPostProcessor,\  org.flowable.spring.boot.environment.FlowableLiquibaseEnvironmentPostProcessor</span><span class="token comment" spellcheck="true"># Flowable auto-configurations</span><span class="token attr-name">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="token punctuation">=</span><span class="token attr-value">\    org.flowable.spring.boot.actuate.info.FlowableInfoAutoConfiguration,\    org.flowable.spring.boot.EndpointAutoConfiguration,\    org.flowable.spring.boot.RestApiAutoConfiguration,\    org.flowable.spring.boot.app.AppEngineServicesAutoConfiguration,\    org.flowable.spring.boot.app.AppEngineAutoConfiguration,\    org.flowable.spring.boot.ProcessEngineServicesAutoConfiguration,\    org.flowable.spring.boot.ProcessEngineAutoConfiguration,\    org.flowable.spring.boot.FlowableJpaAutoConfiguration,\    org.flowable.spring.boot.form.FormEngineAutoConfiguration,\    org.flowable.spring.boot.form.FormEngineServicesAutoConfiguration,\    org.flowable.spring.boot.content.ContentEngineAutoConfiguration,\    org.flowable.spring.boot.content.ContentEngineServicesAutoConfiguration,\    org.flowable.spring.boot.dmn.DmnEngineAutoConfiguration,\    org.flowable.spring.boot.dmn.DmnEngineServicesAutoConfiguration,\    org.flowable.spring.boot.idm.IdmEngineAutoConfiguration,\    org.flowable.spring.boot.idm.IdmEngineServicesAutoConfiguration,\    org.flowable.spring.boot.cmmn.CmmnEngineAutoConfiguration,\    org.flowable.spring.boot.cmmn.CmmnEngineServicesAutoConfiguration,\    org.flowable.spring.boot.ldap.FlowableLdapAutoConfiguration,\    org.flowable.spring.boot.FlowableSecurityAutoConfiguration</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看起来比较多，不过大多数AutoConfiguration逻辑还是比较简单的。</p><h1 id="engine自动配置"><a href="#engine自动配置" class="headerlink" title="engine自动配置"></a>engine自动配置</h1><p>各engine的配置方式大同小异，以ProcessEngine为例，其涉及到的AutoConfiguration主要是</p><ul><li>ProcessEngineAutoConfiguration</li><li>ProcessEngineServicesAutoConfiguration</li></ul><h2 id="ProcessEngineAutoConfiguration"><a href="#ProcessEngineAutoConfiguration" class="headerlink" title="ProcessEngineAutoConfiguration"></a>ProcessEngineAutoConfiguration</h2><p>ProcessEngineAutoConfiguration类图</p><p><img src="/images/flowable/class_diagram_ProcessEngineAutoConfiguration.png" alt="ProcessEngineAutoConfiguration"></p><p>从红框部分可以看到，在ProcessEngineAutoConfiguration中配置了一个类型为<strong>SpringProcessEngineConfiguration</strong>的bean，其类图如下</p><p><img src="/images/flowable/class_diagram_SpringProcessEngineConfiguration.png" alt="SpringProcessEngineConfiguration"></p><p>可知，SpringProcessEngineConfiguration是ProcessEngineConfiguration的子类，而ProcessEngineConfiguration正是用于创建ProcessEngine的类。</p><p>不过这里只是注册了一个bean，并没有调用其buildProcessEngine()方法来创建ProcessEngine。ProcessEngine实例是在<a href="#ProcessEngineFactoryBean">ProcessEngineFactoryBean</a>中创建的。</p><h2 id="ProcessEngineServicesAutoConfiguration"><a href="#ProcessEngineServicesAutoConfiguration" class="headerlink" title="ProcessEngineServicesAutoConfiguration"></a>ProcessEngineServicesAutoConfiguration</h2><p>这个AutoConfiguration主要负责配置ProcessEngineFactoryBean及各个Service（RuntimeService, RepositoryService, TaskService等）。</p><p>各Service的配置比较简单，主要来看看ProcessEngineFactoryBean</p><h3 id="ProcessEngineFactoryBean"><a href="#ProcessEngineFactoryBean" class="headerlink" title="ProcessEngineFactoryBean"></a>ProcessEngineFactoryBean</h3><p>需要注意的是ProcessEngineFactoryBean是在内部类ProcessEngineServicesAutoConfiguration#StandaloneEngineConfiguration中注册的。</p><p>这是一个FactoryBean，我们知道Spring通过FactoryBean的getObject()方法来创建bean，来看看其代码</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ProcessEngineFactoryBean.java</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProcessEngineFactoryBean</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span><span class="token operator">&lt;</span>ProcessEngine<span class="token operator">></span><span class="token punctuation">,</span> DisposableBean<span class="token punctuation">,</span> ApplicationContextAware <span class="token punctuation">{</span>    <span class="token keyword">protected</span> ProcessEngineConfigurationImpl processEngineConfiguration<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> ProcessEngine <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 省略无关代码...</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>processEngine <span class="token operator">=</span> processEngineConfiguration<span class="token punctuation">.</span><span class="token function">buildProcessEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processEngine<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，ProcessEngineFactoryBean通过调用processEngineConfiguration.buildProcessEngine()创建了ProcessEngine的实例。</p><p>对于processEngineConfiguration这个对象的构建，可以参考<a href="#ProcessEngineAutoConfiguration">ProcessEngineAutoConfiguration</a></p><h1 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h1><p>flowable spring boot starter能够自动将classpath的相关目录（如processes, forms）下的资源自动部署。</p><p>不同的engine逻辑大同小异，以ProcessEngine为例，其核心在于SpringProcessEngineConfiguration这个类。</p><p>SpringProcessEngineConfiguration实现了spring的SmartLifecycle接口，相关代码如下</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// SpringProcessEngineConfiguration.java</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lifeCycleMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 遍历engines实例进行部署</span>            enginesBuild<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>name <span class="token operator">-</span><span class="token operator">></span> <span class="token function">autoDeployResources</span><span class="token punctuation">(</span>ProcessEngines<span class="token punctuation">.</span><span class="token function">getProcessEngine</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lifeCycleMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> running<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中start方法正是对process engines所需要的资源进行自动部署，会在spring应用完成初始化后进行回调。</p><p>来看看autoDeployResources方法</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// SpringProcessEngineConfiguration.java</span><span class="token keyword">protected</span> Resource<span class="token punctuation">[</span><span class="token punctuation">]</span> deploymentResources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">autoDeployResources</span><span class="token punctuation">(</span>ProcessEngine processEngine<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>deploymentResources <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> deploymentResources<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> AutoDeploymentStrategy strategy <span class="token operator">=</span> <span class="token function">getAutoDeploymentStrategy</span><span class="token punctuation">(</span>deploymentMode<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 选择部署策略</span>        strategy<span class="token punctuation">.</span><span class="token function">deployResources</span><span class="token punctuation">(</span>deploymentName<span class="token punctuation">,</span> deploymentResources<span class="token punctuation">,</span> processEngine<span class="token punctuation">.</span><span class="token function">getRepositoryService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>字段deploymentResources的值是关键，通过调试，发现该字段是在ProcessEngineAutoConfiguration中进行赋值的</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ProcessEngineAutoConfiguration</span><span class="token annotation punctuation">@Bean</span><span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token keyword">public</span> SpringProcessEngineConfiguration <span class="token function">springProcessEngineConfiguration</span><span class="token punctuation">(</span>DataSource dataSource<span class="token punctuation">,</span> PlatformTransactionManager platformTransactionManager<span class="token punctuation">,</span>        <span class="token annotation punctuation">@Process</span> ObjectProvider<span class="token operator">&lt;</span>IdGenerator<span class="token operator">></span> processIdGenerator<span class="token punctuation">,</span>        ObjectProvider<span class="token operator">&lt;</span>IdGenerator<span class="token operator">></span> globalIdGenerator<span class="token punctuation">,</span>        <span class="token annotation punctuation">@ProcessAsync</span> ObjectProvider<span class="token operator">&lt;</span>AsyncExecutor<span class="token operator">></span> asyncExecutorProvider<span class="token punctuation">,</span>        <span class="token annotation punctuation">@ProcessAsyncHistory</span> ObjectProvider<span class="token operator">&lt;</span>AsyncExecutor<span class="token operator">></span> asyncHistoryExecutorProvider<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>    SpringProcessEngineConfiguration conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringProcessEngineConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 根据配置的规则找到相关的资源</span>    List<span class="token operator">&lt;</span>Resource<span class="token operator">></span> resources <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">discoverDeploymentResources</span><span class="token punctuation">(</span>        flowableProperties<span class="token punctuation">.</span><span class="token function">getProcessDefinitionLocationPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        flowableProperties<span class="token punctuation">.</span><span class="token function">getProcessDefinitionLocationSuffixes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        flowableProperties<span class="token punctuation">.</span><span class="token function">isCheckProcessDefinitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>resources <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>resources<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        conf<span class="token punctuation">.</span><span class="token function">setDeploymentResources</span><span class="token punctuation">(</span>resources<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">setDeploymentName</span><span class="token punctuation">(</span>flowableProperties<span class="token punctuation">.</span><span class="token function">getDeploymentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...省略无关代码</span>    <span class="token keyword">return</span> conf<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="TODO-LIST"><a href="#TODO-LIST" class="headerlink" title="TODO LIST"></a>TODO LIST</h1><ul><li style="list-style: none"><input type="checkbox"> List&lt;EngineConfigurationConfigurer></li></ul>]]></content>
      
      <categories>
          
          <category> source </category>
          
          <category> flowable </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>zuul源码解析 —— 动态加载Filter（未完成）</title>
      <link href="/source/zuul/filter/dynamic_load.html"/>
      <url>/source/zuul/filter/dynamic_load.html</url>
      <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>zuul支持用两种语言编写的过滤器，分别是Groovy和Java。不过只有Groovy编写的过滤器才支持动态加载。</p><p>所谓动态加载，即是可以在应用的运行时对filter进行CRUD的操作，以达到动态调整zuul行为的目的。</p><p>以下我们看看zuul是如何实现这一点的。</p><h2 id="FilterLoader"><a href="#FilterLoader" class="headerlink" title="FilterLoader"></a>FilterLoader</h2><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// FilterLoader.java</span>    <span class="token comment" spellcheck="true">/**     * 获取所有指定类型的filter并排序，通过ZuulFilter.filterOrder()方法     * Returns a list of filters by the filterType specified     */</span>    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>ZuulFilter<span class="token operator">></span> <span class="token function">getFiltersByType</span><span class="token punctuation">(</span>String filterType<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 尝试从缓存中获取，如果存在缓存，则直接返回</span>        List<span class="token operator">&lt;</span>ZuulFilter<span class="token operator">></span> list <span class="token operator">=</span> hashFiltersByType<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filterType<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> list<span class="token punctuation">;</span>        list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>ZuulFilter<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 从registry获取所有filter，从中找出需要的filter，最终进行排序</span>        Collection<span class="token operator">&lt;</span>ZuulFilter<span class="token operator">></span> filters <span class="token operator">=</span> filterRegistry<span class="token punctuation">.</span><span class="token function">getAllFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator<span class="token operator">&lt;</span>ZuulFilter<span class="token operator">></span> iterator <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>            ZuulFilter filter <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span><span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>filterType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// sort by priority</span>        <span class="token comment" spellcheck="true">// 将结果缓存起来</span>        hashFiltersByType<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>filterType<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> list<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从上面代码可以看到，<code>getFiltersByType()</code>依赖于对象filterRegistry，zuul正是通过对该registry的CRUD实现动态加载filter的功能。</p><p>filterRegistry是FilterRegistry的一个唯一实例（单例模式）。FilterRegistry的代码很简单，就是简单地维护了一个用于存放filter的ConcurrentHashMap而以。关键需要找出zuul是如何维护这份registry的。</p><h2 id="FilterScriptManagerServlet"><a href="#FilterScriptManagerServlet" class="headerlink" title="FilterScriptManagerServlet"></a>FilterScriptManagerServlet</h2><p>需要在运行时维护registry，必然需要有一个入口。这个入口就是<code>FilterScriptManagerServlet</code>，这是一个HttpServlet，提供了以下HTTP资源：</p><table><thead><tr><th>路径</th><th>请求方式</th><th>Servlet对应的处理方法</th><th>描述</th></tr></thead><tbody><tr><td>LIST</td><td>GET</td><td>handleListAction</td><td>获取filter脚本</td></tr><tr><td>DOWNLOAD</td><td>GET</td><td>handleDownloadAction</td><td>下载脚本</td></tr><tr><td>UPLOAD</td><td>PUT/POST</td><td>handleUploadAction</td><td>上传脚本</td></tr><tr><td>ACTIVATE</td><td>PUT/POST</td><td>handleActivateAction</td><td>启用脚本</td></tr><tr><td>CANARY</td><td>PUT/POST</td><td>handleCanaryAction</td><td>TODO::还不知道干啥用的</td></tr><tr><td>DEACTIVATE</td><td>PUT/POST</td><td>handledeActivateAction</td><td>禁用脚本</td></tr></tbody></table>]]></content>
      
      <categories>
          
          <category> source </category>
          
          <category> zuul </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>zuul源码解析 —— Post类型过滤器</title>
      <link href="/source/zuul/filters/post.html"/>
      <url>/source/zuul/filters/post.html</url>
      <content type="html"><![CDATA[<h2 id="Post类型过滤器"><a href="#Post类型过滤器" class="headerlink" title="Post类型过滤器"></a>Post类型过滤器</h2><p>Post类型过滤器执行顺序为：<a href="#Postfilter">Postfilter</a>(10) -&gt; <a href="#RequestEventInfoCollectorFilter">RequestEventInfoCollectorFilter</a>(99) -&gt; <a href="#sendResponse">sendResponse</a>(1000) -&gt; <a href="#Stats">Stats</a>(2000)</p><h3 id="Postfilter"><a href="#Postfilter" class="headerlink" title="Postfilter"></a>Postfilter</h3><p>后置处理过滤器，主要负责对响应内容进行修饰（如添加响应头）。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// PostDecoration.groovy</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 判断请求是否是从zuul路由到自身的</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>NFRequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>zuulToZuul<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//request was routed to a zuul server, so don't send response headers</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span>Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 为响应添加一些header</span>    <span class="token function">addStandardResponseHeaders</span><span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">addStandardResponseHeaders</span><span class="token punctuation">(</span>HttpServletRequest req<span class="token punctuation">,</span> HttpServletResponse res<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">println</span><span class="token punctuation">(</span>originatingURL<span class="token punctuation">)</span>    String origin <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>ORIGIN<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// 没用到</span>    RequestContext context <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    List<span class="token operator">&lt;</span>Pair<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">>></span> headers <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getZuulResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token punctuation">(</span>X_ZUUL<span class="token punctuation">,</span> <span class="token string">"zuul"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// X-Zuul</span>    headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token punctuation">(</span>X_ZUUL_INSTANCE<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"EC2_INSTANCE_ID"</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">:</span> <span class="token string">"unknown"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// X-Zuul-instance</span>    headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token punctuation">(</span>CONNECTION<span class="token punctuation">,</span> KEEP_ALIVE<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// Connection</span>    headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token punctuation">(</span>X_ZUUL_FILTER_EXECUTION_STATUS<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getFilterExecutionSummary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// X-Zuul-Filter-Executions</span>    headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token punctuation">(</span>X_ORIGINATING_URL<span class="token punctuation">,</span> originatingURL<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// X-Originating-URL</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"ErrorHandled"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>responseStatusCode <span class="token operator">>=</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token punctuation">(</span>X_NETFLIX_ERROR_CAUSE<span class="token punctuation">,</span> <span class="token string">"Error from Origin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// X-Netflix-Error-Cause</span>        ErrorStatsManager<span class="token punctuation">.</span>manager<span class="token punctuation">.</span><span class="token function">putStats</span><span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>route<span class="token punctuation">,</span> <span class="token string">"Error_from_Origin_Server"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="RequestEventInfoCollectorFilter"><a href="#RequestEventInfoCollectorFilter" class="headerlink" title="RequestEventInfoCollectorFilter"></a>RequestEventInfoCollectorFilter</h3><p>这个过滤器负责收集要发送到ESI, EventBus, Turbine等的数据，例如此次请求的数据和当前应用实例的数据。</p><p>TODO:: 虽然zuul收集了这些数据，但是并没有找到在哪里使用… mark一下</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// RequestEventInfoCollector.groovy</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span>Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    NFRequestContext ctx <span class="token operator">=</span> NFRequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> event <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getEventProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 往eventProperties中写入与此次请求有关的数据</span>        <span class="token function">captureRequestData</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 往eventProperties中写入与当前实例有关的数据</span>        <span class="token function">captureInstanceData</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>capture data这两个方法比较啰嗦，不过逻辑并不复杂，就是收集各种数据并写入map中</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// RequestEventInfoCollector.groovy</span><span class="token keyword">void</span> <span class="token function">captureRequestData</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> event<span class="token punctuation">,</span> HttpServletRequest req<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 写入请求基本信息</span>        <span class="token comment" spellcheck="true">// basic request properties</span>        event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getPathInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"query"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"currentTime"</span><span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 写入请求头</span>        <span class="token comment" spellcheck="true">// request headers</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> Enumeration names <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeaderNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> names<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> String name <span class="token operator">=</span> names<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> StringBuilder valBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">boolean</span> firstValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> Enumeration vals <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> vals<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// only prepends separator for non-first header values</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>firstValue<span class="token punctuation">)</span> firstValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token keyword">else</span> <span class="token punctuation">{</span>                    valBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>VALUE_SEPARATOR<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                valBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>vals<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"request.header."</span> <span class="token operator">+</span> name<span class="token punctuation">,</span> valBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 写入请求参数</span>        <span class="token comment" spellcheck="true">// request params</span>        <span class="token keyword">final</span> Map params <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> Object key <span class="token operator">:</span> params<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> String keyString <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> Object val <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>            String valString<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> valArray <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> val<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>valArray<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>                    valString <span class="token operator">=</span> valArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">else</span>                    valString <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                valString <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"param."</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> valString<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// some special params get promoted to top-level fields</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>keyString<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"esn"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"esn"</span><span class="token punctuation">,</span> valString<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 写入响应头</span>        <span class="token comment" spellcheck="true">// response headers</span>        NFRequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getZuulResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>each <span class="token punctuation">{</span> Pair<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> it <span class="token operator">-</span><span class="token operator">></span>            event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"response.header."</span> <span class="token operator">+</span> it<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">captureInstanceData</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> String stack <span class="token operator">=</span> ConfigurationManager<span class="token punctuation">.</span><span class="token function">getDeploymentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeploymentStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>stack <span class="token operator">!=</span> null<span class="token punctuation">)</span> event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"stack"</span><span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// TODO: add CLUSTER, ASG, etc.</span>        <span class="token comment" spellcheck="true">// 获取此实例（zuul）的信息</span>        <span class="token keyword">final</span> InstanceInfo instanceInfo <span class="token operator">=</span> ApplicationInfoManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 写入实例信息，id和metadata等</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"instance.id"</span><span class="token punctuation">,</span> instanceInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> e <span class="token operator">:</span> instanceInfo<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"instance."</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// AWS相关，跳过</span>        <span class="token comment" spellcheck="true">// caches value after first call.  multiple threads could get here simultaneously, but I think that is fine</span>        <span class="token keyword">final</span> AmazonInfo amazonInfo <span class="token operator">=</span> AmazonInfoHolder<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> e <span class="token operator">:</span> amazonInfo<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            event<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"amazon."</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="sendResponse"><a href="#sendResponse" class="headerlink" title="sendResponse"></a>sendResponse</h3><p>sendResponse是比较重要的一个过滤器，负责将响应写回请求来源。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// sendResponse.groovy</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token operator">!</span>RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">getZuulResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>            RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">getResponseDataStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">||</span>            RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span>responseBody <span class="token operator">!=</span> null<span class="token punctuation">}</span>Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 添加一些响应头并收集响应debug信息到上下文</span>    <span class="token function">addResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 写响应流</span>    <span class="token function">writeResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">writeResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    RequestContext context <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span>currentContext    <span class="token comment" spellcheck="true">// there is no body to send</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span><span class="token function">getResponseDataStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    HttpServletResponse servletResponse <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    servletResponse<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span>    OutputStream outStream <span class="token operator">=</span> servletResponse<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    InputStream is <span class="token operator">=</span> null    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果上下文中设置了responseBody，则覆盖掉原来的输出</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span>responseBody <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            String body <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span>responseBody            <span class="token function">writeResponse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>Charset<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> outStream<span class="token punctuation">)</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 判断请求是否能接收gzip压缩</span>        <span class="token keyword">boolean</span> isGzipRequested <span class="token operator">=</span> <span class="token boolean">false</span>        <span class="token keyword">final</span> String requestEncoding <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>ZuulHeaders<span class="token punctuation">.</span>ACCEPT_ENCODING<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestEncoding <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> requestEncoding<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"gzip"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            isGzipRequested <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        is <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResponseDataStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        InputStream inputStream <span class="token operator">=</span> is        <span class="token keyword">if</span> <span class="token punctuation">(</span>is <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">sendZuulResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// if origin response is gzipped, and client has not requested gzip, decompress stream</span>                <span class="token comment" spellcheck="true">// before sending to client</span>                <span class="token comment" spellcheck="true">// else, stream gzip directly to client</span>                <span class="token comment" spellcheck="true">// 如果原始响应是gzip压缩的，但请求来源并不接受gzip，就解压后再返回，否则直接返回gzip响应</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getResponseGZipped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isGzipRequested<span class="token punctuation">)</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GZIPInputStream</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>zip<span class="token punctuation">.</span>ZipException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"gzip expected but not received assuming unencoded response"</span> <span class="token operator">+</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        inputStream <span class="token operator">=</span> is                    <span class="token punctuation">}</span>                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getResponseGZipped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> isGzipRequested<span class="token punctuation">)</span>                    servletResponse<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>ZuulHeaders<span class="token punctuation">.</span>CONTENT_ENCODING<span class="token punctuation">,</span> <span class="token string">"gzip"</span><span class="token punctuation">)</span>                <span class="token function">writeResponse</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outStream<span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            is<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            outStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            outStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 其它方法比较简单，省略了...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Stats"><a href="#Stats" class="headerlink" title="Stats"></a>Stats</h3><p>负责收集统计数据，以及将filter执行过程中收集到的debug信息输出到控制台。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Override</span>Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> status <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponseStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    StatsManager sm <span class="token operator">=</span> StatsManager<span class="token punctuation">.</span>manager    <span class="token comment" spellcheck="true">// 收集统计数据</span>    sm<span class="token punctuation">.</span><span class="token function">collectRequestStats</span><span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    sm<span class="token punctuation">.</span><span class="token function">collectRouteStats</span><span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>route<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 打印debug信息</span>    <span class="token function">dumpRoutingDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">dumpRequestDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      <categories>
          
          <category> source </category>
          
          <category> zuul </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>zuul源码解析 —— Route类型过滤器</title>
      <link href="/source/zuul/filters/route.html"/>
      <url>/source/zuul/filters/route.html</url>
      <content type="html"><![CDATA[<h2 id="Route类型过滤器"><a href="#Route类型过滤器" class="headerlink" title="Route类型过滤器"></a>Route类型过滤器</h2><p>Route类型的过滤器在zuul中负责对请求进行转发，zuul作为网关的最核心的功能就体现在route类型过滤器中。Netflix提供了两个route类型的过滤器：ZuulHostRequest和ZuulNFRequest，但任意请求只会满足其中一个过滤器的执行条件。</p><p>Route类型过滤器执行顺序为：ZuulNFRequest(10) -&gt; ZuulHostRequest(100)</p><h3 id="ZuulHostRequest"><a href="#ZuulHostRequest" class="headerlink" title="ZuulHostRequest"></a>ZuulHostRequest</h3><p>ZuulHostRequest简单地根据host来转发请求，host的值根据上下文变量routeHost取得。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ZuulHostRequest.groovy</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 如果routeHost不为空，则说明此次请求是转发到指定host，由此过滤器进行处理，否则由ZuulNFRequest进行处理</span>    <span class="token keyword">return</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">getRouteHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">sendZuulResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    HttpServletRequest request <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 构建请求headers，会包括原请求请求头和zuul添加的请求头</span>    Header<span class="token punctuation">[</span><span class="token punctuation">]</span> headers <span class="token operator">=</span> <span class="token function">buildZuulRequestHeaders</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 获取HTTP动词，即GET/POST之类</span>    String verb <span class="token operator">=</span> <span class="token function">getVerb</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    InputStream requestEntity <span class="token operator">=</span> <span class="token function">getRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>    HttpClient httpclient <span class="token operator">=</span> CLIENT<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    String uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span>requestURI <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果在之前的过滤器中为上下文添加了requestURI，则覆盖掉原uri</span>        uri <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span>requestURI    <span class="token punctuation">}</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 转发请求并将响应保存到上下文</span>        HttpResponse response <span class="token operator">=</span> <span class="token function">forward</span><span class="token punctuation">(</span>httpclient<span class="token punctuation">,</span> verb<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> request<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> requestEntity<span class="token punctuation">)</span>        <span class="token function">setResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> null<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ZuulHostRequest的run方法会根据原请求和上下文构建一个新的HTTP请求，然后进行转发，接下来看看forward方法</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> AtomicReference<span class="token operator">&lt;</span>HttpClient<span class="token operator">></span> CLIENT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token operator">&lt;</span>HttpClient<span class="token operator">></span><span class="token punctuation">(</span><span class="token function">newClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> HttpResponse <span class="token function">forward</span><span class="token punctuation">(</span>HttpClient httpclient<span class="token punctuation">,</span> String verb<span class="token punctuation">,</span> String uri<span class="token punctuation">,</span> HttpServletRequest request<span class="token punctuation">,</span> Header<span class="token punctuation">[</span><span class="token punctuation">]</span> headers<span class="token punctuation">,</span> InputStream requestEntity<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 如果开启了debugRequest的话，这里会返回一个wrap过的requestEntity(debugRequestEntity)用于debug</span>    requestEntity <span class="token operator">=</span> <span class="token function">debug</span><span class="token punctuation">(</span>httpclient<span class="token punctuation">,</span> verb<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> request<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> requestEntity<span class="token punctuation">)</span>    org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpHost httpHost    httpHost <span class="token operator">=</span> <span class="token function">getHttpHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpRequest httpRequest<span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>verb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> <span class="token string">'POST'</span><span class="token operator">:</span>            httpRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>uri <span class="token operator">+</span> <span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            InputStreamEntity entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamEntity</span><span class="token punctuation">(</span>requestEntity<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getContentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            httpRequest<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>            <span class="token keyword">break</span>        <span class="token keyword">case</span> <span class="token string">'PUT'</span><span class="token operator">:</span>            httpRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPut</span><span class="token punctuation">(</span>uri <span class="token operator">+</span> <span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            InputStreamEntity entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamEntity</span><span class="token punctuation">(</span>requestEntity<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getContentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            httpRequest<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token operator">:</span>            httpRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicHttpRequest</span><span class="token punctuation">(</span>verb<span class="token punctuation">,</span> uri <span class="token operator">+</span> <span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        httpRequest<span class="token punctuation">.</span><span class="token function">setHeaders</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span>        HttpResponse zuulResponse <span class="token operator">=</span> <span class="token function">executeHttpRequest</span><span class="token punctuation">(</span>httpclient<span class="token punctuation">,</span> httpHost<span class="token punctuation">,</span> httpRequest<span class="token punctuation">)</span>        <span class="token keyword">return</span> zuulResponse    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// When HttpClient instance is no longer needed,</span>        <span class="token comment" spellcheck="true">// shut down the connection manager to ensure</span>        <span class="token comment" spellcheck="true">// immediate deallocation of all system resources</span>        <span class="token comment" spellcheck="true">// 这行被注释掉了，可能因为之前用的client不是静态变量，现在换成静态变量后就不需要在这里释放连接了</span><span class="token comment" spellcheck="true">//            httpclient.getConnectionManager().shutdown();</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>HttpResponse <span class="token function">executeHttpRequest</span><span class="token punctuation">(</span>HttpClient httpclient<span class="token punctuation">,</span> HttpHost httpHost<span class="token punctuation">,</span> HttpRequest httpRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 封装成hystrix command执行，有关hystrix的内容这里不做讨论</span>    HostCommand command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HostCommand</span><span class="token punctuation">(</span>httpclient<span class="token punctuation">,</span> httpHost<span class="token punctuation">,</span> httpRequest<span class="token punctuation">)</span>    command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ZuulNFRequest"><a href="#ZuulNFRequest" class="headerlink" title="ZuulNFRequest"></a>ZuulNFRequest</h3><p>ZuulNFRequest可以将请求路由到注册到eureka server的服务中。它使用Ribbon客户端，可以将请求就当前可用实例进行负载均衡。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ZuulNFRequest.groovy</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> NFRequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">getRouteHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">sendZuulResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    NFRequestContext context <span class="token operator">=</span> NFRequestContext<span class="token punctuation">.</span>currentContext    HttpServletRequest request <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 构建请求headers，会包括原请求请求头和zuul添加的请求头</span>    MultivaluedMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> headers <span class="token operator">=</span> <span class="token function">buildZuulRequestHeaders</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 构建请求参数</span>    MultivaluedMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> params <span class="token operator">=</span> <span class="token function">buildZuulRequestQueryParams</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>    Verb verb <span class="token operator">=</span> <span class="token function">getVerb</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    Object requestEntity <span class="token operator">=</span> <span class="token function">getRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 通过routeVIP获取到相应的ribbon客户端</span>    IClient restClient <span class="token operator">=</span> ClientFactory<span class="token punctuation">.</span><span class="token function">getNamedClient</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getRouteVIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    String uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>requestURI <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        uri <span class="token operator">=</span> context<span class="token punctuation">.</span>requestURI    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//remove double slashes</span>    uri <span class="token operator">=</span> uri<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"//"</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span>    HttpResponse response <span class="token operator">=</span> <span class="token function">forward</span><span class="token punctuation">(</span>restClient<span class="token punctuation">,</span> verb<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> params<span class="token punctuation">,</span> requestEntity<span class="token punctuation">)</span>    <span class="token function">setResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>    <span class="token keyword">return</span> response<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>逻辑基本上与ZuulHostRequest一致，唯一不同的是使用的HTTP客户端不一样。ZuulNFRequest使用的客户端是从ClientFactory中获取的命名客户端(named client)，每个命名客户端会有一个相应的命名配置(named config)，这意味者每个客户端都可以有不同的配置。来看看相关代码</p><p>tip: 这个ClientFactory其实是属于ribbon的类，如果对ribbon有了解可以选择跳过下面的内容不看。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ClientFactory.java</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> IClient <span class="token function">getNamedClient</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">IClientConfig</span><span class="token operator">></span> configClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>simpleClientMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> simpleClientMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// client不存在，尝试创建一个</span>        <span class="token keyword">return</span> <span class="token function">createNamedClient</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClientException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Unable to create client"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> IClient <span class="token function">createNamedClient</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">IClientConfig</span><span class="token operator">></span> configClass<span class="token punctuation">)</span> <span class="token keyword">throws</span> ClientException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 获取命名配置</span>    IClientConfig config <span class="token operator">=</span> <span class="token function">getNamedConfig</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">registerClientFromProperties</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要注意到的是在createNamedClient()中，传入的client config是一个类型，通过getNamedConfig(name, configClass)获取到当前客户端对应的命名配置。</p><h4 id="命名配置"><a href="#命名配置" class="headerlink" title="命名配置"></a>命名配置</h4><p>所谓命名配置即是为每份配置起一个名字，然后在运行时就可以根据不同的名字来获取不同的配置，例如我们可以这样配置</p><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># zuul.properties</span><span class="token attr-name">origin.zuul.client.DeploymentContextBasedVipAddresses</span><span class="token punctuation">=</span><span class="token attr-value">ORIGIN</span><span class="token attr-name">origin.zuul.client.Port</span><span class="token punctuation">=</span><span class="token attr-value">8080</span><span class="token attr-name">foo.zuul.client.DeploymentContextBasedVipAddresses</span><span class="token punctuation">=</span><span class="token attr-value">FOO</span><span class="token attr-name">foo.zuul.client.Port</span><span class="token punctuation">=</span><span class="token attr-value">8081</span><span class="token attr-name">bar.zuul.client.DeploymentContextBasedVipAddresses</span><span class="token punctuation">=</span><span class="token attr-value">BAR</span><span class="token attr-name">bar.zuul.client.Port</span><span class="token punctuation">=</span><span class="token attr-value">8082</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后构造出来的origin, foo, bar这三个客户端对应的配置分别是vip: ORIGIN, FOO, BAR; port: 8080, 8081, 8082</p><p>获取命名配置的代码如下</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ClientFactory.java</span><span class="token keyword">public</span> <span class="token keyword">static</span> IClientConfig <span class="token function">getNamedConfig</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">IClientConfig</span><span class="token operator">></span> clientConfigClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>    IClientConfig config <span class="token operator">=</span> namedConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> config<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            config <span class="token operator">=</span> <span class="token punctuation">(</span>IClientConfig<span class="token punctuation">)</span> clientConfigClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 以名称前缀加载相应的配置</span>            config<span class="token punctuation">.</span><span class="token function">loadProperties</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unable to create client config instance"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        config<span class="token punctuation">.</span><span class="token function">loadProperties</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        IClientConfig old <span class="token operator">=</span> namedConfig<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            config <span class="token operator">=</span> old<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> config<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      <categories>
          
          <category> source </category>
          
          <category> zuul </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>zuul源码解析 —— Pre和其它类型的过滤器</title>
      <link href="/source/zuul/filters/pre.html"/>
      <url>/source/zuul/filters/pre.html</url>
      <content type="html"><![CDATA[<h2 id="Pre类型"><a href="#Pre类型" class="headerlink" title="Pre类型"></a>Pre类型</h2><p>Pre类型的过滤器执行顺序为：DebugFilter(1) -&gt; Routing(1) -&gt; PreDecoration(20) -&gt; WeightedLoadBalancer(30) -&gt; DebugRequest(10000)</p><h3 id="DebugFilter"><a href="#DebugFilter" class="headerlink" title="DebugFilter"></a>DebugFilter</h3><p>判断是否为此次请求开启debug的一个过滤器。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Debug.groovy</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 配置中是否开启debug</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"true"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>debugParameter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> routingDebug<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 设置当前请求的上下文的debug标识为true，作为之后执行filter时是否记录debug信息的依据</span>    RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDebugRequest</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>    RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDebugRouting</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Routing"><a href="#Routing" class="headerlink" title="Routing"></a>Routing</h3><p>Routing过滤器判断是将请求路由到静态资源还是其它服务。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Routing.groovy</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span>Object <span class="token function">staticRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 路由到静态资源</span>    FilterProcessor<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">runFilters</span><span class="token punctuation">(</span><span class="token string">"healthcheck"</span><span class="token punctuation">)</span>    FilterProcessor<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">runFilters</span><span class="token punctuation">(</span><span class="token string">"static"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">staticRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//runs the static Zuul</span>    <span class="token comment" spellcheck="true">// TODO:: 这里routeVIP的值是固定的（origin），后面也没有找到修改该值的地方，导致zuul只能路由到某个单一的服务，暂时不知道原因，先mark一下</span>    <span class="token comment" spellcheck="true">// 目标Eureka VIP</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span>NFRequestContext<span class="token punctuation">)</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">)</span><span class="token punctuation">.</span>routeVIP <span class="token operator">=</span> defaultClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    String host <span class="token operator">=</span> defaultHost<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>NFRequestContext<span class="token punctuation">)</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">)</span><span class="token punctuation">.</span>routeVIP <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>NFRequestContext<span class="token punctuation">)</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">)</span><span class="token punctuation">.</span>routeVIP <span class="token operator">=</span> ZuulApplicationInfo<span class="token punctuation">.</span>applicationName    <span class="token keyword">if</span> <span class="token punctuation">(</span>host <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> URL targetUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span>        RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">setRouteHost</span><span class="token punctuation">(</span>targetUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">(</span><span class="token punctuation">(</span>NFRequestContext<span class="token punctuation">)</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">)</span><span class="token punctuation">.</span>routeVIP <span class="token operator">=</span> null    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// host与routeVIP不能同时为null</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>host <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span>routeVIP <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ZuulException</span><span class="token punctuation">(</span><span class="token string">"default VIP or host not defined. Define: zuul.niws.defaultClient or zuul.default.host"</span><span class="token punctuation">,</span> <span class="token number">501</span><span class="token punctuation">,</span> <span class="token string">"zuul.niws.defaultClient or zuul.default.host not defined"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    String uri <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 如果在之前的filter当中给上下文的requestURI赋值了，则覆盖原uri的值</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span>requestURI <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        uri <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span>requestURI    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>uri <span class="token operator">==</span> null<span class="token punctuation">)</span> uri <span class="token operator">=</span> <span class="token string">"/"</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        uri <span class="token operator">=</span> uri <span class="token operator">-</span> <span class="token string">"/"</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 截取路径的第一段为route</span>    <span class="token comment" spellcheck="true">// TODO:: 这个route有什么用，也暂时没发现</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span>NFRequestContext<span class="token punctuation">)</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">)</span><span class="token punctuation">.</span>route <span class="token operator">=</span> uri<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> uri<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="PreDecoration"><a href="#PreDecoration" class="headerlink" title="PreDecoration"></a>PreDecoration</h3><p>预处理过滤器，负责对请求做一些预处理操作，如添加请求头。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// PreDecoration.groovy</span><span class="token annotation punctuation">@Override</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Override</span>Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// routeHost通过请求的参数url指定</span>            <span class="token comment" spellcheck="true">// 如果routeHost有值，则在route阶段会由ZuulHostRequest进行处理</span>            RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>routeHost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 开启GZip</span>            RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">setResponseGZipped</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MalformedURLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// url格式错误，返回400</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ZuulException</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"Malformed URL"</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">"MALFORMED_URL"</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">setOriginRequestHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> null<span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">setOriginRequestHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    RequestContext context <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span>currentContext    context<span class="token punctuation">.</span><span class="token function">addZuulRequestHeader</span><span class="token punctuation">(</span><span class="token string">"X-Netflix.request.toplevel.uuid"</span><span class="token punctuation">,</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 添加被代理者的ip地址到XFF</span>    context<span class="token punctuation">.</span><span class="token function">addZuulRequestHeader</span><span class="token punctuation">(</span>X_FORWARDED_FOR<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>remoteAddr<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 设置Host头</span>    context<span class="token punctuation">.</span><span class="token function">addZuulRequestHeader</span><span class="token punctuation">(</span>X_NETFLIX_CLIENT_HOST<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>HOST<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>X_FORWARDED_PROTO<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        context<span class="token punctuation">.</span><span class="token function">addZuulRequestHeader</span><span class="token punctuation">(</span>X_NETFLIX_CLIENT_PROTO<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>X_FORWARDED_PROTO<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="WeightedLoadBalance"><a href="#WeightedLoadBalance" class="headerlink" title="WeightedLoadBalance"></a>WeightedLoadBalance</h3><p>TODO:: 加权负载均衡器，似乎与金丝雀发布（灰度发布）有关，暂不深入了解。</p><h3 id="DebugRequest"><a href="#DebugRequest" class="headerlink" title="DebugRequest"></a>DebugRequest</h3><p>负责添加Request的debug信息的过滤器</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// DebugRequest.groovy</span><span class="token annotation punctuation">@Override</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Debug<span class="token punctuation">.</span><span class="token function">debugRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Override</span>Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 获取原始请求</span>    HttpServletRequest req <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span>request as HttpServletRequest    <span class="token comment" spellcheck="true">// 收集客户端ip信息</span>    Debug<span class="token punctuation">.</span><span class="token function">addRequestDebug</span><span class="token punctuation">(</span><span class="token string">"REQUEST:: "</span> <span class="token operator">+</span> req<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> req<span class="token punctuation">.</span><span class="token function">getRemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> req<span class="token punctuation">.</span><span class="token function">getRemotePort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 收集HTTP请求行信息</span>    Debug<span class="token punctuation">.</span><span class="token function">addRequestDebug</span><span class="token punctuation">(</span><span class="token string">"REQUEST:: > "</span> <span class="token operator">+</span> req<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> req<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> req<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 收集原请求的请求头信息</span>    Iterator headerIt <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeaderNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>headerIt<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        String name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> headerIt<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        String value <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>        Debug<span class="token punctuation">.</span><span class="token function">addRequestDebug</span><span class="token punctuation">(</span><span class="token string">"REQUEST:: > "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> value<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 收集原请求的请求体信息</span>    <span class="token keyword">final</span> RequestContext ctx <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span><span class="token function">isChunkedRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        InputStream inp <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        String body <span class="token operator">=</span> null        <span class="token keyword">if</span> <span class="token punctuation">(</span>inp <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            body <span class="token operator">=</span> inp<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            Debug<span class="token punctuation">.</span><span class="token function">addRequestDebug</span><span class="token punctuation">(</span><span class="token string">"REQUEST:: > "</span> <span class="token operator">+</span> body<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>打印出来的调试信息类似下面这样：</p><pre class="line-numbers language-text"><code class="language-text">REQUEST_DEBUG::REQUEST:: http 0:0:0:0:0:0:0:1:54075REQUEST_DEBUG::REQUEST:: > GET /auth-center/foo/bar HTTP/1.1REQUEST_DEBUG::REQUEST:: > Host:localhost:8080REQUEST_DEBUG::REQUEST:: > Connection:keep-aliveREQUEST_DEBUG::REQUEST:: > Cache-Control:max-age=0REQUEST_DEBUG::REQUEST:: > Upgrade-Insecure-Requests:1REQUEST_DEBUG::REQUEST:: > User-Agent:Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Safari/537.36REQUEST_DEBUG::REQUEST:: > Accept:text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8REQUEST_DEBUG::REQUEST:: > Accept-Encoding:gzip, deflate, brREQUEST_DEBUG::REQUEST:: > Accept-Language:zh-CN,zh;q=0.9,zh-TW;q=0.8REQUEST_DEBUG::REQUEST:: > Cookie:Idea-9d03e8f=36659dd1-27e5-4e9b-8824-19bf2de30b9e; _ga=GA1.1.79701639.1521035841; wcsid=u5MHraIxIjs3Na0G3m39N0Hab53odbCD; hblid=5HLUbXnG2OuboFyp3m39N0HbjAa3Cd5a; _oklv=1542679881769%2Cu5MHraIxIjs3Na0G3m39N0Hab53odbCD; _okdetect=%7B%22token%22%3A%2215426798825920%22%2C%22proto%22%3A%22http%3A%22%2C%22host%22%3A%22localhost%3A4040%22%7D; olfsk=olfsk020058268955480463; _okbk=cd4%3Dtrue%2Cvi5%3D0%2Cvi4%3D1542679883339%2Cvi3%3Dactive%2Cvi2%3Dfalse%2Cvi1%3Dfalse%2Ccd8%3Dchat%2Ccd6%3D0%2Ccd5%3Daway%2Ccd3%3Dfalse%2Ccd2%3D0%2Ccd1%3D0%2C; _ok=1700-237-10-3483; _gauges_unique_month=1; _gauges_unique_year=1; _gauges_unique=1; freeform=3213REQUEST_DEBUG::REQUEST:: > <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="其它类型"><a href="#其它类型" class="headerlink" title="其它类型"></a>其它类型</h2><h3 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h3><p>好像是一个没用的filter…感觉是还未完成？</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Options.groovy</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    String method <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 处理OPTIONS方法的HTTP请求</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"options"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Override</span>String <span class="token function">uri</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"any path here"</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Override</span>String <span class="token function">responseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 啥也不返回</span>    <span class="token keyword">return</span> <span class="token string">""</span> <span class="token comment" spellcheck="true">// empty response</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Healthcheck"><a href="#Healthcheck" class="headerlink" title="Healthcheck"></a>Healthcheck</h3><p>Healthcheck过滤器提供了一个静态资源/healthcheck，方便检测zuul应用是否正常运行。但是功能好像过于弱鸡了… - -</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Healthcheck.groovy</span><span class="token annotation punctuation">@Override</span>String <span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"healthcheck"</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Override</span>String <span class="token function">uri</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"/healthcheck"</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Override</span>String <span class="token function">responseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 只返回了一个ok...简单粗暴...</span>    RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">'application/xml'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">"&lt;health>ok&lt;/health>"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ErrorResponse"><a href="#ErrorResponse" class="headerlink" title="ErrorResponse"></a>ErrorResponse</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ErrorResponse.groovy</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 根据标识判断错误是否已被处理</span>    <span class="token keyword">return</span> RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"ErrorHandled"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">}</span>Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    RequestContext context <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span>currentContext    Throwable ex <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getThrowable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">throw</span> ex    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ZuulException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        String cause <span class="token operator">=</span> e<span class="token punctuation">.</span>errorCause        <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token operator">==</span> null<span class="token punctuation">)</span> cause <span class="token operator">=</span> <span class="token string">"UNKNOWN"</span>        <span class="token comment" spellcheck="true">// 添加错误原因到请求头X-Netflix-Error-Cause</span>        RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"X-Netflix-Error-Cause"</span><span class="token punctuation">,</span> <span class="token string">"Zuul Error: "</span> <span class="token operator">+</span> cause<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 对该次错误请求进行统计</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>nStatusCode <span class="token operator">==</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            ErrorStatsManager<span class="token punctuation">.</span>manager<span class="token punctuation">.</span><span class="token function">putStats</span><span class="token punctuation">(</span><span class="token string">"ROUTE_NOT_FOUND"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            ErrorStatsManager<span class="token punctuation">.</span>manager<span class="token punctuation">.</span><span class="token function">putStats</span><span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>route<span class="token punctuation">,</span> <span class="token string">"Zuul_Error_"</span> <span class="token operator">+</span> cause<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 判断是否改写响应状态，则请求传入的参数决定</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>overrideStatusCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>            RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setResponseStatusCode</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setResponseStatusCode</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>nStatusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 设置标识，表示不再返回zuul转发请求得到的响应结果（如果有）</span>        context<span class="token punctuation">.</span><span class="token function">setSendZuulResponse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 设置zuul的异常响应body</span>        context<span class="token punctuation">.</span><span class="token function">setResponseBody</span><span class="token punctuation">(</span><span class="token string">"${getErrorMessage(e, e.nStatusCode)}"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 处理未知异常，与处理ZuulException的逻辑大体相同</span>        RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"X-Zuul-Error-Cause"</span><span class="token punctuation">,</span> <span class="token string">"Zuul Error UNKNOWN Cause"</span><span class="token punctuation">)</span>        ErrorStatsManager<span class="token punctuation">.</span>manager<span class="token punctuation">.</span><span class="token function">putStats</span><span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>route<span class="token punctuation">,</span> <span class="token string">"Zuul_Error_UNKNOWN_Cause"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>overrideStatusCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>            RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setResponseStatusCode</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setResponseStatusCode</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        context<span class="token punctuation">.</span><span class="token function">setSendZuulResponse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>        context<span class="token punctuation">.</span><span class="token function">setResponseBody</span><span class="token punctuation">(</span><span class="token string">"${getErrorMessage(throwable, 500)}"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 设置标识，表示错误已经被处理（防止存在多个error过滤器时重复处理）</span>        context<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"ErrorHandled"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//ErrorResponse was handled</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      <categories>
          
          <category> source </category>
          
          <category> zuul </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>zuul源码解析 —— 过滤器</title>
      <link href="/source/zuul/filters.html"/>
      <url>/source/zuul/filters.html</url>
      <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>过滤器是zuul最重要的组件，几乎它所有功能都是通过过滤器来实现的。因此，理解各个过滤器的功能是阅读源码必不可少的环节。</p><h2 id="过滤器的分类"><a href="#过滤器的分类" class="headerlink" title="过滤器的分类"></a>过滤器的分类</h2><h3 id="按功能分类"><a href="#按功能分类" class="headerlink" title="按功能分类"></a>按功能分类</h3><p>如果按照功能分类，过滤器主要有四大类：pre/route/post/error，它们之间的逻辑关系在<a href="architecture.html#ZuulServlet">ZuulServlet</a>中有描述。<br>除此之外你也可以自定义特殊类型的过滤器，比如源码中就有一个healthcheck类型。不过自定义类型的过滤器不会被zuul自动识别，需要使用者手动触发调用。</p><h2 id="ZuulFilter"><a href="#ZuulFilter" class="headerlink" title="ZuulFilter"></a>ZuulFilter</h2><p><code>ZuulFilter</code>是所有过滤器的基类，其核心方法是runFilter，应用了模板方法模式，来看下代码</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ZuulFilter.java</span><span class="token keyword">public</span> ZuulFilterResult <span class="token function">runFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ZuulFilterResult zr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZuulFilterResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 当前filter是否被禁用</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFilterDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 是否满足filter执行条件</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Tracer t <span class="token operator">=</span> TracerFactory<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startMicroTracer</span><span class="token punctuation">(</span><span class="token string">"ZUUL::"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 具体的filter逻辑执行的地方</span>                Object res <span class="token operator">=</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// wrap一下结果</span>                zr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZuulFilterResult</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> ExecutionStatus<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                t<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"ZUUL::"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                zr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZuulFilterResult</span><span class="token punctuation">(</span>ExecutionStatus<span class="token punctuation">.</span>FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span>                zr<span class="token punctuation">.</span><span class="token function">setException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                t<span class="token punctuation">.</span><span class="token function">stopAndLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            zr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZuulFilterResult</span><span class="token punctuation">(</span>ExecutionStatus<span class="token punctuation">.</span>SKIPPED<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面代码中的关键方法有两个：shouldFilter()和run()。</p><p>这两个方法都是抽象的，需要由具体的过滤器去实现。一般来说，我们在阅读过滤器源码时只需要重点关注这两个方法即可。</p><h2 id="zuul-netflix-webapp提供的过滤器"><a href="#zuul-netflix-webapp提供的过滤器" class="headerlink" title="zuul-netflix-webapp提供的过滤器"></a>zuul-netflix-webapp提供的过滤器</h2><p><code>zuul-netflix-webapp</code>模块中提供了一些有用的过滤器，在src/main/groovy/filters目录下</p><table><thead><tr><th style="text-align:left"><strong>名称</strong></th><th style="text-align:center"><strong>类别</strong></th><th style="text-align:center"><strong>Order</strong></th></tr></thead><tbody><tr><td style="text-align:left">DebugFilter</td><td style="text-align:center"><code>pre</code></td><td style="text-align:center">1</td></tr><tr><td style="text-align:left">Routing</td><td style="text-align:center"><code>pre</code></td><td style="text-align:center">1</td></tr><tr><td style="text-align:left">PreDecoration</td><td style="text-align:center"><code>pre</code></td><td style="text-align:center">20</td></tr><tr><td style="text-align:left">WeightedLoadBalancer</td><td style="text-align:center"><code>pre</code></td><td style="text-align:center">30</td></tr><tr><td style="text-align:left">DebugRequest</td><td style="text-align:center"><code>pre</code></td><td style="text-align:center">10000</td></tr><tr><td style="text-align:left">ZuulNFRequest</td><td style="text-align:center"><code>route</code></td><td style="text-align:center">10</td></tr><tr><td style="text-align:left">ZuulHostRequest</td><td style="text-align:center"><code>route</code></td><td style="text-align:center">100</td></tr><tr><td style="text-align:left">Postfilter</td><td style="text-align:center"><code>post</code></td><td style="text-align:center">10</td></tr><tr><td style="text-align:left">RequestEventInfoCollectorFilter</td><td style="text-align:center"><code>post</code></td><td style="text-align:center">99</td></tr><tr><td style="text-align:left">sendResponse</td><td style="text-align:center"><code>post</code></td><td style="text-align:center">1000</td></tr><tr><td style="text-align:left">Stats</td><td style="text-align:center"><code>post</code></td><td style="text-align:center">2000</td></tr><tr><td style="text-align:left">ErrorResponse</td><td style="text-align:center"><code>error</code></td><td style="text-align:center">1</td></tr><tr><td style="text-align:left">Options</td><td style="text-align:center"><code>static</code></td><td style="text-align:center">0</td></tr><tr><td style="text-align:left">Healthcheck</td><td style="text-align:center"><code>healthcheck</code></td><td style="text-align:center">0</td></tr></tbody></table><p>由于篇幅关系，详细的代码分析拆分为以下三个章节：</p><ul><li><a href="filters/pre.html">Pre和其它类型过滤器</a></li><li><a href="filters/route.html">Route类型过滤器</a></li><li><a href="filters/post.html">Post类型过滤器</a></li></ul><h2 id="zuul-simple-webapp"><a href="#zuul-simple-webapp" class="headerlink" title="zuul-simple-webapp"></a>zuul-simple-webapp</h2><p><code>zuul-simple-webapp</code>提供的过滤器较为简单，实现的功能基本上就是<code>zuul-netfilx-webapp</code>功能的一个子集，因此这里就不列出来了。</p>]]></content>
      
      <categories>
          
          <category> source </category>
          
          <category> zuul </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>zuul源码解析 —— zuul整体架构</title>
      <link href="/source/zuul/architecture.html"/>
      <url>/source/zuul/architecture.html</url>
      <content type="html"><![CDATA[<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>关于zuul架构，官方的<a href="https://github.com/Netflix/zuul/wiki/How-it-Works" target="_blank" rel="noopener">How-it-Works</a>已经讲得很清楚了，这里简单地翻译一下：</p><p>Zuul的核心就是一系列的过滤器，能够在HTTP请求和响应的过程中进行一系列的操作。Zuul提供了一个可以在运行时动态地读取、编译并运行这些过滤器的框架。<br>以下是过滤器的一些重要属性：  </p><ul><li><strong>类型</strong>：通常定义了过滤器会作用在路由的哪个阶段</li><li><strong>执行顺序</strong>：当同一阶段存在多个过滤器时，决定了这些过滤器的执行顺序</li><li><strong>执行条件</strong>：决定过滤器是否被执行</li><li><strong>行为</strong>：当符合条件的时候执行的操作</li></ul><p>过滤器之间不会直接进行通信，而是通过每个请求唯一对应的RequestContext实例进行状态共享。<br>过滤器目前只能通过Groovy语言编写（指的是动态过滤器），尽管从理论上来说Zuul支持所有以JVM为执行环境的语言。<br>过滤器的源码应该写到指定的目录中，Zuul Server会周期性地检查这些目录的变化。一旦某些过滤器有更新，它们将会被Zuul读取并动态地编译到运行时环境中，在随后到来的每个请求中都将被Zuul调用。</p><p><img src="/images/zuul/architecture.png" alt="zuul_architecture"></p><blockquote><p>图片来源 - <a href="https://medium.com/netflix-techblog/announcing-zuul-edge-service-in-the-cloud-ab3af5be08ee" target="_blank" rel="noopener">netflix techblog</a></p></blockquote><h2 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h2><h3 id="ZuulServlet"><a href="#ZuulServlet" class="headerlink" title="ZuulServlet"></a>ZuulServlet</h3><pre class="line-numbers language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- web.xml --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>ZuulServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">></span></span>com.netflix.zuul.http.ZuulServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>ZuulServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Zuul是一个web应用，在web.xml中其使用的Servlet实现是ZuulServlet。因此毫无疑问的，ZuulServlet就是整个Zuul的核心。</p><p>来看看servier方法</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ZuulServlet.java</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span>javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>ServletRequest servletRequest<span class="token punctuation">,</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>ServletResponse servletResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 初始化当前的zuul request context，将request和response放入上下文中</span>        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HttpServletRequest<span class="token punctuation">)</span> servletRequest<span class="token punctuation">,</span> <span class="token punctuation">(</span>HttpServletResponse<span class="token punctuation">)</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Marks this request as having passed through the "Zuul engine", as opposed to servlets</span>        <span class="token comment" spellcheck="true">// explicitly bound in web.xml, for which requests will not have the same data attached</span>        RequestContext context <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 为此次请求设置标识</span>        context<span class="token punctuation">.</span><span class="token function">setZuulEngineRan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// zuul对请求的处理流程 start</span>        <span class="token comment" spellcheck="true">// 以下几个try块部分是zuul对一个请求的处理流程：pre -> route -> post</span>        <span class="token comment" spellcheck="true">// 可以看到：</span>        <span class="token comment" spellcheck="true">// 1. post是必然执行的（可以类比finally块），但如果在post中抛出了异常，交由error处理完后就结束，避免无限循环</span>        <span class="token comment" spellcheck="true">// 2. 任何阶段抛出了ZuulException，都会交由error处理</span>        <span class="token comment" spellcheck="true">// 3. 非ZuulException会被封装后交给error处理</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">preRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ZuulException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">postRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ZuulException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">postRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">postRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ZuulException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// zuul对请求的处理流程 end</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ZuulException</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"UNHANDLED_EXCEPTION_"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 此次请求完成，移除相应的上下文对象</span>        RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面代码逻辑正好zuul官方的架构图相对应</p><p><img src="https://camo.githubusercontent.com/4eb7754152028cdebd5c09d1c6f5acc7683f0094/687474703a2f2f6e6574666c69782e6769746875622e696f2f7a75756c2f696d616765732f7a75756c2d726571756573742d6c6966656379636c652e706e67" alt="zuul_architecture1"></p><h3 id="RequestContext"><a href="#RequestContext" class="headerlink" title="RequestContext"></a>RequestContext</h3><p>RequestContext是各filter之间进行消息传递的介质，其本质上是一个Map，这样就可以在上下文中存储任何kv pair。</p><p><strong>TODO::</strong> 这里有一个疑问，为什么RequestContext是继承自ConcurrentHashMap？因为理论上来说RequestContext对象是绝对线程安全的（线程隔离）。</p><p>RequestContext包含一个类变量threadLocal，</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">RequestContext</span><span class="token operator">></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span>RequestContext<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> RequestContext <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 上下文实例类型取决于contextClass，例如在NFRequestContext中就改写了contextClass</span>            <span class="token keyword">return</span> contextClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在代码的任何地方都可以通过静态方法getCurrentContext获取到属于当前线程（实际上经过zuul的处理，context实例是按请求隔离的）的RequestContext实例</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> RequestContext <span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>testContext <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> testContext<span class="token punctuation">;</span>    RequestContext context <span class="token operator">=</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> context<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="NFRequestContext"><a href="#NFRequestContext" class="headerlink" title="NFRequestContext"></a>NFRequestContext</h4><p><code>NFRequestContext</code>继承自RequestContext，定义了一些与netflix其它组件有关的特定概念和数据的key，例如eureka VIP，Ribbon client返回的repsonse等。它有一个静态方法</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// NFRequestContext.java</span><span class="token keyword">static</span> <span class="token punctuation">{</span>    RequestContext<span class="token punctuation">.</span><span class="token function">setContextClass</span><span class="token punctuation">(</span>NFRequestContext<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>也就是说，只要加载了类NFRequestContext，应用中所有RequestContext的实例都将是NFRequestContext类型。</p><h3 id="ZuulRunner"><a href="#ZuulRunner" class="headerlink" title="ZuulRunner"></a>ZuulRunner</h3><p>ZuulServlet并不做任何实际的操作，而是将所有操作交给ZuulRunner完成。</p><p>而事实上ZuulRunner的大部分操作也是委托给FilterProcessor去完成的，除了init方法。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ZuulRunner.java</span><span class="token comment" spellcheck="true">/** * sets HttpServlet request and HttpResponse */</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>HttpServletRequest servletRequest<span class="token punctuation">,</span> HttpServletResponse servletResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>    RequestContext ctx <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferRequests<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// wrap request并缓存其body</span>        <span class="token comment" spellcheck="true">// 所谓buffer是指将其内容缓存起来，使得可以安全地重复调用getReader(), getInputStream()等方法</span>        <span class="token comment" spellcheck="true">// 因为一般来说，流操作一次之后就不能重复操作了</span>        <span class="token comment" spellcheck="true">// 类com.netflix.zuul.http.HttpServletRequestWrapper注释上有详解</span>        ctx<span class="token punctuation">.</span><span class="token function">setRequest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpServletRequestWrapper</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        ctx<span class="token punctuation">.</span><span class="token function">setRequest</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// response没得选，肯定是wrap过的</span>    ctx<span class="token punctuation">.</span><span class="token function">setResponse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpServletResponseWrapper</span><span class="token punctuation">(</span>servletResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="FilterProcessor"><a href="#FilterProcessor" class="headerlink" title="FilterProcessor"></a>FilterProcessor</h3><p>FilterProcessor是个单例，通过getInstance()方法获取。</p><p>FilterProcessor的核心方法有两个：runFilters和processZuulFilter</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// FilterProcessor.java</span><span class="token comment" spellcheck="true">/** * 这个是真正执行filter的方法，每调用一次都会执行同一类型的所有filter * runs all filters of the filterType sType/ Use this method within filters to run custom filters by type * * @param sType the filterType. * @throws Throwable throws up an arbitrary exception */</span><span class="token keyword">public</span> Object <span class="token function">runFilters</span><span class="token punctuation">(</span>String sType<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 添加debug信息</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">debugRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Debug<span class="token punctuation">.</span><span class="token function">addRoutingDebug</span><span class="token punctuation">(</span><span class="token string">"Invoking {"</span> <span class="token operator">+</span> sType <span class="token operator">+</span> <span class="token string">"} type filters"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">boolean</span> bResult <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 通过FilterLoader获取指定类型的所有filter</span>    List<span class="token operator">&lt;</span>ZuulFilter<span class="token operator">></span> list <span class="token operator">=</span> FilterLoader<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFiltersByType</span><span class="token punctuation">(</span>sType<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 这里没有进行try...catch... 意味着只要任何一个filter执行失败了整个过程就会中断掉</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            ZuulFilter zuulFilter <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            Object result <span class="token operator">=</span> <span class="token function">processZuulFilter</span><span class="token punctuation">(</span>zuulFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> result <span class="token keyword">instanceof</span> <span class="token class-name">Boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 注意这里写的是|=不是!=</span>                <span class="token comment" spellcheck="true">// TODO:: 为什么要用这种写法？既然只有result为boolean类型时才执行，直接赋值不行吗</span>                bResult <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> bResult<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// FilterProcessor.java</span><span class="token comment" spellcheck="true">/** * 执行单个zuul filter * Processes an individual ZuulFilter. This method adds Debug information. Any uncaught Thowables are caught by this method and converted to a ZuulException with a 500 status code. * * @param filter * @return the return value for that filter * @throws ZuulException */</span><span class="token keyword">public</span> Object <span class="token function">processZuulFilter</span><span class="token punctuation">(</span>ZuulFilter filter<span class="token punctuation">)</span> <span class="token keyword">throws</span> ZuulException <span class="token punctuation">{</span>    RequestContext ctx <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> bDebug <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">debugRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> String metricPrefix <span class="token operator">=</span> <span class="token string">"zuul.filter-"</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 这个变量没有用到...</span>    <span class="token keyword">long</span> execTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    String filterName <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> ltime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        filterName <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        RequestContext copy <span class="token operator">=</span> null<span class="token punctuation">;</span>        Object o <span class="token operator">=</span> null<span class="token punctuation">;</span>        Throwable t <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bDebug<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Debug<span class="token punctuation">.</span><span class="token function">addRoutingDebug</span><span class="token punctuation">(</span><span class="token string">"Filter "</span> <span class="token operator">+</span> filter<span class="token punctuation">.</span><span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> filter<span class="token punctuation">.</span><span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> filterName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// copy了一份context用于debug</span>            copy <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        ZuulFilterResult result <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">runFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ExecutionStatus s <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 统计执行时间</span>        execTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ltime<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 这段对过滤器的执行状态进行记录</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> FAILED<span class="token operator">:</span>                t <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                ctx<span class="token punctuation">.</span><span class="token function">addFilterExecutionSummary</span><span class="token punctuation">(</span>filterName<span class="token punctuation">,</span> ExecutionStatus<span class="token punctuation">.</span>FAILED<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> execTime<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> SUCCESS<span class="token operator">:</span>                o <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                ctx<span class="token punctuation">.</span><span class="token function">addFilterExecutionSummary</span><span class="token punctuation">(</span>filterName<span class="token punctuation">,</span> ExecutionStatus<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> execTime<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>bDebug<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Debug<span class="token punctuation">.</span><span class="token function">addRoutingDebug</span><span class="token punctuation">(</span><span class="token string">"Filter {"</span> <span class="token operator">+</span> filterName <span class="token operator">+</span> <span class="token string">" TYPE:"</span> <span class="token operator">+</span> filter<span class="token punctuation">.</span><span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" ORDER:"</span> <span class="token operator">+</span> filter<span class="token punctuation">.</span><span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"} Execution time = "</span> <span class="token operator">+</span> execTime <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    Debug<span class="token punctuation">.</span><span class="token function">compareContextState</span><span class="token punctuation">(</span>filterName<span class="token punctuation">,</span> copy<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token operator">:</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token keyword">throw</span> t<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 触发一个filter usage回调</span>        <span class="token comment" spellcheck="true">// 当前notifier的实现固定是BasicFilterUsageNotifier，通过Servo统计filter的调用</span>        usageNotifier<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> o<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bDebug<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Debug<span class="token punctuation">.</span><span class="token function">addRoutingDebug</span><span class="token punctuation">(</span><span class="token string">"Running Filter failed "</span> <span class="token operator">+</span> filterName <span class="token operator">+</span> <span class="token string">" type:"</span> <span class="token operator">+</span> filter<span class="token punctuation">.</span><span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" order:"</span> <span class="token operator">+</span> filter<span class="token punctuation">.</span><span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        usageNotifier<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> ExecutionStatus<span class="token punctuation">.</span>FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ZuulException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token punctuation">(</span>ZuulException<span class="token punctuation">)</span> e<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            ZuulException ex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZuulException</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"Filter threw Exception"</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> filter<span class="token punctuation">.</span><span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> filterName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 如果在line35之前抛出了异常，这个execTime的值会是0</span>            <span class="token comment" spellcheck="true">// 不过ZuulFilter.runFilter()中做了try...catch...处理，理论上来说不会出现异常</span>            ctx<span class="token punctuation">.</span><span class="token function">addFilterExecutionSummary</span><span class="token punctuation">(</span>filterName<span class="token punctuation">,</span> ExecutionStatus<span class="token punctuation">.</span>FAILED<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> execTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// FilterProcessor.java</span><span class="token comment" spellcheck="true">/** * Publishes a counter metric for each filter on each use. */</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BasicFilterUsageNotifier</span> <span class="token keyword">implements</span> <span class="token class-name">FilterUsageNotifier</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String METRIC_PREFIX <span class="token operator">=</span> <span class="token string">"zuul.filter-"</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span>ZuulFilter filter<span class="token punctuation">,</span> ExecutionStatus status<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 通过Netflix Servo对每个filter进行调用计数</span>        DynamicCounter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>METRIC_PREFIX <span class="token operator">+</span> filter<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"filtertype"</span><span class="token punctuation">,</span> filter<span class="token punctuation">.</span><span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="StartServer"><a href="#StartServer" class="headerlink" title="StartServer"></a>StartServer</h3><p>StartServer是一个ServletContextListener，负责在web应用启动后执行一些初始化操作</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// zuul-netflix-webapp</span><span class="token comment" spellcheck="true">// StartServer.java</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 这个操作是触发静态变量AmazonInfoHolder.INFO的初始化，并不是没有意义的</span>    AmazonInfoHolder<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 监控、度量等初始化</span>    <span class="token function">initPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 动态Filter等相关类的初始化</span>    <span class="token function">initZuul</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// cassandra初始化</span>    <span class="token function">initCassandra</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// NIWS: Netflix Internal Web Service</span>    <span class="token comment" spellcheck="true">// 主要是初始化ribbon的客户端之类的</span>    <span class="token function">initNIWS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 初始化完成，修改当前应用实例的状态为up</span>    ApplicationInfoManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setInstanceStatus</span><span class="token punctuation">(</span>InstanceInfo<span class="token punctuation">.</span>InstanceStatus<span class="token punctuation">.</span>UP<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h4><ul><li><a href="filter/dynamic_load.html#FilterLoader">FilterLoader工作方式</a></li></ul>]]></content>
      
      <categories>
          
          <category> source </category>
          
          <category> zuul </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>zuul源码解析 —— 搭建调试环境</title>
      <link href="/source/zuul/debug_env.html"/>
      <url>/source/zuul/debug_env.html</url>
      <content type="html"><![CDATA[<h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><blockquote><p><a href="https://github.com/Netflix/zuul" target="_blank" rel="noopener">netflix-zuul</a></p></blockquote><p>建议fork一份，方便阅读时随手写些注释提交。</p><h2 id="zuul模块介绍"><a href="#zuul模块介绍" class="headerlink" title="zuul模块介绍"></a>zuul模块介绍</h2><ul><li>zuul-core: 确立zuul整体架构及重要类的api</li><li>zuul-netflix: 提供了对netflix其它组件的集成相关实现，如hystrix, ribbon等。此外还有一些工具，如统计工具。主要是为zuul-netflix-webapp提供支持</li><li>zuul-netflix-webapp: Netflix提供的一个可用于生产环境的应用实现，包括Filter的具体实现，监控，动态Filter管理等功能</li><li>zuul-simple-webapp: 一个简单的示例app，功能比较简单，没有太大的研究价值</li></ul><h2 id="运行zuul-simple-webapp"><a href="#运行zuul-simple-webapp" class="headerlink" title="运行zuul-simple-webapp"></a>运行zuul-simple-webapp</h2><p>直接运行以下命令即可</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cd</span> zuul-simple-webapp$ <span class="token punctuation">..</span>/gradlew jettyRun<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然后可以通过 <a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a> 访问<a href="http://localhost:8080" target="_blank" rel="noopener">httpbin</a>。</p><blockquote><p>详细可以参考<a href="https://github.com/Netflix/zuul/wiki/zuul-simple-webapp" target="_blank" rel="noopener">zuul-simple-webapp</a></p></blockquote><h3 id="什么是httpbin"><a href="#什么是httpbin" class="headerlink" title="什么是httpbin"></a>什么是httpbin</h3><blockquote><p>A simple HTTP Request &amp; Response Service</p></blockquote><p>简单来说就是一个方便测试HTTP请求和响应的各种信息,比如cookie, ip, headers和登录验证等的工具。</p><h2 id="运行zuul-netflix-webapp"><a href="#运行zuul-netflix-webapp" class="headerlink" title="运行zuul-netflix-webapp"></a>运行zuul-netflix-webapp</h2><p>由于这是一个可用于生产环境的应用，在其中集成了eureka等，因此需要运行起来还需要做一定的配置</p><p>配置zuul.properties，位于zuul-netflix-webapp/src/resources，这里只列出一些必须要覆盖的项</p><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># zuul.properties</span><span class="token attr-name">eureka.serviceUrl.default</span><span class="token punctuation">=</span><span class="token attr-value">{你的eureka server注册地址}</span><span class="token comment" spellcheck="true"># 指定filter存放的目录，由于只是调试代码，直接使用zuul提供的filter就好</span><span class="token attr-name">zuul.filter.pre.path</span><span class="token punctuation">=</span><span class="token attr-value">src/main/groovy/filters/pre</span><span class="token attr-name">zuul.filter.routing.path</span><span class="token punctuation">=</span><span class="token attr-value">src/main/groovy/filters/route</span><span class="token attr-name">zuul.filter.post.path</span><span class="token punctuation">=</span><span class="token attr-value">src/main/groovy/filters/post</span><span class="token comment" spellcheck="true"># origin client对应的eureka VIP</span><span class="token attr-name">origin.zuul.client.DeploymentContextBasedVipAddresses</span><span class="token punctuation">=</span><span class="token attr-value">foo</span><span class="token attr-name">origin.zuul.client.Port</span><span class="token punctuation">=</span><span class="token attr-value">8080</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此外，建议修改代码打开debug开关</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Debug.groovy</span><span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>然后运行</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cd</span> zuul-netflix-webapp$ <span class="token punctuation">..</span>/gradlew jettyRun<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>不出意外的话，此时你的zuul应用应该已经注册到eureka server中了。<br>访问 <a href="http://localhost:8080/healthcheck" target="_blank" rel="noopener">http://localhost:8080/healthcheck</a> ，如果出现ok，说明应用已运行成功<br>访问 <a href="http://localhost:8080/path" target="_blank" rel="noopener">http://localhost:8080/path</a> 可以路由到你的foo服务的path路径中</p><h2 id="debug运行-IntelliJ-IDEA"><a href="#debug运行-IntelliJ-IDEA" class="headerlink" title="debug运行(IntelliJ IDEA)"></a>debug运行(IntelliJ IDEA)</h2><p>上面的操作可以运行zuul的webapp，但是还没办法进入断点调试，接下来我们尝试配置用IntelliJ IDEA来进行断点调试。</p><h3 id="添加gradle-run-debug配置"><a href="#添加gradle-run-debug配置" class="headerlink" title="添加gradle run/debug配置"></a>添加gradle run/debug配置</h3><p>在IDEA的run/debug configurations添加一个Gradle配置，参数如下</p><ul><li><strong>Gradle project</strong>: zuul-simple-webapp或zuul-netflix-webapp</li><li><strong>Tasks</strong>: jettyRun</li><li><strong>VM Options</strong>: -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=7777</li></ul><p>然后运行，这时应用会进入无限等待remote连接的状态，因此需要再添加一个remote配置。</p><h3 id="添加remote-run-debug配置"><a href="#添加remote-run-debug配置" class="headerlink" title="添加remote run/debug配置"></a>添加remote run/debug配置</h3><p>在IDEA的run/debug configrations添加一个Remote配置，参数如下</p><ul><li><strong>Host</strong>: localhost</li><li><strong>Port</strong>: 7777（即之前Gradle配置中VM Options的address）</li></ul><p>然后debug运行，就可以愉快地进行调试了。</p>]]></content>
      
      <categories>
          
          <category> source </category>
          
          <category> zuul </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>zuul源码解析目录</title>
      <link href="/source/zuul/home.html"/>
      <url>/source/zuul/home.html</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近看了<a href="http://www.iocoder.cn/" target="_blank" rel="noopener">芋道</a>的<a href="http://www.iocoder.cn/categories/Eureka/" target="_blank" rel="noopener">eureka源码解析</a>。上面还提到了一些阅读源码的方法，觉得挺有意思的，就想自己尝试一下。正好zuul相对完整系统的源码解析文章在网上还没有，而且zuul的源码相对来说还是比较简单的，所以第一篇源码解析文章就选择了zuul。</p><p>此系列文章基于<code>zuul 1.3.0</code>。</p><p>此系列文章与spring cloud zuul无关，是对原生netflix zuul的源码解析。对于spring cloud zuul的源码解析，网上相关的文章还是比较多的。</p><p>在Zuul中，过滤器分为容器（jetty）的过滤器（Filter）和Zuul的过滤器（ZuulFilter）。由于在我们关注的更多的是Zuul的过滤器，因此在文章中如无特殊说明，提到过滤器均指Zuul的过滤器。</p><h2 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h2><ul><li><a href="debug_env.html">zuul源码解析 —— 搭建调试环境</a></li><li><a href="architecture.html">zuul源码解析 —— zuul整体架构</a></li><li><a href="filters.html">zuul源码解析 —— 过滤器</a></li><li><a href="filters/pre.html">zuul源码解析 —— Pre和其它类型的过滤器</a></li><li><a href="filters/route.html">zuul源码解析 —— Route类型过滤器</a></li><li><a href="filters/post.html">zuul源码解析 —— Post类型过滤器</a></li><li><a href="filter/dynamic_load.html">zuul源码解析 —— 动态加载Filter（未完成）</a></li></ul><h2 id="TODO-LIST"><a href="#TODO-LIST" class="headerlink" title="TODO LIST"></a>TODO LIST</h2><p>个人记录的todo list，请无视</p><ul><li style="list-style: none"><input type="checkbox"> monitor, tracer和counter - 都是netflix servo的东西</li><li style="list-style: none"><input type="checkbox" checked> filter registry</li><li style="list-style: none"><input type="checkbox"> groovy filter manager: FilterFileManager, FilterLoader</li><li style="list-style: none"><input type="checkbox" checked> filter loader</li><li style="list-style: none"><input type="checkbox" checked> filter usage notifier</li><li style="list-style: none"><input type="checkbox" checked> groovy的filter如何执行？</li><li style="list-style: none"><input type="checkbox" checked> zuul的配置与ServletConfig</li><li style="list-style: none"><input type="checkbox" checked> zuul servlet, zuul runner, filter processor</li><li style="list-style: none"><input type="checkbox" checked> httpbin</li><li style="list-style: none"><input type="checkbox" checked> 贯串整个请求的RequestContext</li><li style="list-style: none"><input type="checkbox" checked> pre, route, post, error</li><li style="list-style: none"><input type="checkbox"> zuul的request wrapper有何不同？</li><li style="list-style: none"><input type="checkbox" checked> zuul对一次请求的处理流程</li><li style="list-style: none"><input type="checkbox" checked> Debug类</li><li style="list-style: none"><input type="checkbox" checked> zuul的动态配置（DynamicPropertyFactory） - 属于zuul archaius的内容</li><li style="list-style: none"><input type="checkbox"> zuul event</li><li style="list-style: none"><input type="checkbox" checked> vip, routevip, altvip都是些啥</li><li style="list-style: none"><input type="checkbox" checked> RequestContext与NFRequextContext到底用哪个，是在哪里决定的？</li><li style="list-style: none"><input type="checkbox"> SurgicalDebugFilter</li><li style="list-style: none"><input type="checkbox"> WeightedLoadBalancer</li></ul>]]></content>
      
      <categories>
          
          <category> source </category>
          
          <category> zuul </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>UNIX基础知识</title>
      <link href="/UNIX_basic_knowledge.html"/>
      <url>/UNIX_basic_knowledge.html</url>
      <content type="html"><![CDATA[<h1 id="UNIX基础知识"><a href="#UNIX基础知识" class="headerlink" title="UNIX基础知识"></a>UNIX基础知识</h1><h2 id="操作系统简介"><a href="#操作系统简介" class="headerlink" title="操作系统简介"></a>操作系统简介</h2><p>所有的操作系统都为它们所运行的程序提供服务，包括：执行新程序、打开文件、读写文件、分配存储区等。</p><p>严格意义上说，操作系统也是一种软件，它控制计算机硬件资源，提供程序运行环境。通常将这种软件称为<code>内核</code>。内核的接口被称为<code>系统调用</code>，<code>公用函数库</code>建立在系统调用接口之上，<code>shell</code>则是一种特殊的应用程序，为其它应用程序提供接口。</p><p>Linux是GNU操作系统使用的内核。</p><p>每一个进程都有一个<code>工作目录</code>，所有的相对路径都从工作目录开始解释。</p><h2 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h2><p><code>文件描述符</code>是内核用以标识一个特定进程正在访问的文件，进程读写文件时使用。</p><p>每运行一个新程序时，所有的shell都为其打开3个文件描述符：<code>标准输入0</code>、<code>标准输出1</code>、<code>标准错误2</code>。如果不做特殊处理，则所这3个描述符都将链接向终端。大多数shell都提供将这3个描述符重定向的方法，如bash</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">ls</span> <span class="token operator">></span> out.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://blog.csdn.net/bit_clearoff/article/details/54565044" target="_blank" rel="noopener">关于文件描述符</a></li></ul><h2 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h2><p>程序是一个存储在磁盘上某个目录中的可执行文件。内核使用<code>exec</code>函数将程序读入内存并执行。</p><p>程序的执行实例称为<code>进程</code>。每个进程都有一个唯一的数字标符，称为进程ID。进程可以在前台运行，将输出显示在屏幕上，也可以在后台运行。内核控制着系统如何管理运行在系统上的所有进程。</p><h2 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h2><p><code>信号</code>用于通知进程发生了某种情况。进程接收到信号后会进行相应的处理。</p><p>很多情况都会产生信号。如在终端键盘上可以通过<code>中断键（Ctrl-C）</code>和<code>退出键（Ctrl-\）</code>产生相应的信息，用于中断当前运行的进程。如在另一个进程中可通过<code>kill</code>函数向另一个进程发送一个信号中断其运行。</p><h2 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h2><h3 id="日历时间"><a href="#日历时间" class="headerlink" title="日历时间"></a>日历时间</h3><p>其值为<code>自协调世界时（UTC）</code>。</p><h3 id="进程时间"><a href="#进程时间" class="headerlink" title="进程时间"></a>进程时间</h3><p>也称<code>CPU时间</code>，用以度量进程使用的中央处理器资源。有3个进程时间值：</p><ul><li>时钟时间：进程运行的时间总量</li><li>用户CPU时间：执行用户指令所用的时间量</li><li>系统CPU时间：为该进程执行内核程序所经历的时间</li></ul><h2 id="系统调用和库函数"><a href="#系统调用和库函数" class="headerlink" title="系统调用和库函数"></a>系统调用和库函数</h2><p>所有的操作系统都提供多种服务的入口点，由此程序向内核请求服务。这些入口点即称为<code>系统调用</code>。</p><p>系统调用的接口是用c语言定义的，与具体系统如何执行该系统调用的实现技术无关。</p><p><code>通用库函数</code>可能会调用一个或多个内核的系统调用，也可能不会，但它们并不是内核的入口点。从实现来看，库函数与系统调用之间有着本质区别。但从用户角度看，这区别并不重要——系统调用和库函数都是以c函数的形式出现。</p><h2 id="系统内存管理"><a href="#系统内存管理" class="headerlink" title="系统内存管理"></a>系统内存管理</h2><p>内核通过硬盘上的存储空间来实现虚拟内存，这块区域称为<code>交换空间</code>。内核不断地在交换空间和实际的物理内存之间反复交换虚拟内容中的内容，使得系统以为它拥有比物理内存更多的可用内存。</p><h1 id="UNIX标准及实现"><a href="#UNIX标准及实现" class="headerlink" title="UNIX标准及实现"></a>UNIX标准及实现</h1><h2 id="UNIX标准"><a href="#UNIX标准" class="headerlink" title="UNIX标准"></a>UNIX标准</h2><ul><li>ISO C</li><li>IEEE POSIX</li><li>SUS(Signle UNIX Spcification)</li></ul><h2 id="UNIX系统的实现"><a href="#UNIX系统的实现" class="headerlink" title="UNIX系统的实现"></a>UNIX系统的实现</h2><ul><li>SVR4</li><li>FreeBSD</li><li>Linux</li><li>Max OS X</li><li>Solaris</li></ul><p>其中，虽然只有Max OS X和Solaris能够称之为是一种UNIX系统，但它们都实现了UNIX标准并提供了UNIX的编程环境。</p>]]></content>
      
      <categories>
          
          <category> UNIX </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>《摄影师的视界》阅读笔记</title>
      <link href="/%E3%80%8A%E6%91%84%E5%BD%B1%E5%B8%88%E7%9A%84%E8%A7%86%E7%95%8C%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0.html"/>
      <url>/%E3%80%8A%E6%91%84%E5%BD%B1%E5%B8%88%E7%9A%84%E8%A7%86%E7%95%8C%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0.html</url>
      <content type="html"><![CDATA[<h1 id="画框"><a href="#画框" class="headerlink" title="画框"></a>画框</h1><p>图像的背景即是画框。</p><p>数码摄影之前，最常见的画面区域是<code>3:2</code>的水平画框。也是最广泛使用的相机格式。现在胶片的物理宽度不再受限制， 大多数中低端的相机采用了更窄更自然的<code>4:3</code>格式。</p><p>根据被摄主体和摄影师所选的处理方式的不同，画框边界对影像的影响可以很强烈，也可以很微弱。</p><p>对角线在画面中与边界画框相对照，能产生强烈的<code>对角张力</code>，使图像更具动态。</p><p>构图时需要考虑画框中有几个主体，如果有多个主体，就要进行平衡，使得主要的主体更突出。</p><h2 id="主体大小"><a href="#主体大小" class="headerlink" title="主体大小"></a>主体大小</h2><p>如何为主体分配在照片中占据的空间比例：</p><ul><li>如果主体很不寻常、很有趣，往往其细节比较重要，应该让其占据更大的比例</li><li>反之就应该后退一些使我们能看到一些周围的环境</li></ul><h2 id="主体位置"><a href="#主体位置" class="headerlink" title="主体位置"></a>主体位置</h2><p>任何一张只有一个主体的照片里，除非采用将画框填满的构图方式，否则总需要决定怎么安排主体的位置与四周留白的比例。一旦决定在四周保留空间，主体的位置就是一个关键。</p><p><strong>避免中央构图</strong>：缺乏想象力，过于单调乏味。绝对的中心点太过稳定，使画面缺乏动感张力。略微偏离中心会使主体更加融入环境。</p><p>如何需要采用不同寻常的构图，那么需要有一个合适的理由，否则整个布局就显得很荒谬和反常。</p><h2 id="分割画框"><a href="#分割画框" class="headerlink" title="分割画框"></a>分割画框</h2><p>任何类型的任何影像都会自动分割画框（甚至平淡背景上的一个细小物体）。</p><p>如果从两个方向分割画框，就会产生一个交叉点。这通常是一个安排视觉重点或其他注意点的好位置。</p><h3 id="地平线"><a href="#地平线" class="headerlink" title="地平线"></a>地平线</h3><p>地平线对画框进行横向分割。</p><p>如果地平线是唯一有意义的元素，那它的位置就非常重要。</p><p>如果其它元素富有趣味性，也可以让其占据大部分画面，而不需要太过于在意地平线的位置。</p><h3 id="框中框"><a href="#框中框" class="headerlink" title="框中框"></a>框中框</h3><h1 id="设计基础"><a href="#设计基础" class="headerlink" title="设计基础"></a>设计基础</h1><p><strong>构图的本质是组织</strong>，使画框里的的有图像元素<code>有序化</code>。设计重要的是要理解原理，即与各人的欣赏口味没有关系，并可以解释为什么某些照片能给人留下深刻印象，某些影像组织方式会有某种可预计的效果。</p><p>构图类似语言：画框是<code>语境</code>，设计基础是<code>语法</code>，图像元素是<code>词汇</code>，元素处理是<code>句法</code>。</p><p>最基本的两种原理：<code>对比</code>和<code>平衡</code>。</p><p><strong>设计还必须接受限制</strong>：观众对摄影的了解。许多观众也许对设计手法一窍不通，但是看过大量照片后也会了解一些惯例。所以，某些构图方法可以被看作是常规的，摄影师可以根据自己的意图遵从或挑战它们。</p><h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><p>对比强调的是照片中图像元素之间的区别（<code>影调</code>、<code>色彩</code>、<code>形态</code>等），两个相互对比的元素能相互加强。</p><h2 id="平衡"><a href="#平衡" class="headerlink" title="平衡"></a>平衡</h2><p>平衡是隐含在对比之中的关系，是对立元素之间的主动关系。平衡是张力的结果，是对立的影响力相互匹配以提供均衡和协调的感觉。如果失去平衡，就会带来<code>视觉张力</code>。</p><p>视觉的基本原理是<strong>眼睛总会设法寻找某种张力的平衡力</strong>。因此，平衡是和谐，是结果，是直观感觉到美学愉悦的状况。</p><p>无论我们在谈论的是影调、色彩、点布局还是其它什么东西时，目标都是在寻找<code>视觉的『重心』</code>。</p><p><strong>平衡类型</strong></p><ul><li>静态（对称）平衡：每样东西到照片中心的距离都相等，较为严肃、沉闷</li><li>动态平衡：使用不相等的重量和张力达成平衡，更加生动、活泼</li></ul><p>对称平衡的张力被安排在居中的位置。动态平衡处理的则是<strong>不相等的重量和张力</strong>，这能使影像更加生动活泼。</p><p><strong>tip</strong></p><ul><li>相比如何进行平衡，先探讨<strong>是否需要平衡</strong>可能更重要。</li></ul><h2 id="动态张力"><a href="#动态张力" class="headerlink" title="动态张力"></a>动态张力</h2><p>动态张力是使用各种结构内在的能力，以保持眼睛的警觉并使之从画面中心<strong>向外围移动</strong>。这与正规构图的静态特性正好相反。</p><p>取得动态张力的技术相当直接：一组向不同方向的斜线、相反的线条、任何引导眼睛走出画面的结构手段（最好是相反方向的）。</p><h2 id="节奏"><a href="#节奏" class="headerlink" title="节奏"></a>节奏</h2><p>当场景中出现一些<strong>相似的元素</strong>时，通过对它们的布局可以构成有节奏的视觉结构。</p><p>眼睛和大脑天生熟练于扩展所见的，会很乐意假设<code>节奏的延续性</code>。因此，感知到的重复影像会比实际看到的更长。</p><p>打破节奏的异常事物可以使影响更具动感。最好把该事物放在右边（因为眼睛通常从左往右跟踪节奏化结构，这样让眼睛有足够的时间建立节奏）。</p><h2 id="透视与纵深"><a href="#透视与纵深" class="headerlink" title="透视与纵深"></a>透视与纵深</h2><p>『恒常比例』现象：两条平等线从我们身边延伸，会聚在远方，但同时我们却能感觉到它们是笔直而平等的。</p><p>纵深感对照片来说总是很重要。纵深感可以进一步影响照片的写实性。</p><p>摄影必须采用各种策略来加强或减弱画面纵深感。而影像有其自身的参照系，而不是正常的感知系。</p><h3 id="线形透视"><a href="#线形透视" class="headerlink" title="线形透视"></a>线形透视</h3><p>线形透视的特点是会聚的直线，而这些直线在大多数场景里其实的平等线。</p><p>如果相机是水平的，而场景是风光，那么水平线将会聚到地平线。如果相机向上指，建筑边缘这样的垂直线将会聚在天空中的某个点。</p><h3 id="收缩透视"><a href="#收缩透视" class="headerlink" title="收缩透视"></a>收缩透视</h3><p>收缩透视主要出现在位于不同距离的很多相同或相似的物体。</p><h3 id="空间透视"><a href="#空间透视" class="headerlink" title="空间透视"></a>空间透视</h3><p>大气灰雾降低了场景远处部分的反差，提亮影调。我们的眼睛会把这作为一个纵深的提示。</p><h3 id="影调透视"><a href="#影调透视" class="headerlink" title="影调透视"></a>影调透视</h3><p>黑色背景前的明亮物体通常给人感觉很突出，因此有很强烈的纵深感。可以通过安排主体和光线来达到强化纵深的效果。</p><h3 id="色彩透视"><a href="#色彩透视" class="headerlink" title="色彩透视"></a>色彩透视</h3><p>暖色调具有前倾的感觉，而冷色调则退后。</p><h3 id="清晰度"><a href="#清晰度" class="headerlink" title="清晰度"></a>清晰度</h3><p>清晰度高往往暗示着近距离，可以通过对焦来使画面的清晰度不同，从而达到强调纵深的效果。</p><h2 id="内容的强与弱"><a href="#内容的强与弱" class="headerlink" title="内容的强与弱"></a>内容的强与弱</h2><p>有些照片本身的内容就非常充实，过分地考虑构图可能适得其反。</p><h1 id="图形与摄影元素"><a href="#图形与摄影元素" class="headerlink" title="图形与摄影元素"></a>图形与摄影元素</h1><p>所有形状中，隐隐约约构成的形状很储蓄、不惹眼，是最有用的，能帮助将一幅影像归整成可识别的形态，并通过简单的视觉效果引导眼睛满意地发现它们。</p><h2 id="点"><a href="#点" class="headerlink" title="点"></a>点</h2><h3 id="单点"><a href="#单点" class="headerlink" title="单点"></a>单点</h3><p>单点占据画面非常小，为了醒目，它必须与环境存在对比。</p><h3 id="多点"><a href="#多点" class="headerlink" title="多点"></a>多点</h3><p>一旦加入哪怕一个点，点之间的距离也会给画面带来距离感。</p><p>画面上的两个点会使视线来回地从一点移向另一点，导致两点之间产生<code>隐含的连接线</code>。</p><p>画面上的多个点则会隐含地让人感觉占据了它们之间的空间，导致它们组成了区域。</p><p>当画面上有非常多的点需要安排时，可以尝试自然随意的构图而非人为安排。</p><h2 id="线"><a href="#线" class="headerlink" title="线"></a>线</h2><p>大多数线条实际上是边界。</p><p><code>对比</code>在定义视觉线条时扮演了重要的角色。</p><h3 id="水平线"><a href="#水平线" class="headerlink" title="水平线"></a>水平线</h3><h3 id="垂直线"><a href="#垂直线" class="headerlink" title="垂直线"></a>垂直线</h3><h3 id="斜线"><a href="#斜线" class="headerlink" title="斜线"></a>斜线</h3><h3 id="曲线"><a href="#曲线" class="headerlink" title="曲线"></a>曲线</h3><h3 id="视线"><a href="#视线" class="headerlink" title="视线"></a>视线</h3><h2 id="形状"><a href="#形状" class="headerlink" title="形状"></a>形状</h2><h3 id="三角形"><a href="#三角形" class="headerlink" title="三角形"></a>三角形</h3><p>三角形是摄影构图中最有用的形状，部分因为它们易于构造或暗示，部分因为<code>会聚效果</code>。隐含三角形能给影像带来秩序，需要这种安排的地方通常是那些<strong>需要条理性</strong>的地方。</p><p>三角形天生是一种强烈的形状，非常吸引眼睛。而且，通常只要有两条线就够了，第三条可以假设或者使用合适的画框边界。</p><p>画框内构成的三角形应尽量大，充满整个画面，能使得照片看起来具有<code>稳定感</code>。</p><p><code>倒三角</code>则相反，它显得不稳定，更具挑衅性。</p><h1 id="用光线与色彩构图"><a href="#用光线与色彩构图" class="headerlink" title="用光线与色彩构图"></a>用光线与色彩构图</h1><h2 id="明暗与基调"><a href="#明暗与基调" class="headerlink" title="明暗与基调"></a>明暗与基调</h2><p>大多数照片的信息内容主要位于中间影调。然而，<code>阴影</code>和<code>高光</code>能对照片的情绪的气氛产生很大的影响。</p><p>如果忽略色彩，影调的分布由对比和亮度决定。把这两个因素当做指南，影像的风格选择基于三个方面：场景的特征、场景的照明方式、摄影师的诠释。</p><h2 id="构图中的色彩"><a href="#构图中的色彩" class="headerlink" title="构图中的色彩"></a>构图中的色彩</h2><ul><li>色相：色相是各种颜色之所以得名的特性</li><li>饱和度：饱和度是色相的密度或纯度</li><li>明亮度：明亮度决定了色相是黑暗的还是明亮的</li></ul><p>强烈的色相以多层次的方式被感知，除了光学现实有关之外，也与文化和经历相关联。不同的颜色有不同的象征意义，应根据要拍摄的场景和主题来选择使用合适的颜色。</p><h3 id="三原色"><a href="#三原色" class="headerlink" title="三原色"></a>三原色</h3><ul><li>红色被认为是最强烈、密度最高的颜色，具有前进的倾向，可以强化纵深感。它充满活力、生机、强烈、温暖、炎热，暗示激情、侵略和危险。</li><li>黄色是所有颜色中最明亮的，甚至没有黑暗的形式。它精力充沛、锐利、坚定、好斗、欢乐，能与太阳以及其他光源相关联。</li><li>蓝色比黄色收敛，倾向于安静，相对较暗，显得冷静。蓝色较透明，有很多形式，很多人难以精确判断。</li></ul><h3 id="三补色"><a href="#三补色" class="headerlink" title="三补色"></a>三补色</h3><ul><li>绿色通常是正面的，象征生长、希望和进步。绿色的负面关联则是疾病和腐烂。</li><li>紫色是难以捉摸的、稀有的颜色。难以寻找、捕捉，也难以精确再现。紫色是富有、奢侈、神秘、浩瀚的象征。</li><li>橙色温暖、强烈、辉煌、有力，也代表炎热和干燥。</li></ul><h2 id="色彩关系"><a href="#色彩关系" class="headerlink" title="色彩关系"></a>色彩关系</h2><p>色彩必须按彼此之间的关系来处理。视觉相邻的色彩不同，它们的感受也不同。</p><h3 id="色彩组合"><a href="#色彩组合" class="headerlink" title="色彩组合"></a>色彩组合</h3><p>两种和谐关系：</p><ul><li>互补色和谐</li><li>相似色和谐</li></ul><p>不同的色彩被人们感受到的亮度值是不同的。例如，黄色最亮，紫色最暗。</p><h3 id="色彩重点"><a href="#色彩重点" class="headerlink" title="色彩重点"></a>色彩重点</h3><p>一小块对比色具有聚焦的效果。最明显的效果是当环境是相对水色的，而纯色相占据了局部区域。这种特别形式的色彩对比无可避免地会显得更为突出，称之为<code>地方色彩</code>。</p><h2 id="温和的色彩"><a href="#温和的色彩" class="headerlink" title="温和的色彩"></a>温和的色彩</h2><p>除非在人造的环境，强烈的色彩在自然世界上相对稀少。</p><p>温和色彩更细微，提供更安静甚至更优雅的愉悦。</p><h2 id="黑白"><a href="#黑白" class="headerlink" title="黑白"></a>黑白</h2><p>黑和白更能全面地表现影调变化、质感再现、形式模型和定义形状。</p>]]></content>
      
      <categories>
          
          <category> 摄影 </category>
          
          <category> 构图 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>redisson学习笔记</title>
      <link href="/redisson%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
      <url>/redisson%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html</url>
      <content type="html"><![CDATA[<h1 id="认识redisson"><a href="#认识redisson" class="headerlink" title="认识redisson"></a>认识redisson</h1><p>来看下官方的介绍：</p><blockquote><p>Redis based In-Memory Data Grid for Java. State of the Art Redis client.</p></blockquote><p>可以知道，redisson是Java的一款redis客户端。</p><p>作为redis客户端，它和大名鼎鼎的<code>jedis</code>有什么区别呢？redisson的宗旨是促进使用者对redis的<strong>关注分离</strong>，从而让使用者能够将精力更集中地放在处理业务逻辑上。</p><p>换句话说，redisson对redis的操作进行了一些更高级的抽象，使得我们能够轻松地实现一些复杂的功能，如一系列的<code>Java分布式对象</code>，常用的<code>分布式服务</code>等。而作为抽象的代价，就是丢失了对底层细节的掌控。</p><h1 id="Getting-Start"><a href="#Getting-Start" class="headerlink" title="Getting Start"></a>Getting Start</h1><p>redisson官方就支持与spring-boot集成，因此根据<a href="https://github.com/redisson/redisson/tree/master/redisson-spring-boot-starter" target="_blank" rel="noopener">官方文档</a>直接依赖</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>redisson-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再配置相关yaml，以最简单的本地单机模式启动</p><p><strong>application.yaml</strong></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">redis</span><span class="token punctuation">:</span>    <span class="token key atrule">redisson</span><span class="token punctuation">:</span>      <span class="token key atrule">config</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>redisson.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>redisson.yaml</strong></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">singleServerConfig</span><span class="token punctuation">:</span>  <span class="token key atrule">address</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">6379</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然而添加依赖后直接启动spring boot应用居然报错了，注入<code>RedissonClient</code>失败！</p><p>妈耶，Google了一下无果，直接看源码，居然发下<code>redisson-spring-boot-starter</code>这个包没有<code>spring.factories</code>文件，也即是说<code>RedissonAutoConfiguration</code>不会自动加载。。</p><p>于是补上</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token annotation punctuation">@ImportAutoConfiguration</span><span class="token punctuation">(</span>RedissonAutoConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Application<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>虽然不知道redisson官方出于什么原因没有提供<code>spring.factories</code>文件，总之再次启动，正常。</p><h1 id="redisson锁"><a href="#redisson锁" class="headerlink" title="redisson锁"></a>redisson锁</h1><h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="接口调用限制"><a href="#接口调用限制" class="headerlink" title="接口调用限制"></a>接口调用限制</h3><h1 id="redisson执行lua脚本"><a href="#redisson执行lua脚本" class="headerlink" title="redisson执行lua脚本"></a>redisson执行lua脚本</h1><p>redisson提供了很方便地执行lua脚本的方式</p><pre class="line-numbers language-java"><code class="language-java">redissonClient<span class="token punctuation">.</span><span class="token function">getScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>    RScript<span class="token punctuation">.</span>Mode<span class="token punctuation">.</span>READ_ONLY<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//执行模式</span>    <span class="token string">"return redis.call('get', KEYS[1])"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 要执行的lua脚本</span>    RScript<span class="token punctuation">.</span>ReturnType<span class="token punctuation">.</span>INTEGER<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 返回值类型</span>    Lists<span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token string">"tac"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 传入KEYS</span>    <span class="token boolean">true</span><span class="token punctuation">,</span> 1L<span class="token punctuation">,</span> <span class="token string">"hello"</span>   <span class="token comment" spellcheck="true">//传入ARGV</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>更具体可以参考官方文档<a href="https://github.com/redisson/redisson/wiki/10.-%E9%A2%9D%E5%A4%96%E5%8A%9F%E8%83%BD#104-%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C" target="_blank" rel="noopener">脚本执行</a></p></blockquote><h2 id="踩过的一些坑"><a href="#踩过的一些坑" class="headerlink" title="踩过的一些坑"></a>踩过的一些坑</h2><h3 id="传入的Boolean值参数会变成字符串"><a href="#传入的Boolean值参数会变成字符串" class="headerlink" title="传入的Boolean值参数会变成字符串"></a>传入的Boolean值参数会变成字符串</h3><p>假设通过redisson的eval()传入的<code>ARGV = false</code>，那么在lua脚本中</p><pre class="line-numbers language-lua"><code class="language-lua"><span class="token function">print</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">--输出'string'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="传入数值也会变成字符串，非int型则会被序列化存储"><a href="#传入数值也会变成字符串，非int型则会被序列化存储" class="headerlink" title="传入数值也会变成字符串，非int型则会被序列化存储"></a>传入数值也会变成字符串，非int型则会被序列化存储</h3><p>假设通过redisson的eval()传入的<code>ARGV = 1L</code>，那么在lua脚本中获取会变成</p><pre class="line-numbers language-lua"><code class="language-lua"><span class="token function">print</span><span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">--输出'["java.lang.Long",1]'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>若传入的是<code>ARGV = 1</code>，则</p><pre class="line-numbers language-lua"><code class="language-lua"><span class="token function">print</span><span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">--输出'1'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="直接从redis-call-获取得值是int型，而在lua中进行了数值操作后得到的值却是long型"><a href="#直接从redis-call-获取得值是int型，而在lua中进行了数值操作后得到的值却是long型" class="headerlink" title="直接从redis.call()获取得值是int型，而在lua中进行了数值操作后得到的值却是long型"></a>直接从redis.call()获取得值是int型，而在lua中进行了数值操作后得到的值却是long型</h3><p>例如，以下结果是转换为<code>java.lang.Integer</code></p><pre class="line-numbers language-lua"><code class="language-lua"><span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'tac'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>而以下结果却是转换为<code>java.lang.Long</code></p><pre class="line-numbers language-lua"><code class="language-lua"><span class="token keyword">local</span> tac <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'tac'</span><span class="token punctuation">)</span><span class="token keyword">return</span> tac <span class="token operator">+</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="一些小细节"><a href="#一些小细节" class="headerlink" title="一些小细节"></a>一些小细节</h1><ul><li>注意是redisson，不要写成redission</li><li>redisson提供的所有类都是以R开头的，如RLock</li></ul>]]></content>
      
      <categories>
          
          <category> java </category>
          
          <category> redisson </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>zuul中hystrix默认timeout配置失效的原因</title>
      <link href="/zuul_hystrix_default_timeout_config_invalid_reason_research.html"/>
      <url>/zuul_hystrix_default_timeout_config_invalid_reason_research.html</url>
      <content type="html"><![CDATA[<h1 id="所处环境"><a href="#所处环境" class="headerlink" title="所处环境"></a>所处环境</h1><ul><li><code>spring boot</code>: 1.5.9.RELEASE</li><li><code>spring cloud</code>: Edgware.RELEASE</li></ul><h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>根据netflix hystrix官方的描述，可以通过<a href="https://github.com/Netflix/Hystrix/wiki/Configuration#execution.isolation.thread.timeoutInMilliseconds" target="_blank" rel="noopener"><code>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</code></a>这个全局配置为所有服务配置默认超时时间。然而在实践中却发现该配置并没有生效（一直是2000ms），但针对各服务进行单独配置却是可以生效的。</p><h1 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h1><p>经google发现，hystrix的timeout机制是通过<code>HystrixTimer</code>来处理的。</p><p>HystrixTimer是一个单例，开发人员可以在执行<code>HystrixCommand</code>前通过调用HystrixTimer.getInstance().addTimerListener()方法来添加一个定时的listener，然后在command on completed的时候移除它。相关的代码已经由netflix实现了，可以查看源码<a href="https://github.com/Netflix/Hystrix/blob/master/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1137" target="_blank" rel="noopener"><code>AbstractCommand.java</code></a></p><pre class="line-numbers language-java"><code class="language-java">TimerListener listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getIntervalTimeInMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> originalCommand<span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">executionTimeoutInMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">final</span> Reference<span class="token operator">&lt;</span>TimerListener<span class="token operator">></span> tl <span class="token operator">=</span> HystrixTimer<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTimerListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// set externally so execute/queue can see this</span>originalCommand<span class="token punctuation">.</span>timeoutTimer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>tl<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*** If this subscriber receives values it means the parent succeeded/completed*/</span>Subscriber<span class="token operator">&lt;</span>R<span class="token operator">></span> parent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subscriber</span><span class="token operator">&lt;</span>R<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNotTimedOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// stop timer and pass notification through</span>            tl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            child<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span>Throwable e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNotTimedOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// stop timer and pass notification through</span>            tl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            child<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从以上代码可以很容易追溯到hystrix超时时间是从originalCommand.properties(<code>HystrixCommandProperties</code>)这个对象中获取的，而在spring cloud提供的<code>AbstractRibbonCommand</code>中存在以下代码</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> HystrixCommandProperties<span class="token punctuation">.</span>Setter setter <span class="token operator">=</span> HystrixCommandProperties<span class="token punctuation">.</span><span class="token function">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">withExecutionIsolationStrategy</span><span class="token punctuation">(</span>zuulProperties<span class="token punctuation">.</span><span class="token function">getRibbonIsolationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withExecutionTimeoutInMilliseconds</span><span class="token punctuation">(</span>                RibbonClientConfiguration<span class="token punctuation">.</span>DEFAULT_CONNECT_TIMEOUT <span class="token operator">+</span> RibbonClientConfiguration<span class="token punctuation">.</span>DEFAULT_READ_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>导致originalCommand.properties在构建时可以获取到一个executionTimeoutInMilliseconds的实例级默认值，从而覆盖掉了全局的executionTimeoutInMilliseconds配置，但实例级的配置并不受影响，因为hystrix property优先级为：</strong>  </p><ol><li>Global default from code</li><li>Dynamic global default property</li><li>Instance default from code</li><li>Dynamic instance property</li></ol><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><ol><li><p>改写HttpClientRibbonCommand的实现<br>//todo:: 待补充</p></li><li><p>升级spring cloud版本到Edgware.SR1以上<br>Spring cloud在<code>Edgware.SR1</code>版本中已经解决了此问题(<a href="https://github.com/spring-cloud/spring-cloud-netflix/pull/2633" target="_blank" rel="noopener">issue2633</a>)，如果有条件可以直接通过升级版本来解决此问题。</p></li></ol><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ul><li><a href="https://github.com/Netflix/Hystrix/wiki/Configuration" target="_blank" rel="noopener">Hystrix Configurations</a></li><li><a href="https://segmentfault.com/a/1190000015393836" target="_blank" rel="noopener">聊聊hystrix的timeout处理 - segmentfault</a></li><li><a href="https://segmentfault.com/a/1190000012439580" target="_blank" rel="noopener">Hystrix工作原理</a></li><li><a href="https://www.jianshu.com/p/6e2f11821c77" target="_blank" rel="noopener">ribbon设置url级别的超时时间</a></li></ul>]]></content>
      
      <categories>
          
          <category> java </category>
          
          <category> 踩坑日记 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>声明式http客户端openfeign的研究与应用</title>
      <link href="/openfeign_research_and_application.html"/>
      <url>/openfeign_research_and_application.html</url>
      <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h2 id="openfeign"><a href="#openfeign" class="headerlink" title="openfeign"></a>openfeign</h2><p>openfeign，简称feign，是netflix开源的技术栈之一。<br>feign的主旨是使得编写java http客户端更容易。为了贯彻这个理念，feign采用了通过处理注解来自动生成请求的方式（官方称呼为<code>声明式</code>、<code>模板化</code>）。因此，基于feign编写的http客户端画风看起来是这样的</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">Bank</span> <span class="token punctuation">{</span>  <span class="token annotation punctuation">@RequestLine</span><span class="token punctuation">(</span><span class="token string">"POST /account/{id}"</span><span class="token punctuation">)</span>  Account <span class="token function">getAccountInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> String id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>然后通过一系列操作可以为Bank接口在运行时自动生成对应的实现。通过这个实现我们就可以在java中像调用一个本地方法一样完成一次http请求，大大减少了编码成本，同时提高了代码可读性。</p><h2 id="spring-cloud-openfeign"><a href="#spring-cloud-openfeign" class="headerlink" title="spring-cloud-openfeign"></a>spring-cloud-openfeign</h2><p>spring-cloud-feign基于自动配置功能（autoconfiguration），为spring boot应用提供openfiegn的集成：</p><ul><li>支持通过<code>JAX-RS</code>或<code>Spring MVC annotations</code>来构建feign client</li><li>自动使用Spring MVC的<code>HttpMessageConverters</code>来完成序列化反序列化</li><li>集成了<code>ribbon</code>和<code>hystrix</code>，只要在项目中引入相关的依赖即可立即使用</li><li>无需任何配置，开箱即用，秉承了spring-boot一贯的作风。</li></ul><blockquote><p><a href="https://github.com/spring-cloud/spring-cloud-openfeign/blob/master/docs/src/main/asciidoc/spring-cloud-openfeign.adoc" target="_blank" rel="noopener">官方文档参考</a></p></blockquote><h1 id="常见问题及解决方案"><a href="#常见问题及解决方案" class="headerlink" title="常见问题及解决方案"></a>常见问题及解决方案</h1><h2 id="处理响应数据的通用部分"><a href="#处理响应数据的通用部分" class="headerlink" title="处理响应数据的通用部分"></a>处理响应数据的通用部分</h2><p>api响应数据格式，一般而言除实际的业务数据外是固定的格式，其中包括了对此次请求的处理信息描述。对于这部分数据，应由feign进行统一处理。</p><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>feignclient是通过Decoder来对请求响应进行处理的，因此可以使用自定义的Decoder来处理响应数据的通用部分。</p><p>例如可以定义一个<code>UnwrapRestfulApiResponseSpringDecoder</code>来对<code>RestfulApiResponse</code>进行自动拆包操作，并通过<code>@FeignClient</code>的<code>configuration</code>属性配置其使用的Decoder。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> AuthCenter<span class="token punctuation">.</span>SERVICE_NAME<span class="token punctuation">,</span> path <span class="token operator">=</span> RMIPath<span class="token punctuation">.</span>USER<span class="token punctuation">,</span> configuration <span class="token operator">=</span> TenantUserClient<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TenantUserClient</span> <span class="token punctuation">{</span>    <span class="token keyword">class</span> <span class="token class-name">Configuration</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Autowired</span>        <span class="token keyword">private</span> ObjectFactory<span class="token operator">&lt;</span>HttpMessageConverters<span class="token operator">></span> messageConverters<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Bean</span>        <span class="token keyword">public</span> Decoder <span class="token function">feignDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseEntityDecoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UnwrapRestfulApiResponseSpringDecoder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageConverters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="本地调用需要注册到注册中心导致服务不可用的问题"><a href="#本地调用需要注册到注册中心导致服务不可用的问题" class="headerlink" title="本地调用需要注册到注册中心导致服务不可用的问题"></a>本地调用需要注册到注册中心导致服务不可用的问题</h2><p>在实际开发过程中，有时会出现需要在本地调用远程服务来进行调试的情况，此时我们需要将本地的应用注册到注册中心。而一旦这样做，会导致该服务存在多个节点（一个远程一个本地），从而导致依赖该服务的应用软负载均衡负载到本地节点时会失败。</p><h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><h4 id="1-不通过注册中心获取信息，使用直接指定url的方式调用（✘不推荐）"><a href="#1-不通过注册中心获取信息，使用直接指定url的方式调用（✘不推荐）" class="headerlink" title="1. 不通过注册中心获取信息，使用直接指定url的方式调用（✘不推荐）"></a>1. 不通过注册中心获取信息，使用直接指定url的方式调用（✘不推荐）</h4><p><strong>参考代码</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"sysinfo-service"</span> <span class="token punctuation">,</span>url <span class="token operator">=</span> <span class="token string">"http://49.4.7.72"</span><span class="token punctuation">,</span> path <span class="token operator">=</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SysinfoClient</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>此方案优点是简单易用，但缺点也很明显：</p><ol><li>在应用实际上线时需要将调用方式修改为通过注册中心调用，否则client将无法进行负载均衡，因此需要频繁改动代码</li><li>在特定环境下，即使忘记切换调用方式有时也不影响client的使用，会将问题隐藏，埋下隐患</li><li>并没有与其它服务真正地解耦，一旦依赖的服务故障就会导致本地开发无法进行</li></ol><p>由于存在上述缺点，现一般<strong>不推荐</strong>使用该方案。</p><h4 id="2-使用打桩的方式与远程服务解耦（✔推荐）"><a href="#2-使用打桩的方式与远程服务解耦（✔推荐）" class="headerlink" title="2. 使用打桩的方式与远程服务解耦（✔推荐）"></a>2. 使用打桩的方式与远程服务解耦（✔推荐）</h4><p>大致思路为，通过Spring的<code>@Profile</code>注解，在不同的环境为应用注册不同的client bean（例如在本地环境使用Hard Code bean，而在非本地环境则使用远程调用的client bean）。</p><p><strong>参考代码</strong><br><strong>ClientConfiguration.java</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@EnableAuthClient</span><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.cheegu.icm.biz.foo.client"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@Profile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>SpringProfiles<span class="token punctuation">.</span>DEV<span class="token punctuation">,</span> SpringProfiles<span class="token punctuation">.</span>TEST<span class="token punctuation">,</span> SpringProfiles<span class="token punctuation">.</span>PROD<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientConfiguration</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>MockClientConfiguration.java</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@Profile</span><span class="token punctuation">(</span>SpringProfiles<span class="token punctuation">.</span>LOCAL<span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MockClientConfiguration</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> SysinfoClient <span class="token function">sysinfoClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SysinfoClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> UserInfoDto <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserInfoDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> TableData<span class="token operator">&lt;</span>UserRowDto<span class="token operator">></span> <span class="token function">users</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> TableData<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> TenantUserClient <span class="token function">tenantUserClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TenantUserClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> List<span class="token operator">&lt;</span>ResourceInfoDto<span class="token operator">></span> <span class="token function">listMyAlResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="如何在调用时带上请求头"><a href="#如何在调用时带上请求头" class="headerlink" title="如何在调用时带上请求头"></a>如何在调用时带上请求头</h2><p>在使用客户端进行调用时，有时会需要带上某些请求头（例如认证token），但又不希望在代码中手动去做这些操作。</p><h3 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h3><p>可以通过实现feign提供的<code>RequestInterceptor</code>接口来对请求进行切面处理。这样每次通过client发起请求时都会由feign interceptor进行拦截，为请求添加headers。</p><p><strong>参考代码</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">EnvironmentAware</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Environment environment<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> AuthorizationInfoForwardingInterceptor <span class="token function">authorizationInfoForwardingInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//这个interceptor会为请求自动带上认证token</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationInfoForwardingInterceptor</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"spring.application.name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnvironment</span><span class="token punctuation">(</span>Environment environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">=</span> environment<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="指定了get方法，但feign仍然使用了post方法进行请求"><a href="#指定了get方法，但feign仍然使用了post方法进行请求" class="headerlink" title="指定了get方法，但feign仍然使用了post方法进行请求"></a>指定了get方法，但feign仍然使用了post方法进行请求</h2><p>如下代码所示</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"microservice-provider-user"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserFeignClient</span> <span class="token punctuation">{</span>  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/get"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>  <span class="token keyword">public</span> User <span class="token function">get0</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过<code>@RequestMapping</code>的method属性指定了请求方法为GET，但实际运行会发现feign仍然使用了POST方法进行了调用。</p><h3 id="解决方案-3"><a href="#解决方案-3" class="headerlink" title="解决方案"></a>解决方案</h3><p>这种写法并不正确，正确写法有二：</p><h4 id="1-通过-RequestParam指定url参数名"><a href="#1-通过-RequestParam指定url参数名" class="headerlink" title="1. 通过@RequestParam指定url参数名"></a>1. 通过@RequestParam指定url参数名</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"microservice-provider-user"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserFeignClient</span> <span class="token punctuation">{</span>  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/get"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>  <span class="token keyword">public</span> User <span class="token function">get1</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Long id<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> String username<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-当目标url参数较多时，可使用map来构建"><a href="#2-当目标url参数较多时，可使用map来构建" class="headerlink" title="2. 当目标url参数较多时，可使用map来构建"></a>2. 当目标url参数较多时，可使用map来构建</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"microservice-provider-user"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserFeignClient</span> <span class="token punctuation">{</span>  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/get"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>  <span class="token keyword">public</span> User <span class="token function">get2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="使用MultipartFile类型作为请求参数"><a href="#使用MultipartFile类型作为请求参数" class="headerlink" title="使用MultipartFile类型作为请求参数"></a>使用MultipartFile类型作为请求参数</h2><p>有时对外提供的接口调用可能需要传送文件，此时需要对<code>MultipartFile</code>类型的参数进行处理</p><h3 id="解决方案-4"><a href="#解决方案-4" class="headerlink" title="解决方案"></a>解决方案</h3><p><strong>待补充</strong></p>]]></content>
      
      <categories>
          
          <category> java </category>
          
          <category> spring cloud </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>同时配置UrlRewriteFilter与ShiroFilter导致outbound rule失效的问题</title>
      <link href="/outbound_rule_invalid_cause_by_urlrewritefilter_and_shirofilter.html"/>
      <url>/outbound_rule_invalid_cause_by_urlrewritefilter_and_shirofilter.html</url>
      <content type="html"><![CDATA[<h2 id="项目环境"><a href="#项目环境" class="headerlink" title="项目环境"></a>项目环境</h2><p>Spring Boot1.5.4 + Shiro1.4.0 + UrlRewriteFilter4.0.4</p><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>最近在项目中同时用到<a href="http://shiro.apache.org/" target="_blank" rel="noopener">Shiro</a>和<a href="http://www.tuckey.org/urlrewrite/" target="_blank" rel="noopener">UrlRewriteFilter</a>。由于在web环境下两者都是通过配置filter来实现功能的，因此导致出现了冲突——UrlRewriteFilter的outbound rule无法正常工作。具体表现为：</p><p>在urlrewrite.xml中配置了</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>urlrewrite</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>outbound-rule</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>from</span><span class="token punctuation">></span></span>/in-rewrite\?type=(\w+)$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>from</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>to</span><span class="token punctuation">></span></span>/in/$1.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>to</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>outbound-rule</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>urlrewrite</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在java代码中定义action</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"out-rewrite"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token keyword">public</span> String <span class="token function">out</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">encodeURL</span><span class="token punctuation">(</span><span class="token string">"localhost:8080/in-rewrite?type=233"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">//will be rewrite to 'localhost:8080/in/233.html'</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>正常来说，访问这个api应该返回”localhost:8080/in/233.html”才对，但却返回了未转换前的url，即”localhost:8080/in-rewrite?type=233”。</p><h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>在调试源码的时候发现，同时配置了ShiroFilter和UrlRewriteFilter时，response的类型是<code>ShiroHttpServletResponse</code>，此时outbound rule是不起作用的。而把ShiroFilter的配置去掉，只留下UrlRewriteFilter时，response的类型则是<code>UrlRewriteWrappedResponse</code>，而此时outbound rule是起作用的。显然，两者在filter里面都对response进行了重新包装，而ShiroFilter执行在后，导致前者的部分功能失效。</p><p>再查看上面两个response包装类的源码：</p><p><strong>UrlRewriteWrappedResponse.java</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">public</span> String <span class="token function">encodeURL</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>        RewrittenOutboundUrl rou <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processPreEncodeURL</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>rou <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">encodeURL</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>rou<span class="token punctuation">.</span><span class="token function">isEncode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                rou<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">encodeURL</span><span class="token punctuation">(</span>rou<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processPostEncodeURL</span><span class="token punctuation">(</span>rou<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ShiroHttpServletResponse.java</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">public</span> String <span class="token function">encodeURL</span><span class="token punctuation">(</span>String url<span class="token punctuation">)</span> <span class="token punctuation">{</span>        String absolute <span class="token operator">=</span> <span class="token function">toAbsolute</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEncodeable</span><span class="token punctuation">(</span>absolute<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// W3c spec clearly said</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                url <span class="token operator">=</span> absolute<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token function">toEncoded</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> url<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>发现两者均对<code>encodeUrl</code>、<code>encodeRedirectUrl</code>等四个方法进行了改写。Shiro的包装类执行在后，导致<code>UrlRewriteWrappedResponse</code>的相关代码没有被执行。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="重排Filter的执行顺序"><a href="#重排Filter的执行顺序" class="headerlink" title="重排Filter的执行顺序"></a>重排Filter的执行顺序</h3><p>让<code>UrlRewriteWrappedResponse</code>的包装过程执行在后，避免encodeUrl方法被改写。</p><p>显然这不是一个好的办法，原因如下：</p><ol><li>导致<code>ShiroHttpServletResponse</code>的方法被改写，可能引出其它未知问题，无异于拆东墙补西墙</li><li>导致ShiroFilter执行在前，可能导致一些访问的url还未被重写，这次访问就被Shiro拦截了</li></ol><h3 id="自己实现encodeUrl的逻辑"><a href="#自己实现encodeUrl的逻辑" class="headerlink" title="自己实现encodeUrl的逻辑"></a>自己实现encodeUrl的逻辑</h3><p>让<code>ShiroHttpServletResponse</code>执行encode前先执行<code>UrlRewriteWrappedResponse</code>的encode代码。</p><ol><li><p>改写<code>ShiroHttpServletResponse</code>，重写其encode逻辑</p><pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomShiroHttpServletResponse</span> <span class="token keyword">extends</span> <span class="token class-name">ShiroHttpServletResponse</span> <span class="token punctuation">{</span>     <span class="token keyword">private</span> HttpServletResponse wrapped<span class="token punctuation">;</span>     <span class="token keyword">public</span> <span class="token function">CustomShiroHttpServletResponse</span><span class="token punctuation">(</span>HttpServletResponse wrapped<span class="token punctuation">,</span> ServletContext context<span class="token punctuation">,</span> ShiroHttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">super</span><span class="token punctuation">(</span>wrapped<span class="token punctuation">,</span> context<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">this</span><span class="token punctuation">.</span>wrapped <span class="token operator">=</span> wrapped<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token annotation punctuation">@Override</span>     <span class="token keyword">public</span> String <span class="token function">encodeRedirectURL</span><span class="token punctuation">(</span>String url<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">encodeRedirectURL</span><span class="token punctuation">(</span>wrapped<span class="token punctuation">.</span><span class="token function">encodeRedirectURL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token annotation punctuation">@Override</span>     <span class="token keyword">public</span> String <span class="token function">encodeRedirectUrl</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">encodeRedirectUrl</span><span class="token punctuation">(</span>wrapped<span class="token punctuation">.</span><span class="token function">encodeRedirectUrl</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token annotation punctuation">@Override</span>     <span class="token keyword">public</span> String <span class="token function">encodeURL</span><span class="token punctuation">(</span>String url<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">encodeURL</span><span class="token punctuation">(</span>wrapped<span class="token punctuation">.</span><span class="token function">encodeURL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token annotation punctuation">@Override</span>     <span class="token keyword">public</span> String <span class="token function">encodeUrl</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">encodeUrl</span><span class="token punctuation">(</span>wrapped<span class="token punctuation">.</span><span class="token function">encodeUrl</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>改写<code>ShiroFilter</code>，使用<code>CustomShiroHttpServletResponse</code>代替<code>ShiroHttpServletResponse</code></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomSpringShiroFilter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractShiroFilter</span> <span class="token punctuation">{</span> <span class="token keyword">protected</span> <span class="token function">CustomSpringShiroFilter</span><span class="token punctuation">(</span>WebSecurityManager webSecurityManager<span class="token punctuation">,</span> FilterChainResolver resolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">//这段代码是copy了ShiroFilterFactoryBean$SpringShiroFilter的构造方法中的代码</span>     <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>webSecurityManager <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"WebSecurityManager property cannot be null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token function">setSecurityManager</span><span class="token punctuation">(</span>webSecurityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>resolver <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token function">setFilterChainResolver</span><span class="token punctuation">(</span>resolver<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token annotation punctuation">@Override</span> <span class="token keyword">protected</span> ServletResponse <span class="token function">wrapServletResponse</span><span class="token punctuation">(</span>HttpServletResponse orig<span class="token punctuation">,</span> ShiroHttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">//使用CustomShiroHttpServletResponse代替原有的Response Wrapper</span>     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomShiroHttpServletResponse</span><span class="token punctuation">(</span>orig<span class="token punctuation">,</span> <span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>然后改写<code>ShiroFilterFactoryBean</code>的createInstance方法，使用<code>CustomSpringShiroFilter</code>，代替原来的Filter</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomShiroFilterFactoryBean</span> <span class="token keyword">extends</span> <span class="token class-name">ShiroFilterFactoryBean</span> <span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">transient</span> <span class="token keyword">final</span> Logger log <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>ShiroFilterFactoryBean<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token annotation punctuation">@Override</span> <span class="token keyword">protected</span> AbstractShiroFilter <span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">//这部分代码与父类相同</span>     log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Creating Shiro Filter instance."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     SecurityManager securityManager <span class="token operator">=</span> <span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>securityManager <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>         String msg <span class="token operator">=</span> <span class="token string">"SecurityManager property must be set."</span><span class="token punctuation">;</span>         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanInitializationException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>securityManager <span class="token keyword">instanceof</span> <span class="token class-name">WebSecurityManager</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         String msg <span class="token operator">=</span> <span class="token string">"The security manager does not implement the WebSecurityManager interface."</span><span class="token punctuation">;</span>         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanInitializationException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>     FilterChainManager manager <span class="token operator">=</span> <span class="token function">createFilterChainManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     PathMatchingFilterChainResolver chainResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PathMatchingFilterChainResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     chainResolver<span class="token punctuation">.</span><span class="token function">setFilterChainManager</span><span class="token punctuation">(</span>manager<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//使用CustomSpringShiroFilter代替SpringShiroFilter</span>     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomSpringShiroFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WebSecurityManager<span class="token punctuation">)</span> securityManager<span class="token punctuation">,</span> chainResolver<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>重启项目，访问”/out-rewrite”，结果如下<br><img src="/images/20171221/outbound.png" alt="outbound rule"></p></li></ol>]]></content>
      
      <categories>
          
          <category> java </category>
          
          <category> 踩坑日记 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>在@MybatisTest中使用通用Mapper出现InstantiationException的问题</title>
      <link href="/instantiationexception_on_mybatistest.html"/>
      <url>/instantiationexception_on_mybatistest.html</url>
      <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在Spring Boot环境中使用<a href="http://www.mybatis.org/spring-boot-starter/mybatis-spring-boot-test-autoconfigure/" target="_blank" rel="noopener">@MybatisTest</a>注解针对Mapper写单元测试的时候，由于同时引入了<a href="https://github.com/abel533/Mapper" target="_blank" rel="noopener">通用Mapper</a>，在单元测试中调用通用Mapper的方法进行CRUD时会出现<code>InstantiationException</code>异常</p><pre class="line-numbers language-java"><code class="language-java">org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>MyBatisSystemException<span class="token operator">:</span> nested exception is org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>BuilderException<span class="token operator">:</span> Error invoking SqlProvider <span class="token function">method</span> <span class="token punctuation">(</span>tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseSelectProvider<span class="token punctuation">.</span>dynamicSQL<span class="token punctuation">)</span><span class="token punctuation">.</span>  Cause<span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>InstantiationException<span class="token operator">:</span> tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseSelectProvider    at org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>MyBatisExceptionTranslator<span class="token punctuation">.</span><span class="token function">translateExceptionIfPossible</span><span class="token punctuation">(</span>MyBatisExceptionTranslator<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">77</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>SqlSessionTemplate$SqlSessionInterceptor<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>SqlSessionTemplate<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">446</span><span class="token punctuation">)</span>    at com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>$Proxy89<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>Unknown Source<span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>SqlSessionTemplate<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>SqlSessionTemplate<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">166</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>MapperMethod<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>MapperMethod<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">82</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>MapperProxy<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>MapperProxy<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">59</span><span class="token punctuation">)</span>    at com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>$Proxy91<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>Unknown Source<span class="token punctuation">)</span>    at com<span class="token punctuation">.</span>ikentop<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>hh<span class="token punctuation">.</span>ImageRecordMapperTest<span class="token punctuation">.</span><span class="token function">testSimply</span><span class="token punctuation">(</span>ImageRecordMapperTest<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">33</span><span class="token punctuation">)</span>    at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>NativeMethodAccessorImpl<span class="token punctuation">.</span><span class="token function">invoke0</span><span class="token punctuation">(</span>Native Method<span class="token punctuation">)</span>    at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>NativeMethodAccessorImpl<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>NativeMethodAccessorImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">62</span><span class="token punctuation">)</span>    at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>DelegatingMethodAccessorImpl<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>DelegatingMethodAccessorImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>    at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>Method<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">498</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FrameworkMethod$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">runReflectiveCall</span><span class="token punctuation">(</span>FrameworkMethod<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ReflectiveCallable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ReflectiveCallable<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FrameworkMethod<span class="token punctuation">.</span><span class="token function">invokeExplosively</span><span class="token punctuation">(</span>FrameworkMethod<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">47</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>InvokeMethod<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>InvokeMethod<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>RunBeforeTestMethodCallbacks<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>RunBeforeTestMethodCallbacks<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">75</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>RunAfterTestMethodCallbacks<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>RunAfterTestMethodCallbacks<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">86</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>SpringRepeat<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>SpringRepeat<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">84</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token punctuation">.</span><span class="token function">runLeaf</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">325</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span><span class="token function">runChild</span><span class="token punctuation">(</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">252</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span><span class="token function">runChild</span><span class="token punctuation">(</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">94</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner$<span class="token number">3</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">290</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">71</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token punctuation">.</span><span class="token function">runChildren</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">288</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token punctuation">.</span>access$<span class="token function">000</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">58</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner$<span class="token number">2</span><span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">268</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>RunBeforeTestClassCallbacks<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>RunBeforeTestClassCallbacks<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">61</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>RunAfterTestClassCallbacks<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>RunAfterTestClassCallbacks<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">70</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">363</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">191</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span>JUnitCore<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>JUnitCore<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">137</span><span class="token punctuation">)</span>    at com<span class="token punctuation">.</span>intellij<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>JUnit4IdeaTestRunner<span class="token punctuation">.</span><span class="token function">startRunnerWithArgs</span><span class="token punctuation">(</span>JUnit4IdeaTestRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">68</span><span class="token punctuation">)</span>    at com<span class="token punctuation">.</span>intellij<span class="token punctuation">.</span>rt<span class="token punctuation">.</span>execution<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>IdeaTestRunner$Repeater<span class="token punctuation">.</span><span class="token function">startRunnerWithArgs</span><span class="token punctuation">(</span>IdeaTestRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">51</span><span class="token punctuation">)</span>    at com<span class="token punctuation">.</span>intellij<span class="token punctuation">.</span>rt<span class="token punctuation">.</span>execution<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>JUnitStarter<span class="token punctuation">.</span><span class="token function">prepareStreamsAndStart</span><span class="token punctuation">(</span>JUnitStarter<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">237</span><span class="token punctuation">)</span>    at com<span class="token punctuation">.</span>intellij<span class="token punctuation">.</span>rt<span class="token punctuation">.</span>execution<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>JUnitStarter<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>JUnitStarter<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">70</span><span class="token punctuation">)</span>Caused by<span class="token operator">:</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>BuilderException<span class="token operator">:</span> Error invoking SqlProvider <span class="token function">method</span> <span class="token punctuation">(</span>tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseSelectProvider<span class="token punctuation">.</span>dynamicSQL<span class="token punctuation">)</span><span class="token punctuation">.</span>  Cause<span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>InstantiationException<span class="token operator">:</span> tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseSelectProvider    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ProviderSqlSource<span class="token punctuation">.</span><span class="token function">createSqlSource</span><span class="token punctuation">(</span>ProviderSqlSource<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">103</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ProviderSqlSource<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>ProviderSqlSource<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">73</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span>MappedStatement<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>MappedStatement<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">292</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>CachingExecutor<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>CachingExecutor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">81</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>DefaultSqlSession<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>DefaultSqlSession<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">148</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>DefaultSqlSession<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>DefaultSqlSession<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">141</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>DefaultSqlSession<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>DefaultSqlSession<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">77</span><span class="token punctuation">)</span>    at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>NativeMethodAccessorImpl<span class="token punctuation">.</span><span class="token function">invoke0</span><span class="token punctuation">(</span>Native Method<span class="token punctuation">)</span>    at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>NativeMethodAccessorImpl<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>NativeMethodAccessorImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">62</span><span class="token punctuation">)</span>    at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>DelegatingMethodAccessorImpl<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>DelegatingMethodAccessorImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>    at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>Method<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">498</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>SqlSessionTemplate$SqlSessionInterceptor<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>SqlSessionTemplate<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">433</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">34</span> moreCaused by<span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>InstantiationException<span class="token operator">:</span> tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseSelectProvider    at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Class<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>Class<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">427</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ProviderSqlSource<span class="token punctuation">.</span><span class="token function">createSqlSource</span><span class="token punctuation">(</span>ProviderSqlSource<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">85</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">45</span> moreCaused by<span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>NoSuchMethodException<span class="token operator">:</span> tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseSelectProvider<span class="token punctuation">.</span>&lt;init<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>    at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Class<span class="token punctuation">.</span><span class="token function">getConstructor0</span><span class="token punctuation">(</span>Class<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3082</span><span class="token punctuation">)</span>    at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Class<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>Class<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">412</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">46</span> more<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>单元测试代码如下：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token annotation punctuation">@MybatisTest</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ImageRecordMapperTest</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> ImageRecordMapper mapper<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        ImageRecord record <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Assert<span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>        Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"taccisum"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"image1"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"hash1"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="分析原因"><a href="#分析原因" class="headerlink" title="分析原因"></a>分析原因</h2><p>在github上mapper的<a href="https://github.com/abel533/MyBatis-Spring-Boot/issues/34" target="_blank" rel="noopener">issue</a>中有一段作者的回复，说此异常是由于<code>通用方法没有被正确初始化</code>导致。<br>我这边的情况虽然和这个issue不同，但根本原因是一样的。<br>查阅<code>Mybatis-Test</code>的文档可知，<code>@MybatisTest</code>注解不同于<code>@SpringBootTest</code>，它只加载保证Mybatis正常运行所需要的configuration。显然通用Mapper作为Mybatis第三方的扩展，并没有被纳入其中，因而默认情况下通用Mapper的starter是不会被加载的，也就导致通用方法不会被初始化。</p><blockquote><p>The @MybatisTest can be used if you want to test MyBatis components(Mapper interface and SqlSession). By default it will configure MyBatis(MyBatis-Spring) components(SqlSessionFactory and SqlSessionTemplate), configure MyBatis mapper interfaces and configure an in-memory embedded database. MyBatis tests are transactional and rollback at the end of each test by default, for more details refer to the relevant section in the Spring Reference Documentation. Also regular @Component beans will not be loaded into the ApplicationContext.<br>以上是来自<a href="http://www.mybatis.org/spring-boot-starter/mybatis-spring-boot-test-autoconfigure/" target="_blank" rel="noopener">mybatis-spring-boot-test-autoconfigure</a>官方文档的描述</p></blockquote><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>显然，只要让Mapper的starter在MybatisTest的单元测试启动时得以加载即可解决我们的问题。那么如何做呢？<br>Spring Boot提供了一个<code>@ImportAutoConfiguration</code>的注解，因此只需要在单元测试的目标类上使用该注解将MapperAutoConfiguration导入即可</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token annotation punctuation">@ImportAutoConfiguration</span><span class="token punctuation">(</span>MapperAutoConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token annotation punctuation">@MybatisTest</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ImageRecordMapperTest</span> <span class="token punctuation">{</span>    ……<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中<code>MapperAutoConfiguration</code>是通用Mapper的starter的auto-configure类。</p>]]></content>
      
      <categories>
          
          <category> java </category>
          
          <category> 踩坑日记 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Gradle学习（五） - 打包发布</title>
      <link href="/learn_gradle_5.html"/>
      <url>/learn_gradle_5.html</url>
      <content type="html"><![CDATA[<h2 id="发布到Maven仓库"><a href="#发布到Maven仓库" class="headerlink" title="发布到Maven仓库"></a>发布到Maven仓库</h2><h3 id="Maven-Publish插件"><a href="#Maven-Publish插件" class="headerlink" title="Maven-Publish插件"></a>Maven-Publish插件</h3><p>Gradle将项目发布到Maven仓库需要借助插件，<code>Maven-Publish</code>便是官方推荐的一款插件。<br><a href="https://docs.gradle.org/current/userguide/publishing_maven.html" target="_blank" rel="noopener">Maven-Publish</a></p><h3 id="发布项目"><a href="#发布项目" class="headerlink" title="发布项目"></a>发布项目</h3><p>通过<code>&#39;maven-publish&#39;</code>引入插件<br><strong>build.gradle</strong></p><pre class="line-numbers language-groovy"><code class="language-groovy">apply plugin<span class="token punctuation">:</span> <span class="token string">'maven-publish'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="发布到本地"><a href="#发布到本地" class="headerlink" title="发布到本地"></a>发布到本地</h4><p><strong>build.gradle</strong></p><pre class="line-numbers language-groovy"><code class="language-groovy">apply plugin<span class="token punctuation">:</span> <span class="token string">'java'</span>apply plugin<span class="token punctuation">:</span> <span class="token string">'maven-publish'</span>group <span class="token operator">=</span> <span class="token string">'cn.tac.test'</span>version <span class="token operator">=</span> <span class="token string">'1.0'</span>publishing <span class="token punctuation">{</span>    publications <span class="token punctuation">{</span>        <span class="token function">mavenJava</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{</span>            from components<span class="token operator">.</span>java        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>publishing <span class="token punctuation">{</span>    repositories <span class="token punctuation">{</span>        maven <span class="token punctuation">{</span>            url <span class="token string">"$buildDir/repo"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在以上配置中</p><ul><li><code>publishing{}</code>是由插件为项目创建的扩展（PublishingExtension类型），这个扩展提供了两个block：<code>publications{}</code>（MavenPublication类型）和<code>repositories{}</code>（MavenArtifactRepository 类型），分别用于配置<code>要发布的内容</code>和<code>目标仓库</code>（均可配置多个）。</li><li><code>mavenJava{}</code>被称为发布组件<code>Component</code>，用于配置一项要发布的内容，components.java表示这个组件是通过Java插件添加的<code>java</code>组件，可以简单地理解为就是将当前java项目作为发布内容。</li><li><code>maven{}</code>指定了一个要发布的目标仓库，当前指定了当前项目的build目录下的<code>repo</code>目录，即发布到本地</li></ul><p>执行publishing -&gt; publish，可以看到项目成功发布到了<code>build/repo</code>目录中。<br><img src="/images/gradle_learn/publishing/build_repo.png" alt="build/repo"></p><p><strong>tips</strong></p><ul><li>两个<code>publishing{}</code>块的内容也可以合在一起写</li><li>mavenJava只是一个命名，并无特殊含义，你也可以将其更换为别的名称，但不能与其它发布组件名称重复</li><li>mavenJava块中还可以配置要发布的artifact的<code>group</code>、<code>id</code>及<code>version</code>，如果不显式指定，则默认采用当前项目的配置</li></ul><h4 id="发布源码"><a href="#发布源码" class="headerlink" title="发布源码"></a>发布源码</h4><p>在上一步的基础上</p><ol><li>新增一个用于获取源码的task</li><li>配置发布组件，使其发布的同时额外发布一个包含源码的<code>artifact</code></li></ol><p><strong>build.gradle</strong></p><pre class="line-numbers language-groovy"><code class="language-groovy">……<span class="token comment" spellcheck="true">//这个task可以获取到源码</span>task <span class="token function">sourceJar</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Jar<span class="token punctuation">)</span> <span class="token punctuation">{</span>    from sourceSets<span class="token operator">.</span>main<span class="token operator">.</span>allJava<span class="token punctuation">}</span>publishing <span class="token punctuation">{</span>    publications <span class="token punctuation">{</span>        <span class="token function">mavenJava</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{</span>            ……            <span class="token comment" spellcheck="true">//配置额外发布的artifact</span>            artifact sourceJar <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//这个字符串会作为artifact文件的后缀</span>                classifier <span class="token string">"sources"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>……<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行task<br><img src="/images/gradle_learn/publishing/build_repo_with_sources.png" alt="sources"></p><h4 id="发布到远程仓库"><a href="#发布到远程仓库" class="headerlink" title="发布到远程仓库"></a>发布到远程仓库</h4><p>只需要修改url指向远程仓库即可。同时由于远程仓库大多需要认证，因此通常需要通过<code>credentials{}</code>指定用户名和密码</p><p><strong>build.gradle</strong></p><pre class="line-numbers language-groovy"><code class="language-groovy">……publishing <span class="token punctuation">{</span>    repositories <span class="token punctuation">{</span>        maven <span class="token punctuation">{</span>            url <span class="token string">"http://172.10.10.66:8081/nexus/content/repositories/releases/"</span>            credentials <span class="token punctuation">{</span>                username <span class="token operator">=</span> <span class="token string">"admin"</span>                password <span class="token operator">=</span> <span class="token string">"admin123"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>……<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="条件发布"><a href="#条件发布" class="headerlink" title="条件发布"></a>条件发布</h4><p>这点相信会点groovy的同学都不会觉得难，用<code>if/else</code>就可以完成。例如下面的配置实现根据version后缀来决定是发布到<code>snapshots</code>还是<code>releases</code>仓库中</p><p><strong>build.gralde</strong></p><pre class="line-numbers language-groovy"><code class="language-groovy">……publishing <span class="token punctuation">{</span>    repositories <span class="token punctuation">{</span>        <span class="token keyword">def</span> NEXUS_URL <span class="token operator">=</span> <span class="token string">"http://172.10.10.66:8081/nexus/content/repositories/releases/"</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span>version<span class="token operator">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"SNAPSHOT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            NEXUS_URL <span class="token operator">=</span> <span class="token string">"http://172.10.10.66:8081/nexus/content/repositories/snapshots/"</span>        <span class="token punctuation">}</span>        maven <span class="token punctuation">{</span>            url NEXUS_URL            credentials <span class="token punctuation">{</span>                username <span class="token operator">=</span> <span class="token string">"admin"</span>                password <span class="token operator">=</span> <span class="token string">"admin123"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>……<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="发布多项目"><a href="#发布多项目" class="headerlink" title="发布多项目"></a>发布多项目</h4><p>父项目的task执行的同时会执行其所有子项目的同一task（最常见的如build任务），因此多项目发布只需要配置好所有子项目的发布配置即可。</p><p><strong>build.gradle</strong></p><pre class="line-numbers language-groovy"><code class="language-groovy">subprojects <span class="token punctuation">{</span>    apply plugin<span class="token punctuation">:</span> <span class="token string">'java'</span>    apply plugin<span class="token punctuation">:</span> <span class="token string">'maven-publish'</span>    group <span class="token string">"cn.tac.test"</span>    version <span class="token string">"1.0-SNAPSHOT"</span>    <span class="token comment" spellcheck="true">//因为父项目不需要发布，所以只需要配置子项目的发布配置即可</span>    publishing <span class="token punctuation">{</span>        publications <span class="token punctuation">{</span>            <span class="token function">mavenJava</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{</span>                from components<span class="token operator">.</span>java            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    publishing <span class="token punctuation">{</span>        repositories <span class="token punctuation">{</span>            maven <span class="token punctuation">{</span>                url <span class="token string">"$buildDir/repo"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行task，可以看到每个子项目都发布到了其对应的<code>build/repo</code>中。</p><p><strong>tips</strong></p><ul><li>如果子模块之间互相有依赖，Gradle发布时会自动解析各模块的先后发布顺序，无需我们自己配置</li></ul><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="发布后pom-xml中项目的依赖scope为runtime的问题"><a href="#发布后pom-xml中项目的依赖scope为runtime的问题" class="headerlink" title="发布后pom.xml中项目的依赖scope为runtime的问题"></a>发布后pom.xml中项目的依赖scope为runtime的问题</h4><p>在发布的时候发现，项目中通过complie依赖的第三方库或其它模块，在发布后由Gradle生成的<code>pom.xml</code>文件中，依赖的scope默认变成了<code>runtime</code>，而非我们期望的<code>compile</code></p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>  ……  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>cn.tac.test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>publishing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>cn.tac.test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>module1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了达到期望的效果，只需要在发布配置中通过<code>withXML</code>对pom进行修改即可<br><strong>build.gradle</strong></p><pre class="line-numbers language-groovy"><code class="language-groovy">publishing <span class="token punctuation">{</span>    publications <span class="token punctuation">{</span>        <span class="token function">mavenJava</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{</span>            from components<span class="token operator">.</span>java            pom<span class="token operator">.</span>withXml <span class="token punctuation">{</span>                <span class="token function">asNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>dependencies<span class="token operator">.</span><span class="token string">'*'</span><span class="token operator">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    it<span class="token operator">.</span>scope<span class="token operator">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'runtime'</span> <span class="token operator">&amp;&amp;</span> project<span class="token operator">.</span>configurations<span class="token operator">.</span>compile<span class="token operator">.</span>allDependencies<span class="token operator">.</span>find <span class="token punctuation">{</span> dep <span class="token operator">-></span>                        dep<span class="token operator">.</span>name <span class="token operator">==</span> it<span class="token operator">.</span>artifactId<span class="token operator">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token operator">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    it<span class="token operator">.</span>scope<span class="token operator">*.</span>value <span class="token operator">=</span> <span class="token string">'compile'</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再次发布</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>  ……  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>cn.tac.test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>publishing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>cn.tac.test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>module1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>tips</strong></p><ul><li>参考链接 <a href="https://stackoverflow.com/questions/31069666/how-to-change-artifactory-runtime-scope-to-compile-scope" target="_blank" rel="noopener">How to change artifactory runtime scope to compile scope?</a></li><li><a href="https://docs.gradle.org/current/dsl/org.gradle.api.publish.maven.MavenPom.html#org.gradle.api.publish.maven.MavenPom:withXml(org.gradle.api.Action" target="_blank" rel="noopener">更多withXML的信息</a></li></ul>]]></content>
      
      <categories>
          
          <category> java </category>
          
          <category> gradle </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>了解爬虫</title>
      <link href="/know_crawler.html"/>
      <url>/know_crawler.html</url>
      <content type="html"><![CDATA[<h2 id="什么是爬虫"><a href="#什么是爬虫" class="headerlink" title="什么是爬虫"></a>什么是爬虫</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>爬虫（Web Crawler），也叫<code>网络蜘蛛</code>（Splider），是一种用来自动浏览<code>www网页</code>的程序。<br>爬虫一般从一个URL出发，访问所有<code>关联的URL</code>，并从中提取出感兴趣的内容。<br>爬虫访问网站的过程会<code>消耗目标系统资源</code>，所以有不少网络系统并不默许爬虫工作。因此爬虫要考虑到<code>规划</code>、<code>负载</code>，并且要讲『礼貌』（参考<a href="https://zh.wikipedia.org/wiki/Robots.txt" target="_blank" rel="noopener">robots.txt</a>）。</p><p><a href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF%E7%88%AC%E8%9F%B2" target="_blank" rel="noopener">网络爬虫</a></p><h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>爬虫主要有以下应用场景</p><ul><li>科学研究<blockquote><p>如数据挖掘、机器学习、图片处理等</p></blockquote></li><li>Web安全<blockquote><p>如使用爬虫对网站是否存在某一漏洞进行批量验证、利用</p></blockquote></li><li>产品研发<blockquote><p>如采集各个商城物品价格，为用户提供市场最低价</p></blockquote></li><li>舆情监控<blockquote><p>如抓取、分析某社交平台的数据，从而识别出某用户是否为水军</p></blockquote></li><li>搜索引擎<blockquote><p>爬虫是搜索引擎的核心组成部分</p></blockquote></li></ul><h3 id="爬虫策略"><a href="#爬虫策略" class="headerlink" title="爬虫策略"></a>爬虫策略</h3><p>一个爬虫的实现主要由四大策略组成</p><ul><li>选择策略<blockquote><p>指定页面下载的策略，可细分为<br><code>链接跟随限制</code>，指的是爬虫只搜索特定类型（如HTML）的资源，避免发出过多的请求。或者避免请求一些带有”?”的资源，避免从网站下载无限量的URL<br><code>URL规范化</code>，指的是以某种一致的方式修改和标准化URL的过程，避免资源的重复爬取<br><code>路径上移爬取</code>，指爬取每个URL里提示的每个路径，例如对于”http: //<a href="http://www.tac.cn/a/b/c.html&quot;，还会爬取&quot;/a/b&quot;、&quot;/a&quot;和&quot;/&quot;路径。" target="_blank" rel="noopener">www.tac.cn/a/b/c.html&quot;，还会爬取&quot;/a/b&quot;、&quot;/a&quot;和&quot;/&quot;路径。</a><br><code>主题爬取</code>，指有条件地进行爬取（例如只爬取与python相关的页面）。</p></blockquote></li><li>重新访问策略<blockquote><p>网站是经常动态变化的，需要估算URL的<code>新鲜度</code>和<code>过时性</code>，以确保是否需要重新访问。</p></blockquote></li><li>平衡礼貌策略<blockquote><p>使用爬虫可能导致一个<code>站点瘫痪</code>，因此爬虫需要遵守一些协议来避免这个问题。</p></blockquote></li><li>并行策略<blockquote><p>并行运行<code>多个进程</code>的爬虫时，为了避免重复下载页面，爬虫系统需要策略来处理爬虫运行时新发现的URL。</p></blockquote></li></ul><h3 id="简单架构"><a href="#简单架构" class="headerlink" title="简单架构"></a>简单架构</h3><p><img src="/images/crawler_learn/framework.jpg" alt="framework"></p><p>如图，一个最简单的爬虫架构至少包括<code>爬虫调度端</code>、<code>URL管理器</code>、<code>网页下载器</code>、<code>网页解析器</code>。这几个模块相互作用，从而提取出<code>有价值的数据</code>。其时序图如下</p><p><img src="/images/crawler_learn/sequence_chart.jpg" alt="framework"></p><p>爬虫调度器从URL管理器中获取待爬取的URL，交由下载器进行下载。然后将下载器将下载的页面交由解析器进行解析，解析器又反过来将解析到的URL反馈给URL管理器。如此循环往复，直到没有待抓取的URL，则结束爬取。</p><p>——以上图片来自慕课网<a href="http://www.imooc.com/learn/563" target="_blank" rel="noopener">Python开发简单爬虫</a></p><h3 id="URL管理器"><a href="#URL管理器" class="headerlink" title="URL管理器"></a>URL管理器</h3><p>管理待抓取的URL集合和已抓取的URL集合，防止<code>重复抓取</code>、防止<code>循环抓取</code>。</p><p>实现方式</p><ul><li>内存</li><li>关系数据库</li><li>NoSQL</li></ul><h3 id="网页下载器"><a href="#网页下载器" class="headerlink" title="网页下载器"></a>网页下载器</h3><ul><li>urllib2 python官方 *</li></ul><ul><li>requests 第三方</li></ul><p>网页下载分几种场景</p><ul><li>直接通过url下载</li><li>需要添加请求参数，请求头（伪装浏览器）</li><li>需要伪装特殊情景，如cookie、proxy、https、http redirect</li></ul><h3 id="页面解析器"><a href="#页面解析器" class="headerlink" title="页面解析器"></a>页面解析器</h3><p>从网页中提取有价值数据的工具</p><p>python的网页解析器</p><ul><li>正则表达式</li><li>html.parser python官方</li><li>beautiful soup4 第三方 *</li><li>lxml </li></ul>]]></content>
      
      <categories>
          
          <category> python </category>
          
          <category> 爬虫 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Gradle学习（四） - 自定义任务</title>
      <link href="/learn_gradle_4.html"/>
      <url>/learn_gradle_4.html</url>
      <content type="html"><![CDATA[<p>草稿</p>]]></content>
      
      <categories>
          
          <category> java </category>
          
          <category> gradle </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Gradle学习（三） - 多项目构建</title>
      <link href="/learn_gradle_3.html"/>
      <url>/learn_gradle_3.html</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>从<a href="/2017/09/26/Gradle学习（一）/">第一篇</a>中我们知道了如何构建一个单项目，但仅仅这样是不够的。实现多项目的构建有利于<code>模块化</code>，如此一来我们便能更好地在一个大型项目中分离我们的关注点。</p><h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><h3 id="创建根项目"><a href="#创建根项目" class="headerlink" title="创建根项目"></a>创建根项目</h3><p>新建一个文件夹作为根项目目录，执行gradle init</p><pre class="line-numbers language-shell"><code class="language-shell">$ mkdir multi_project$ gradle init$ lsbuild.gradle    gradle          gradlew         gradlew.bat     settings.gradle<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这次我们要关注的重点有两个文件</p><ul><li>build.gradle<blockquote><p>配置一些应用于所有子项目的公共配置</p></blockquote></li><li>settings.gradle<blockquote><p>描述各项目之间的关系</p></blockquote></li></ul><h3 id="创建子项目"><a href="#创建子项目" class="headerlink" title="创建子项目"></a>创建子项目</h3><p>在根目录下分别创建sub-project1和sub-project2目录，然后分别为其创建build.gradle</p><pre class="line-numbers language-shell"><code class="language-shell">$ mkdir sub-project1 sub-project2$ touch sub-project1/build.gradle sub-project2/build.gradle<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然后在根项目的settings.gradle中添加下面内容以关联子项目</p><pre class="line-numbers language-groovy"><code class="language-groovy">include <span class="token string">'sub-project1'</span>include <span class="token string">'sub-project2'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>tips</strong></p><ul><li>一定要注意子项目只需为其创建build.gradle即可，而非使用gradle init指令初始化，这点很重要</li><li>子项目的build.gradle只用于配置该项目特有的一些配置项，公共的配置通过根项目的build.gradle配置</li></ul><h3 id="公共配置"><a href="#公共配置" class="headerlink" title="公共配置"></a>公共配置</h3><p>在根项目的build.gradle中加入以下内容</p><pre class="line-numbers language-groovy"><code class="language-groovy">allprojects<span class="token punctuation">{</span>    group <span class="token operator">=</span> <span class="token string">'cn.tac'</span>    version <span class="token operator">=</span> <span class="token string">'0.1'</span>    repositories<span class="token punctuation">{</span>        maven <span class="token punctuation">{</span>            url <span class="token string">'http://maven.aliyun.com/nexus/content/groups/public/'</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>subprojects <span class="token punctuation">{</span>    apply plugin<span class="token punctuation">:</span> <span class="token string">'java'</span>    sourceCompatibility <span class="token operator">=</span> <span class="token number">1.8</span>    dependencies <span class="token punctuation">{</span>        testCompile <span class="token string">'junit:junit:4.12'</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>allprojects{}</code> 为所有项目添加配置项，所以group、version、repositories都放在了这个block下</li><li><code>subprojects{}</code> 仅仅为当前项目的子项目添加配置项（不包括当前项目本身），所以根项目不需要的内容（如依赖）放在了这个block下</li></ul><h3 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h3><p>分别为子项目创建src目录</p><pre class="line-numbers language-shell"><code class="language-shell">$ mkdir -p sub-project1/src/test/java/cn/tac/gradle sub-project2/src/test/java/cn/tac/gradle<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>并创建单元测试</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>tac<span class="token punctuation">.</span>gradle<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Assert<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Test<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubProject1Test</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello, i'm sub project1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>tac<span class="token punctuation">.</span>gradle<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Assert<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Test<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubProject2Test</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello, i'm sub project2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="执行构建"><a href="#执行构建" class="headerlink" title="执行构建"></a>执行构建</h3><p>完成了上述步骤之后，不出意外此时的目录结构应该如下</p><pre class="line-numbers language-shell"><code class="language-shell">$ tree ..├── build.gradle├── gradle│   └── wrapper│       ├── gradle-wrapper.jar│       └── gradle-wrapper.properties├── gradlew├── gradlew.bat├── settings.gradle├── sub-project1│   ├── build.gradle│   └── src│       └── test│           └── java│               └── cn│                   └── tac│                       └── gradle│                           └── SubProject1Test.java└── sub-project2    ├── build.gradle    └── src        └── test            └── java                └── cn                    └── tac                        └── gradle                            └── SubProject2Test.java<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来我们切换到根目录下，执行</p><pre><code>$ sh gradlew build</code></pre><p>再查看子项目的目录，发现分别多了一个build目录，可见在为根项目执行构建任务时，其include的所有子项目也分别进行了构建。以下分别是两个子项目的build reports<br><img src="/images/gradle_learn/multi_project/subproject1test.png" alt="sub project 1"><br><img src="/images/gradle_learn/multi_project/subproject2test.png" alt="sub project 2"></p><h3 id="依赖其它项目"><a href="#依赖其它项目" class="headerlink" title="依赖其它项目"></a>依赖其它项目</h3><p>在<code>dependencies{}</code>中添加依赖即可，例如sub-project2要依赖sub-project1，可以在sub-project2的build.gradle中添加</p><pre class="line-numbers language-groovy"><code class="language-groovy">dependencies <span class="token punctuation">{</span>  compile <span class="token function">project</span><span class="token punctuation">(</span><span class="token string">':sub-project1'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      <categories>
          
          <category> java </category>
          
          <category> gradle </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Gradle学习（二） - 常用插件</title>
      <link href="/learn_gradle_2.html"/>
      <url>/learn_gradle_2.html</url>
      <content type="html"><![CDATA[<h2 id="build-scan（构建审视）插件"><a href="#build-scan（构建审视）插件" class="headerlink" title="build-scan（构建审视）插件"></a>build-scan（构建审视）插件</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><blockquote><p>A build scan is a shareable and centralized record of a build that provides insights into what happened and why. By applying the build scan plugin to your project, you can create a build scan in the Gradle Cloud for free.<br><a href="https://guides.gradle.org/creating-build-scans/" target="_blank" rel="noopener">Creating Build Scans</a></p></blockquote><p>大概的意思是build scan能为你提供构建过程中发生的what and why信息，在你构建的时候，插件会抓取数据提交到<code>Gradle Cloud</code>，同时返回一个包含构建信息的链接。</p><p><strong>工作流程</strong><br><img src="https://docs.gradle.com/build-scan-plugin/images/build-scan-service-overview.svg" alt="overview"></p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>配置方式很简单，只需要在build.gradle中加入</p><pre class="line-numbers language-groovy"><code class="language-groovy">plugins <span class="token punctuation">{</span>    id <span class="token string">'com.gradle.build-scan'</span> version <span class="token string">'1.9'</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>添加了插件后，可以通过buildScan块来配置插件，其中有两个<code>license</code>相关的属性是<strong><em>必需要配置</em></strong>的</p><pre class="line-numbers language-groovy"><code class="language-groovy">buildScan <span class="token punctuation">{</span>    licenseAgreementUrl <span class="token operator">=</span> <span class="token string">'https://gradle.com/terms-of-service'</span>    licenseAgree <span class="token operator">=</span> <span class="token string">'yes'</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>import changes（如果没有勾选auto-import），可以看到Gradle Project面板上多了个task<br><img src="/images/gradle_build_scan_task.png" alt=""></p><p><strong>tip</strong></p><ul><li>如果添加新的plugin，应该确保build-scan<strong><em>总是在第一个位置</em></strong>，否则其之前的插件虽然仍然正常工作，但是无法到抓取相关的构建信息</li></ul><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>先执行build -&gt; build，再执行这个build scan -&gt; buildScanPublishPrevious，不出意外可以看到terminal中返回了一个链接</p><pre class="line-numbers language-text"><code class="language-text">9:50:39 PM: Executing external task 'buildScanPublishPrevious'...:buildScanPublishPreviousPublishing build scan...https://gradle.com/s/af72je4qbzhmeBUILD SUCCESSFULTotal time: 1.283 secs9:50:41 PM: External task execution finished 'buildScanPublishPrevious'.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>打开链接后可以看到这样一个界面</p><p><img src="/images/gradle_build_scan_insight.png" alt="build scan"></p><p>接下来在任一个单元测试内加入一行让构建失败</p><pre class="line-numbers language-java"><code class="language-java">        Assert<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>再执行一次构建，打开链接查看<br><img src="/images/gradle_build_scan_insight_failure.png" alt="failed build scan"></p><p>可以看到有以下几大优点：</p><ul><li>信息展示非常全面丰富、直观</li><li>良好的分类、折叠，让用户自己选择展开感兴趣的内容，非常友好</li><li>网页形式，非常易于分享（这一点有点类似<code>AngularJS</code>的错误信息，不过没考察是谁借鉴谁的，或许两者都不是原创？）。</li></ul><p>相比之下，这里不得不提到一直被人吐槽的Maven的构建信息，真心是非常不友好😒</p><p><strong>tip</strong></p><ul><li>如果构建时出现”There is no previous build data available to publish.”，可能是没有先执行任一task。</li></ul><h2 id="Application插件"><a href="#Application插件" class="headerlink" title="Application插件"></a>Application插件</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>Application插件可以让你轻松地在本地开发环境下<code>执行JVM应用</code>，同时还可以帮助你将应用打包成一个包含了各类操作系统对应<code>启动脚本</code>的tar and/or zip文件。</p><p><a href="https://docs.gradle.org/3.5/userguide/application_plugin.html" target="_blank" rel="noopener">The Application Plugin</a></p><h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p><strong>build.gradle</strong></p><pre class="line-numbers language-groovy"><code class="language-groovy">apply plugin<span class="token punctuation">:</span> <span class="token string">'application'</span>mainClassName <span class="token operator">=</span> <span class="token string">"cn.tac.test.gradle.Application"</span>    <span class="token comment" spellcheck="true">//指定程序入口类</span><span class="token comment" spellcheck="true">//applicationDefaultJvmArgs = ["-Dgreeting.language=en"]      //应用程序启动时的jvm参数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>添加了Application插件后，项目会多出以下几个task</p><ul><li>run</li><li>startScripts</li><li>installDist</li><li>distZip</li><li>distTar</li></ul><p>具体可以通过tasks任务查看</p><p><strong>tips</strong></p><ul><li>按照官方的说法，Application插件已经隐式地包括了<code>Java</code>插件和<code>Distribution</code>插件，因此如果你原来引入了这两个插件，现在可以去掉了</li></ul><h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p>以我的main函数为例（注意要跟<code>mainClassName</code>属性指定的类一致）</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>tac<span class="token punctuation">.</span>test<span class="token punctuation">.</span>gradle<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>             System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello, it's you args: "</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>             System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello, you do not input any args"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="执行应用"><a href="#执行应用" class="headerlink" title="执行应用"></a>执行应用</h4><pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew run> Task :runhello, you do not input any args<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果要<code>传入参数</code>，可以配置一下run任务<br><strong>build.gradle</strong></p><pre class="line-numbers language-groovy"><code class="language-groovy">run <span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">"myArgs"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      args myArgs    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面配置的意思是，如果当前项目的project对象包含有myArgs属性，那么在执行main函数时就将这个属性作为参数传递，之后我们可以这样执行</p><pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew run -PmyArgs="123","abc","qaz"> Task :runhello, it s you args: [123,abc,qaz]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>其中-PmyArgs分为两部分</p><ul><li>-P，命令行option。作用是指定一个属性的值run，不能省去</li><li>myArgs，我们刚刚在run任务中自定义的属性，通过-P指定</li></ul><h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><p>执行以下脚本可以进行打包</p><pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew distTar distZip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>打包好的内容在<code>/build/distributions</code>中，分别多了一个tar文件和一个zip文件，解压后查看目录结构如下</p><pre class="line-numbers language-shell"><code class="language-shell">$ tree ..├── bin│   ├── gradle_cli│   └── gradle_cli.bat└── lib    └── gradle_cli-1.0.jar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>tips</strong></p><ul><li>当然你也可以通过build任务来打包，build任务会自动将<code>distTar</code>和<code>distZip</code>任务包括进去</li></ul>]]></content>
      
      <categories>
          
          <category> java </category>
          
          <category> gradle </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Gradle学习（一） - Getting Started</title>
      <link href="/learn_gradle_1.html"/>
      <url>/learn_gradle_1.html</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>虽然一直以来都用Maven作为java项目的构建工具，但早就听说过Gradle大名，于是今天终于抽出时间来了解一下这款号称结合了Ant和Maven优点的构建工具。<br>虽然Gradle支持多种语言，但这个系列的文章主要以Java项目构建为主。由于本人不是做Android开发，所以这个系列的文章可能会更偏向于Java Web开发视角。</p><h2 id="学习资源推荐"><a href="#学习资源推荐" class="headerlink" title="学习资源推荐"></a>学习资源推荐</h2><p><a href="https://gradle.org/docs/#getting-started" target="_blank" rel="noopener">官方Documentation</a> 内容非常全面，缺点是全英文（对于英语差的同学简直是噩梦）<br><a href="https://pkaq.gitbooks.io/gradletraining/content/" target="_blank" rel="noopener">《跟我学Gradle》</a> Gralde中文用户组编写的中文系列教程，缺点是还不够完善，有些章节还没有内容<br><a href="https://lippiouyang.gitbooks.io/gradle-in-action-cn/content/index.html" target="_blank" rel="noopener">《Gradle In Action》中译版</a> 书我没完整看过，只是查资料时读过几个章节，感觉内容还不错</p><h2 id="概貌了解"><a href="#概貌了解" class="headerlink" title="概貌了解"></a>概貌了解</h2><h3 id="同类工具比对"><a href="#同类工具比对" class="headerlink" title="同类工具比对"></a>同类工具比对</h3><p><strong>Ant</strong><br>Ant是第一个“现代”构建工具，于2000年发布基于过程式编程的idea，具备<code>插件功能</code>及通过网络进行<code>依赖管理</code>的功能（结合Apache Ivy）。不足之处是采用XML作为脚本编写格式，不符合过程化编程的初衷。</p><p><strong>Maven</strong><br>Maven出现的目的是解决Ant带来的一些问题，发布于2004年。Maven依靠<code>约定</code>并提供现成的可调用的目标，首创了从网络下载依赖的功能。依然采用XML作为配置文件（因此同样有跟Ant一样难以定制化构建过程的缺点）。另外Maven虽然聚焦于依赖管理，但并不能很好地处理相同库文件不同版本之间的冲突（不如Ivy）。</p><p><strong>Gradle</strong><br>Gradle结合了两者的优点，并在此基础上做了许多改进。<br>Gradle使用基于Groovy的<code>DSL</code>编写构建脚本，可以更细致地控制编译打包过程（这也是为什么Android Studio默认采用Gradle作为构建工具的原因）。<br>Gradle对<code>多模块</code>项目有很好的支持。<br>Gradle支持<code>多语言</code>，包括java、groovy、scala、c++等。<br>Gradle使用Apache Ivy处理依赖，因此依赖管理方面优于Maven。同时Gradle可以使用<code>多种类型的远程仓库</code>，如Maven仓库、Ivy仓库。</p><h3 id="关于DSL"><a href="#关于DSL" class="headerlink" title="关于DSL"></a>关于DSL</h3><p>DSL是<code>Domain Specific Language</code>的缩写，即领域特定语言。同字面上的意思，就是专用于处理某一领域问题的特定语言，例如用于web页面开发的HTML语言、用于GNU Emacs的Emacs Lisp等，甚至有一些简单的DSL只用于某个单应用程序（也称为Mini-Languages）。</p><p>由此可见，Gradle使用的DSL应该是一种专用于项目构建的语言。</p><p><a href="https://en.wikipedia.org/wiki/Domain-specific_language" target="_blank" rel="noopener">更多内容</a></p><h2 id="Getting-Started-IntelliJ-IDEA"><a href="#Getting-Started-IntelliJ-IDEA" class="headerlink" title="Getting Started - IntelliJ IDEA"></a>Getting Started - IntelliJ IDEA</h2><p>初次接触为了能够快速看到效果，所以直接使用ide来入门。不过为了对Gradle有更深入的了解，往后的练习项目将全部使用命令行构建。</p><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><ol><li>New -&gt; Project -&gt; Gradle，新建一个Gradle项目（就像Maven一样，IDEA内置了Gradle，所以不需要我们手动去安装了）</li><li>填写GroupId、ArtifactId、Version（这些跟Maven是一样的）</li><li>这里勾选上Create directories for empty content roots automatically选项，让IDEA帮我们创建好目录结构</li><li>Finish，初次构建可能会花费较长的时间（跟Maven一样，要从网络下载一些东西，比如项目模板），构建好后的目录结构如下<br><img src="/images/gradle_project_structure.png" alt="project structure"></li></ol><p>来看下各folder&amp;file的含义：</p><ul><li>.gradle<blockquote><p>Gradle相关的支持文件，一般不用关心</p></blockquote></li><li>gradle<ul><li>wrapper <blockquote><p>The wrapper is a small script and supporting jar and properties file that allows a user to execute Gradle tasks even if they don’t already have Gradle installed. Generating a wrapper also ensures that the user will use the same version of Gradle as the person who created the project.<br><a href="https://guides.gradle.org/creating-new-gradle-builds/" target="_blank" rel="noopener">Creating New Gradle Project</a></p></blockquote>大意为，wrapper里面是一些简单的<code>脚本</code>、使用户能在没有安装Gradle的情况下也能执行Gradle任务的supporting <code>jar</code>及<code>properties</code>文件等，同时wrapper还能确保用户执行Gradle任务时使用的版本与项目创建者使用的Gradle版本相同。<strong>总之是一个开发人员基本不需要关心的目录。</strong></li></ul></li><li>src<blockquote><p>源码目录，采用了与Maven相同的结构</p></blockquote></li><li>build.gradle<blockquote><p>Gradle的构建配置文件（build file），<strong><em>需要我们编写内容</em></strong>（类似Maven的pom.xml）。<br>按照官方的描述，每个build.gradle都配置了一个<code>org.gradle.api.Project</code>类的实例，并且这个实例会有许多内建的方法和属性（稍后CLI项目中可以看到gradlew properties列出了一堆project的属性）。<br><a href="https://docs.gradle.org/current/dsl/" target="_blank" rel="noopener">build.gradle的DSL参考</a></p></blockquote></li><li>gradlew/gradlew.bat<blockquote><p>分别用于类unix系统和windows系统下的wrapper脚本，之后可以看到，创建了wrapper后我们所有的指令都通过wrapper脚本来执行</p></blockquote></li><li>settings.gradle<blockquote><p>与多模块项目配置有关的文件，用于描述项目模块之间的关系</p></blockquote></li></ul><h3 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h3><p>创建好项目后可以看到，已经有许多配置好的东西了，如junit依赖、Gradle wrapper等，所以现在已我们直接可以直接写单元测试</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GettingStarted</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello gradle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行可以看到控制台输出</p><pre class="line-numbers language-text"><code class="language-text">hello gradle<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="Getting-Started-CLI"><a href="#Getting-Started-CLI" class="headerlink" title="Getting Started - CLI"></a>Getting Started - CLI</h2><p>使用ide写个Gradle的Hello World确实非常简单，但使用CLI来搭建项目，能让我们对Gradle有更加深入的了解。<br>接下来我们将尝试用CLI写一个Hello World。</p><h3 id="安装Gradle"><a href="#安装Gradle" class="headerlink" title="安装Gradle"></a>安装Gradle</h3><p>由于我们这次用的是CLI，所以必须手动安装Gradle。<br>以我用的MacOS为例，打开terminal，run</p><pre class="line-numbers language-shell"><code class="language-shell">$ brew install gradle<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装前必须确保安装了<code>jdk1.7</code>以上版本（我用的Gradle 4.1版本的要求），其它系统用户可以参考<a href="https://gradle.org/install/" target="_blank" rel="noopener">Installation</a></p><p>然后run，若已成功安装可以看到</p><pre class="line-numbers language-shell"><code class="language-shell">$ gradle --version------------------------------------------------------------Gradle 4.1------------------------------------------------------------Build time:   2017-08-07 14:38:48 UTCRevision:     941559e020f6c357ebb08d5c67acdb858a3defc2Groovy:       2.4.11Ant:          Apache Ant(TM) version 1.9.6 compiled on June 29 2015JVM:          1.8.0_121 (Oracle Corporation 25.121-b13)OS:           Mac OS X 10.12.4 x86_64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h3><p>创建一个空文件夹作为工程目录，同时创建一个build.gradle空文件</p><pre class="line-numbers language-shell"><code class="language-shell">$ mkdir gradle_cli$ cd gradle_cli$ touch build.gradle<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后执行以下命令生成Gradle Wrapper</p><pre class="line-numbers language-shell"><code class="language-shell">$ gradle wrapper<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以看到当前目录的变化</p><pre class="line-numbers language-shell"><code class="language-shell">$ tree ..├── build.gradle├── gradle│   └── wrapper│       ├── gradle-wrapper.jar│       └── gradle-wrapper.properties├── gradlew└── gradlew.bat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在可以通过wrapper脚本来执行各项任务，这样可以确保在更换了环境后依然能使用创建项目时使用的Gradle版本进行构建。</p><p>查看properties信息（以下输出做了大量删减）</p><pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew properties> Task :properties------------------------------------------------------------Root project------------------------------------------------------------allprojects: [root project 'gradle_cli']ant: org.gradle.api.internal.project.DefaultAntBuilder@70e298ee……buildDir: /Users/tac/Documents/studyspace/src/java/gradle_cli/buildbuildFile: /Users/tac/Documents/studyspace/src/java/gradle_cli/build.gradlebuildScriptSource: org.gradle.groovy.scripts.UriScriptSource@460e8e7a……depth: 0description: nulldisplayName: root project 'gradle_cli'……gradle: build 'gradle_cli'group:……plugins: [org.gradle.api.plugins.HelpTasksPlugin@23fb712b]……project: root project 'gradle_cli'……projectDir: /Users/tac/Documents/studyspace/src/java/gradle_cli……repositories: repository containerresources: org.gradle.api.internal.resources.DefaultResourceHandler@7cad9556rootDir: /Users/tac/Documents/studyspace/src/java/gradle_clirootProject: root project 'gradle_cli'……state: project state 'EXECUTED'status: releasesubprojects: []tasks: task setversion: unspecified<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到其中大多数属性都已经有了默认的值，这也恰好验证了Gradle约定优于配置的原则。<br>如果我们需要修改一些属性值，可以通过写build.gradle文件来进行配置</p><pre class="line-numbers language-groovy"><code class="language-groovy">description <span class="token operator">=</span> <span class="token string">'A Gradle build project for CLI'</span>version <span class="token operator">=</span> <span class="token string">'1.0'</span>group <span class="token operator">=</span> <span class="token string">'cn.tac.test'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>再次查看properties可以看到属性已经更改了</p><pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew properties | grep -E "group|description|version"description: A Gradle build project for CLIgroup: cn.tac.testversion: 1.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>tip</strong></p><ul><li>你也可以先生成Wrapper再创建build.gradle，并不会有影响</li><li>除了手动创建之外，还可以通过<code>gradle init</code>指令来初始化项目。初始化的内容包括执行gradle wrapper，以及自动生成build.gradle和settings.gradle，并且生成的文件里面已经有了一些自动生成的配置（默认是注释状态，即未启用）。</li></ul><h3 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h3><p>由于我们是手动创建的空build.gradle，要构建java项目，我们还需要做一些简单的配置。<br>在build.gradle加入目标工程语言（上面提过，Gradle是支持多语言的）及版本、依赖及下载依赖的仓库的配置</p><pre class="line-numbers language-groovy"><code class="language-groovy">apply plugin<span class="token punctuation">:</span> <span class="token string">'java'</span>sourceCompatibility <span class="token operator">=</span> <span class="token number">1.8</span>repositories <span class="token punctuation">{</span>    <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>dependencies <span class="token punctuation">{</span>    testCompile group<span class="token punctuation">:</span> <span class="token string">'junit'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'junit'</span><span class="token punctuation">,</span> version<span class="token punctuation">:</span> <span class="token string">'4.12'</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>tips</strong></p><ul><li>可以通过<code>dependencies</code>任务查看当前项目的依赖信息。</li></ul><h3 id="Hello-World-1"><a href="#Hello-World-1" class="headerlink" title="Hello World"></a>Hello World</h3><p>配置好环境后，我们创建源码目录及单元测试类</p><pre class="line-numbers language-shell"><code class="language-shell">$ mkdir -p src/main/java src/main/resources src/test/java src/test/resources$ cd src/test/java$ mkdir -p cn/tac/test$ cd cn/tac/test$ touch HelloWorld.java<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后执行构建，如果不知道有哪些tasks可以执行，可以通过以下命令来查看</p><pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew tasks> Task :tasks------------------------------------------------------------All tasks runnable from root project - A Gradle build project for CLI------------------------------------------------------------Build tasks-----------assemble - Assembles the outputs of this project.build - Assembles and tests this project.……Build Setup tasks-----------------init - Initializes a new Gradle build.wrapper - Generates Gradle wrapper files.Documentation tasks-------------------javadoc - Generates Javadoc API documentation for the main source code.Help tasks----------……Verification tasks------------------check - Runs all checks.test - Runs the unit tests.Rules-----……<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>完了可以看见项目根目录下多了一个build目录，里面的内容就是执行构建的产物。与Maven不同的是，有个reports目录是Gradle生成的HTML格式的构建报告，可以通过浏览器打开查看<br><img src="/images/gradle_build_reports.jpg" alt="build reports"></p><p><strong>tip</strong></p><ul><li>有没有发现sh gradlew tasks出来的列表有点像IDEA Gradle Project面板上的tasks节点？😃</li><li>在项目根目录下使用gradle跟gradlew执行task的效果基本是一样的，区别在于gradle会使用本地安装的Gradle版本进行构建，而gradlew会使用创建项目时使用的gradle版本进行构建，如果本地没有搜索到这个版本，则会自动下载</li></ul>]]></content>
      
      <categories>
          
          <category> java </category>
          
          <category> gradle </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>解释器模式实践</title>
      <link href="/interpreter_pattern_in_action.html"/>
      <url>/interpreter_pattern_in_action.html</url>
      <content type="html"><![CDATA[<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/taccisum/interpreter_pattern" target="_blank" rel="noopener">Github</a></p><h2 id="关于解释器模式"><a href="#关于解释器模式" class="headerlink" title="关于解释器模式"></a>关于解释器模式</h2><p>解释器模式是行为型模式的一种，关于解释器模式的定义从网上摘抄了一段</p><blockquote><p>给定一种语言，并定义代表其文法的相应解释器，并用该解释器来解析使用该语言的编写的内容<br><a href="http://java-design-patterns.com/patterns/interpreter/" target="_blank" rel="noopener">JAVA Design pattern</a></p></blockquote><p>其中的关键字有，<code>语言文法</code>、<code>解释器</code>。</p><ul><li>语言文法，如：下面要提到的<code>四则运算表达式</code>、我们日常使用的各种<code>编程语言</code>、类英语语法的<code>SQL</code>语言、一些框架里面的特定语言（如Spring的SpEL）等等，都是具有固定文法的语言，这意味着这些语言均可以用解释器模式来解析。当然，除此之外你也可以根据你的需求自己创造一种语言。</li><li>解释器，用于让计算机『认识』这些语言的工具，需要由我们程序员编码实现。越复杂的语言文法，其相应的解释器实现难度越大，比如人类的『自然语言』。</li></ul><h2 id="UML图"><a href="#UML图" class="headerlink" title="UML图"></a>UML图</h2><blockquote><p><img src="http://java-design-patterns.com/patterns/interpreter/etc/interpreter_1.png" alt=""><br><a href="http://java-design-patterns.com/patterns/interpreter/" target="_blank" rel="noopener">JAVA Design pattern</a></p></blockquote><p>其实并不算复杂（因为解释器模式最复杂的部分在于将语言解析为对象的过程，稍后的实践中可以看到），跟组合模式的UML图有点相像（同为树型数据结构），下面是两个比较重要的类：</p><p><strong>NumberExpression</strong>: 数值表达式（也称<code>终结点表达式</code>，意为表达式解析的终结点，可以简单理解为树型结构的叶子节点），执行interpret()一般会得到一个常量供复合表达式计算</p><p><strong>MultiplyExpression</strong>: 复合表达式（也称<code>非终结点表达式</code>，可以简单理解为树型结构的枝节点），一般包括一个或多个Expression类型的子节点，子节点数即代表该复合表达式的操作数数量，执行interpret()一般会得到其子节点互相作用后的结果</p><h2 id="编码实践"><a href="#编码实践" class="headerlink" title="编码实践"></a>编码实践</h2><p>为了节省篇幅，这里只贴出部分重要代码，完整代码可从开头的源码地址下载。</p><h3 id="简单四则运算"><a href="#简单四则运算" class="headerlink" title="简单四则运算"></a>简单四则运算</h3><h4 id="单元测试类"><a href="#单元测试类" class="headerlink" title="单元测试类"></a>单元测试类</h4><pre class="line-numbers language-text"><code class="language-text">cn.tac.test.interpreter.arithmetic.simple.SimpleCalculatorTest<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h4><p>支持最简单的四则运算，不支持括弧运算，不支持优先级运算符。因为语言文法较简单，所以解析器较易实现，适合作为Hello World。</p><h4 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h4><p><strong>Node</strong>: 即Expression</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> <span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>ValueNode</strong>: 即NumberExpression，代表操作数</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ValueNode</span> <span class="token keyword">implements</span> <span class="token class-name">Node</span><span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ValueNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>SymbolNode</strong>: 即MultiplyExpression，代表运算符（如+-*/），因为均为<code>二元操作符</code>，所以只有两个子节点</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SymbolNode</span> <span class="token keyword">implements</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>    <span class="token keyword">protected</span> Node left<span class="token punctuation">;</span>    <span class="token keyword">protected</span> Node right<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">SymbolNode</span><span class="token punctuation">(</span>Node left<span class="token punctuation">,</span> Node right<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> left<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> right<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>SimpleValueNode</strong>: 简单地返回数值本身</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleValueNode</span> <span class="token keyword">extends</span> <span class="token class-name">ValueNode</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">SimpleValueNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> value<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>运算符节点</strong>: 代表+-*/</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlusNode</span> <span class="token keyword">extends</span> <span class="token class-name">SymbolNode</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">PlusNode</span><span class="token punctuation">(</span>Node left<span class="token punctuation">,</span> Node right<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> left<span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> right<span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MinusNode</span> extend SymbolNode<span class="token punctuation">{</span>……<span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MulNode</span> extend SymbolNode<span class="token punctuation">{</span>……<span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DivNode</span> extend SymbolNode<span class="token punctuation">{</span>……<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Parser</strong>:</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Parser</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SPLITTER <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//为了方便解析，用空格将表达式分隔开</span>    <span class="token keyword">public</span> Node <span class="token function">parse</span><span class="token punctuation">(</span>String statement<span class="token punctuation">)</span> <span class="token punctuation">{</span>        String<span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>SPLITTER<span class="token punctuation">)</span><span class="token punctuation">;</span>        LinkedList<span class="token operator">&lt;</span>Node<span class="token operator">></span> nodeStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> symbolFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        String symbol <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>String item <span class="token operator">:</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbolNode</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                symbol <span class="token operator">=</span> item<span class="token punctuation">;</span>                symbolFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValueNode</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                nodeStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleValueNode</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>symbolFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Node right <span class="token operator">=</span> nodeStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//后入先出</span>                    Node left <span class="token operator">=</span> nodeStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    nodeStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">mapSymbolNode</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    symbolFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                                    <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"表达式格式有误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> nodeStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    ……<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Calculator</strong>: </p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleCalculator</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">calculate</span><span class="token punctuation">(</span>String statement<span class="token punctuation">)</span><span class="token punctuation">{</span>        Parser parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="Parser解析过程"><a href="#Parser解析过程" class="headerlink" title="Parser解析过程"></a>Parser解析过程</h5><ol><li>将表达式分割为数组，并遍历</li><li>从数组中获取一个元素，若为数值，则直接转换为节点并入栈；若为运算符，则只进行标记，等待下一个节点入栈后，将其与上一个节点一同取出，并合并为一个复合表达式节点入栈；</li><li>反复执行步骤2，直到数组末尾</li><li>将栈中的元素pop并返回（如果表达式无误，最终栈中应该只有一个元素，否则应该在解析过程中抛出异常）</li></ol><h3 id="完整四则运算"><a href="#完整四则运算" class="headerlink" title="完整四则运算"></a>完整四则运算</h3><h4 id="单元测试类-1"><a href="#单元测试类-1" class="headerlink" title="单元测试类"></a>单元测试类</h4><pre class="line-numbers language-java"><code class="language-java">cn<span class="token punctuation">.</span>tac<span class="token punctuation">.</span>test<span class="token punctuation">.</span>interpreter<span class="token punctuation">.</span>arithmetic<span class="token punctuation">.</span>full<span class="token punctuation">.</span>FullCalculatorTestcn<span class="token punctuation">.</span>tac<span class="token punctuation">.</span>test<span class="token punctuation">.</span>interpreter<span class="token punctuation">.</span>arithmetic<span class="token punctuation">.</span>full<span class="token punctuation">.</span>ParserTest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="实现效果-1"><a href="#实现效果-1" class="headerlink" title="实现效果"></a>实现效果</h4><p>支持完整的四则运算，包括括弧运算，优先级运算。由于相较于上一个实践文法上复杂了许多，不能用同样的方式直接解析，而是应该先转换为<code>后缀表达式</code>再进行解析。</p><h4 id="后缀表达式"><a href="#后缀表达式" class="headerlink" title="后缀表达式"></a>后缀表达式</h4><p>// todo::</p><h4 id="相关类-1"><a href="#相关类-1" class="headerlink" title="相关类"></a>相关类</h4><p><strong>节点</strong><br>值节点和运算符节点类仍采用和上个实践相同的类。</p><p><strong>Parser</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Parser</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SPLITTER <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> Node <span class="token function">parse</span><span class="token punctuation">(</span>String statement<span class="token punctuation">)</span> <span class="token punctuation">{</span>        LinkedList<span class="token operator">&lt;</span>Node<span class="token operator">></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String<span class="token punctuation">[</span><span class="token punctuation">]</span> segments <span class="token operator">=</span> <span class="token function">convert2Postfix</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>SPLITTER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>String segment <span class="token operator">:</span> segments<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValueNode</span><span class="token punctuation">(</span>segment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleValueNode</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>segment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOperator</span><span class="token punctuation">(</span>segment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Node rightNode <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Node leftNode <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">doOperate</span><span class="token punctuation">(</span>leftNode<span class="token punctuation">,</span> rightNode<span class="token punctuation">,</span> segment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">convert2Postfix</span><span class="token punctuation">(</span>String statement<span class="token punctuation">)</span> <span class="token punctuation">{</span>        LinkedList<span class="token operator">&lt;</span>String<span class="token operator">></span> symbolStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//临时存放符号节点的栈</span>        LinkedList<span class="token operator">&lt;</span>String<span class="token operator">></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String<span class="token punctuation">[</span><span class="token punctuation">]</span> nodes <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>SPLITTER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>String node <span class="token operator">:</span> nodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbolNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token string">"("</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    symbolStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOperator</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    String topSymbol <span class="token operator">=</span> symbolStack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">priority</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token function">priority</span><span class="token punctuation">(</span>topSymbol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">while</span> <span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">priority</span><span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">priority</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token keyword">break</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                    symbolStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">")"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"("</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    symbolStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"不支持的运算符"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValueNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"不支持的运算符"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//到数组尾部后，还有一些符号在栈内</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String tmp<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isNull</span><span class="token punctuation">(</span>tmp <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pollLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>SPLITTER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    ……<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Calculator</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FullCalculator</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">calculate</span><span class="token punctuation">(</span>String statement<span class="token punctuation">)</span><span class="token punctuation">{</span>        Parser parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="Parser解析过程-1"><a href="#Parser解析过程-1" class="headerlink" title="Parser解析过程"></a>Parser解析过程</h5><p>主要分为两大步骤<br><strong>一、将中缀表达式转换为后缀表达式</strong></p><ol><li>将表达式分割为数组，并遍历</li><li>从数组中获取一个元素<ul><li>若为数值，则直接入存放结果的栈，以下简称<code>结果栈</code></li><li>若为符号，则判断<ul><li>若符号栈目前为空，或该符号为左括弧”(“，则直接入临时存放符号的栈，以下简称<code>符号栈</code></li><li>若当前符号为操作符（+-*/，不包括括弧），则从符号栈peek（<em>不是pop</em>）一个符号，比如两者优先级，若 当前符号优先级&lt;=从栈顶取出的符号优先级，则从符号栈pop一个符号并push至结果栈，直至 符号栈为空 or 栈顶符号优先级&lt;=当前符号优先级，然后将当前符号入符号栈。<em>这里需要注意的是，左右括弧也有优先级，且优先级应小于操作符，否则在这里需要单独处理pop时遇到左括弧的问题</em></li><li>若为右括弧”)”，则将符号栈pop符号并push至结果栈，直到遇到左括弧（遇到后pop并丢弃）</li></ul></li></ul></li><li>反复执行步骤2，直到数组末尾</li><li>到数组尾部后，多数情况都会有一些符号还留在符号栈内，应将其取出并push至结果栈</li><li>将结果栈构建为字符串，并返回</li></ol><p><strong>二、将后缀解析为java对象</strong></p><ol><li>将表达式分割为数组，并遍历</li><li>从数组中获取一个元素，若为数值，则直接转换成数值节点并入栈；若为操作符（转换成后缀表达式后已经没有括弧了），则从栈顶取出两个节点，并合并为一个复合表达式节点并入栈</li><li>反复执行步骤2，直到数组末尾</li><li>将栈中的元素pop并返回（如果表达式无误，最终栈中应该只有一个元素，否则应该在解析过程中抛出异常）</li></ol><p>当然，你也可以将这两个步骤合二为一，在转换的同时将其转换为java对象，但非实际应用中个人还是建议将两个步骤分离，原因有二：</p><ul><li>降低编码的复杂度</li><li>方便进行单元测试（尤其是将后缀表达式转换为中缀表达式的步骤，比较容易出错）</li></ul>]]></content>
      
      <categories>
          
          <category> java </category>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>关于java</title>
      <link href="/about_java.html"/>
      <url>/about_java.html</url>
      <content type="html"><![CDATA[<h2 id="java体系"><a href="#java体系" class="headerlink" title="java体系"></a>java体系</h2><blockquote><p>java不仅仅是一门编程语言，还是由一系列计算机软件和规范形成的技术体系。<br>这个体系提供了完整的用于软件开发和跨平台部署的支持环境。</p></blockquote><p><strong>Sun官方定义的java技术体系包括以下内容</strong>：  </p><ol><li>java程序设计语言</li><li>各硬件平台上的java虚拟机（jvm）</li><li>Class文件格式</li><li>java api类库</li><li>来自商业机构和开源社区的第三方类库</li></ol><p>以上1、2、4点统称为jdk，jdk是支持java程序开发的最小环境.<br>java api中的java se api子集和java虚拟机统称为jre，jre是java程序运行的最小环境.</p><p>java除了一门优秀的编程语言外，还有许多不可忽视的优点：</p><ul><li>摆脱硬件平台束缚，实现跨平台</li><li>内存管理，避免绝大部分内存泄露和指针越界问题</li><li>热点代码检测和运行时编译及优化</li><li>完善的应用程序编程接口及丰富、优秀的第三方类库</li></ul><p>java技术体系按照所服务的领域来划分，可以分为四大模块：<code>java card</code> <code>java se</code> <code>java me</code> <code>java ee</code></p><h2 id="jdk发展史"><a href="#jdk发展史" class="headerlink" title="jdk发展史"></a>jdk发展史</h2><p>java语言前身：oak</p><ul><li>1995年，oak更名为java，同时sun正式提出”write once, run anywhere”的口号，标识着java正式诞生</li><li>1996年，jdk1.0发布，并提供了一个纯解释性的java虚拟机（Sun Classic VM）</li><li>1997年，jdk1.l发布，代表技术有：jdbc, rmi, java beans, .jar文件等</li><li>1998年，jdk1.2发布，正式把java技术体系划分为3个方向：java se, java me, java ee，代表技术较多，如ejb, java pluin-in, swing等。java虚拟机中第一次内置了jit编译器，且附带了HotSpot作为备选</li><li>2000年，jdk1.3发布，将HotSpot作为默认虚拟机，并提供jndi作为平台级服务，从此后Sun公司基本保持两年一个主版本的更新速度</li><li>2002年，jdk1.4发布，标志着java正式走向成熟，代表技术有：正则表达式、异常链、nio、日志类、xml解析器等等</li><li>2004年，jdk1.5(jdk5)发布，主要是对java语言的易用性方面做了改进</li><li>2006年，jdk1.6(jdk6)发布，除了改进之外，Sun正式将java开源（GPL协议），并建立了OpenJDK组织对其进行管理<br>jdk1.7(jdk7)开发，Sun公司由于各种原因，最终无法按计划完成。2009年Oracle公司将其收购后，对jdk1.7的内容进行大幅度裁剪，并把剩余内容延迟到jdk1.8中。jdk1.7于2011年正式发布</li><li>2013年，jdk1.8(jdk8)发布，加入了lambda表达式及函数式接口等支持</li></ul><h2 id="部分jvm介绍"><a href="#部分jvm介绍" class="headerlink" title="部分jvm介绍"></a>部分jvm介绍</h2><ul><li><p>Sun Classic VMr</p><ul><li>Classic VM是Sun公司发布的第一款商用java虚拟机，作为默认虚拟机与jdk1.0绑定发布，技术较为原始</li><li>在jdk1.2之前都是唯一存在的虚拟机</li><li>只能使用纯解释器方式来运行java程序</li><li>如果要使用JIT编译器，必须外挂</li></ul></li><li><p>Exact VM</p><ul><li>为了解决Classic VM存在的各种问题而开发，在jdk1.2期间发布</li><li>具备了现代高性能虚拟机的原型</li><li>在商用只存在了短暂的时间后，即被更为优秀的HotSpot取代</li></ul></li><li><p>Sun HotSpot VM</p><ul><li>是SunJDK及OpenJDK中所带的虚拟机，也是目前使用最广的虚拟机</li><li>最初是由一家名为”Longview Teconologies”的小公司设计，在1997年该公司被Sun收购</li><li>其即有Sun之前两款虚拟机的优点，也有许多自身的技术优势如热点代码探测能力</li></ul></li><li><p>Sun Mobile-Embedded VM/Meta-Circular VM</p><ul><li>Sun公司针对移动和嵌入式市场的虚拟机</li></ul></li><li><p>BEA JRockit</p><ul><li>一款专门为服务端硬件和服务端应用场景而专门优化的虚拟机</li><li>不关注应用程序的启动速度，因而其内部不含解析器的实现，全部代码靠JIT编译运行</li><li>除此之外，其垃圾收集器和MissionControl等服务套件的实现也一直在众多虚拟机中保持领先的水平</li></ul></li><li><p>IBM J9 VM</p></li><li>Azul VM/BEA Liquid VM</li><li>Apache Harmony/Google Android Dalvik VM</li><li>Microsoft JVM</li></ul>]]></content>
      
      <categories>
          
          <category> java </category>
          
          <category> jvm </category>
          
      </categories>
      
      
    </entry>
    
  
  
</search>
