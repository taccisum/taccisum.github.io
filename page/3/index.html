<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="el psy congroo.">
<meta property="og:type" content="website">
<meta property="og:title" content="taccisum 😉">
<meta property="og:url" content="https://taccisum.github.io/page/3/index.html">
<meta property="og:site_name" content="taccisum 😉">
<meta property="og:description" content="el psy congroo.">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="taccisum 😉">
<meta name="twitter:description" content="el psy congroo.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://taccisum.github.io/page/3/"/>





  <title>taccisum 😉</title>
  














<link rel="stylesheet" href="/css/prism-ghcolors.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">taccisum 😉</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/instantiationexception_on_mybatistest.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taccisum 😉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/instantiationexception_on_mybatistest.html" itemprop="url">在@MybatisTest中使用通用Mapper出现InstantiationException的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-15T11:42:36+08:00">
                2017-11-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/踩坑日记/" itemprop="url" rel="index">
                    <span itemprop="name">踩坑日记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在Spring Boot环境中使用<a href="http://www.mybatis.org/spring-boot-starter/mybatis-spring-boot-test-autoconfigure/" target="_blank" rel="noopener">@MybatisTest</a>注解针对Mapper写单元测试的时候，由于同时引入了<a href="https://github.com/abel533/Mapper" target="_blank" rel="noopener">通用Mapper</a>，在单元测试中调用通用Mapper的方法进行CRUD时会出现<code>InstantiationException</code>异常</p>
<pre class="line-numbers language-java"><code class="language-java">org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>MyBatisSystemException<span class="token operator">:</span> nested exception is org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>BuilderException<span class="token operator">:</span> Error invoking SqlProvider <span class="token function">method</span> <span class="token punctuation">(</span>tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseSelectProvider<span class="token punctuation">.</span>dynamicSQL<span class="token punctuation">)</span><span class="token punctuation">.</span>  Cause<span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>InstantiationException<span class="token operator">:</span> tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseSelectProvider

    at org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>MyBatisExceptionTranslator<span class="token punctuation">.</span><span class="token function">translateExceptionIfPossible</span><span class="token punctuation">(</span>MyBatisExceptionTranslator<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">77</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>SqlSessionTemplate$SqlSessionInterceptor<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>SqlSessionTemplate<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">446</span><span class="token punctuation">)</span>
    at com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>$Proxy89<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>Unknown Source<span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>SqlSessionTemplate<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>SqlSessionTemplate<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">166</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>MapperMethod<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>MapperMethod<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">82</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>MapperProxy<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>MapperProxy<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">59</span><span class="token punctuation">)</span>
    at com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>$Proxy91<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>Unknown Source<span class="token punctuation">)</span>
    at com<span class="token punctuation">.</span>ikentop<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>hh<span class="token punctuation">.</span>ImageRecordMapperTest<span class="token punctuation">.</span><span class="token function">testSimply</span><span class="token punctuation">(</span>ImageRecordMapperTest<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">33</span><span class="token punctuation">)</span>
    at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>NativeMethodAccessorImpl<span class="token punctuation">.</span><span class="token function">invoke0</span><span class="token punctuation">(</span>Native Method<span class="token punctuation">)</span>
    at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>NativeMethodAccessorImpl<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>NativeMethodAccessorImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">62</span><span class="token punctuation">)</span>
    at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>DelegatingMethodAccessorImpl<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>DelegatingMethodAccessorImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>
    at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>Method<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">498</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FrameworkMethod$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">runReflectiveCall</span><span class="token punctuation">(</span>FrameworkMethod<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ReflectiveCallable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ReflectiveCallable<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FrameworkMethod<span class="token punctuation">.</span><span class="token function">invokeExplosively</span><span class="token punctuation">(</span>FrameworkMethod<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">47</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>InvokeMethod<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>InvokeMethod<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>RunBeforeTestMethodCallbacks<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>RunBeforeTestMethodCallbacks<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">75</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>RunAfterTestMethodCallbacks<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>RunAfterTestMethodCallbacks<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">86</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>SpringRepeat<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>SpringRepeat<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">84</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token punctuation">.</span><span class="token function">runLeaf</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">325</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span><span class="token function">runChild</span><span class="token punctuation">(</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">252</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span><span class="token function">runChild</span><span class="token punctuation">(</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">94</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner$<span class="token number">3</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">290</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">71</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token punctuation">.</span><span class="token function">runChildren</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">288</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token punctuation">.</span>access$<span class="token function">000</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">58</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner$<span class="token number">2</span><span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">268</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>RunBeforeTestClassCallbacks<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>RunBeforeTestClassCallbacks<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">61</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>RunAfterTestClassCallbacks<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>RunAfterTestClassCallbacks<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">70</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">363</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">191</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span>JUnitCore<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>JUnitCore<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">137</span><span class="token punctuation">)</span>
    at com<span class="token punctuation">.</span>intellij<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>JUnit4IdeaTestRunner<span class="token punctuation">.</span><span class="token function">startRunnerWithArgs</span><span class="token punctuation">(</span>JUnit4IdeaTestRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">68</span><span class="token punctuation">)</span>
    at com<span class="token punctuation">.</span>intellij<span class="token punctuation">.</span>rt<span class="token punctuation">.</span>execution<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>IdeaTestRunner$Repeater<span class="token punctuation">.</span><span class="token function">startRunnerWithArgs</span><span class="token punctuation">(</span>IdeaTestRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">51</span><span class="token punctuation">)</span>
    at com<span class="token punctuation">.</span>intellij<span class="token punctuation">.</span>rt<span class="token punctuation">.</span>execution<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>JUnitStarter<span class="token punctuation">.</span><span class="token function">prepareStreamsAndStart</span><span class="token punctuation">(</span>JUnitStarter<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">237</span><span class="token punctuation">)</span>
    at com<span class="token punctuation">.</span>intellij<span class="token punctuation">.</span>rt<span class="token punctuation">.</span>execution<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>JUnitStarter<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>JUnitStarter<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">70</span><span class="token punctuation">)</span>
Caused by<span class="token operator">:</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>BuilderException<span class="token operator">:</span> Error invoking SqlProvider <span class="token function">method</span> <span class="token punctuation">(</span>tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseSelectProvider<span class="token punctuation">.</span>dynamicSQL<span class="token punctuation">)</span><span class="token punctuation">.</span>  Cause<span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>InstantiationException<span class="token operator">:</span> tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseSelectProvider
    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ProviderSqlSource<span class="token punctuation">.</span><span class="token function">createSqlSource</span><span class="token punctuation">(</span>ProviderSqlSource<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">103</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ProviderSqlSource<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>ProviderSqlSource<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">73</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span>MappedStatement<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>MappedStatement<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">292</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>CachingExecutor<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>CachingExecutor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">81</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>DefaultSqlSession<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>DefaultSqlSession<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">148</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>DefaultSqlSession<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>DefaultSqlSession<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">141</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>DefaultSqlSession<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>DefaultSqlSession<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">77</span><span class="token punctuation">)</span>
    at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>NativeMethodAccessorImpl<span class="token punctuation">.</span><span class="token function">invoke0</span><span class="token punctuation">(</span>Native Method<span class="token punctuation">)</span>
    at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>NativeMethodAccessorImpl<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>NativeMethodAccessorImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">62</span><span class="token punctuation">)</span>
    at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>DelegatingMethodAccessorImpl<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>DelegatingMethodAccessorImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>
    at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>Method<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">498</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>SqlSessionTemplate$SqlSessionInterceptor<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>SqlSessionTemplate<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">433</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">34</span> more
Caused by<span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>InstantiationException<span class="token operator">:</span> tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseSelectProvider
    at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Class<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>Class<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">427</span><span class="token punctuation">)</span>
    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ProviderSqlSource<span class="token punctuation">.</span><span class="token function">createSqlSource</span><span class="token punctuation">(</span>ProviderSqlSource<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">85</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">45</span> more
Caused by<span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>NoSuchMethodException<span class="token operator">:</span> tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseSelectProvider<span class="token punctuation">.</span>&lt;init<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Class<span class="token punctuation">.</span><span class="token function">getConstructor0</span><span class="token punctuation">(</span>Class<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3082</span><span class="token punctuation">)</span>
    at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Class<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>Class<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">412</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">46</span> more
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>单元测试代码如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@MybatisTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ImageRecordMapperTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> ImageRecordMapper mapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ImageRecord record <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"taccisum"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"image1"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"hash1"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="分析原因"><a href="#分析原因" class="headerlink" title="分析原因"></a>分析原因</h2><p>在github上mapper的<a href="https://github.com/abel533/MyBatis-Spring-Boot/issues/34" target="_blank" rel="noopener">issue</a>中有一段作者的回复，说此异常是由于<code>通用方法没有被正确初始化</code>导致。<br>我这边的情况虽然和这个issue不同，但根本原因是一样的。<br>查阅<code>Mybatis-Test</code>的文档可知，<code>@MybatisTest</code>注解不同于<code>@SpringBootTest</code>，它只加载保证Mybatis正常运行所需要的configuration。显然通用Mapper作为Mybatis第三方的扩展，并没有被纳入其中，因而默认情况下通用Mapper的starter是不会被加载的，也就导致通用方法不会被初始化。</p>
<blockquote>
<p>The @MybatisTest can be used if you want to test MyBatis components(Mapper interface and SqlSession). By default it will configure MyBatis(MyBatis-Spring) components(SqlSessionFactory and SqlSessionTemplate), configure MyBatis mapper interfaces and configure an in-memory embedded database. MyBatis tests are transactional and rollback at the end of each test by default, for more details refer to the relevant section in the Spring Reference Documentation. Also regular @Component beans will not be loaded into the ApplicationContext.<br>以上是来自<a href="http://www.mybatis.org/spring-boot-starter/mybatis-spring-boot-test-autoconfigure/" target="_blank" rel="noopener">mybatis-spring-boot-test-autoconfigure</a>官方文档的描述</p>
</blockquote>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>显然，只要让Mapper的starter在MybatisTest的单元测试启动时得以加载即可解决我们的问题。那么如何做呢？<br>Spring Boot提供了一个<code>@ImportAutoConfiguration</code>的注解，因此只需要在单元测试的目标类上使用该注解将MapperAutoConfiguration导入即可</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ImportAutoConfiguration</span><span class="token punctuation">(</span>MapperAutoConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@MybatisTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ImageRecordMapperTest</span> <span class="token punctuation">{</span>
    ……
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中<code>MapperAutoConfiguration</code>是通用Mapper的starter的auto-configure类。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/learn_gradle_5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taccisum 😉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/learn_gradle_5.html" itemprop="url">Gradle学习（五） - 打包发布</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-13T11:32:20+08:00">
                2017-10-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/gradle/" itemprop="url" rel="index">
                    <span itemprop="name">gradle</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="发布到Maven仓库"><a href="#发布到Maven仓库" class="headerlink" title="发布到Maven仓库"></a>发布到Maven仓库</h2><h3 id="Maven-Publish插件"><a href="#Maven-Publish插件" class="headerlink" title="Maven-Publish插件"></a>Maven-Publish插件</h3><p>Gradle将项目发布到Maven仓库需要借助插件，<code>Maven-Publish</code>便是官方推荐的一款插件。<br><a href="https://docs.gradle.org/current/userguide/publishing_maven.html" target="_blank" rel="noopener">Maven-Publish</a></p>
<h3 id="发布项目"><a href="#发布项目" class="headerlink" title="发布项目"></a>发布项目</h3><p>通过<code>&#39;maven-publish&#39;</code>引入插件<br><strong>build.gradle</strong></p>
<pre class="line-numbers language-groovy"><code class="language-groovy">apply plugin<span class="token punctuation">:</span> <span class="token string">'maven-publish'</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="发布到本地"><a href="#发布到本地" class="headerlink" title="发布到本地"></a>发布到本地</h4><p><strong>build.gradle</strong></p>
<pre class="line-numbers language-groovy"><code class="language-groovy">apply plugin<span class="token punctuation">:</span> <span class="token string">'java'</span>
apply plugin<span class="token punctuation">:</span> <span class="token string">'maven-publish'</span>

group <span class="token operator">=</span> <span class="token string">'cn.tac.test'</span>
version <span class="token operator">=</span> <span class="token string">'1.0'</span>

publishing <span class="token punctuation">{</span>
    publications <span class="token punctuation">{</span>
        <span class="token function">mavenJava</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            from components<span class="token operator">.</span>java
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
publishing <span class="token punctuation">{</span>
    repositories <span class="token punctuation">{</span>
        maven <span class="token punctuation">{</span>
            url <span class="token string">"$buildDir/repo"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在以上配置中</p>
<ul>
<li><code>publishing{}</code>是由插件为项目创建的扩展（PublishingExtension类型），这个扩展提供了两个block：<code>publications{}</code>（MavenPublication类型）和<code>repositories{}</code>（MavenArtifactRepository 类型），分别用于配置<code>要发布的内容</code>和<code>目标仓库</code>（均可配置多个）。</li>
<li><code>mavenJava{}</code>被称为发布组件<code>Component</code>，用于配置一项要发布的内容，components.java表示这个组件是通过Java插件添加的<code>java</code>组件，可以简单地理解为就是将当前java项目作为发布内容。</li>
<li><code>maven{}</code>指定了一个要发布的目标仓库，当前指定了当前项目的build目录下的<code>repo</code>目录，即发布到本地</li>
</ul>
<p>执行publishing -&gt; publish，可以看到项目成功发布到了<code>build/repo</code>目录中。<br><img src="/images/gradle_learn/publishing/build_repo.png" alt="build/repo"></p>
<p><strong>tips</strong></p>
<ul>
<li>两个<code>publishing{}</code>块的内容也可以合在一起写</li>
<li>mavenJava只是一个命名，并无特殊含义，你也可以将其更换为别的名称，但不能与其它发布组件名称重复</li>
<li>mavenJava块中还可以配置要发布的artifact的<code>group</code>、<code>id</code>及<code>version</code>，如果不显式指定，则默认采用当前项目的配置</li>
</ul>
<h4 id="发布源码"><a href="#发布源码" class="headerlink" title="发布源码"></a>发布源码</h4><p>在上一步的基础上</p>
<ol>
<li>新增一个用于获取源码的task</li>
<li>配置发布组件，使其发布的同时额外发布一个包含源码的<code>artifact</code></li>
</ol>
<p><strong>build.gradle</strong></p>
<pre class="line-numbers language-groovy"><code class="language-groovy">……
<span class="token comment" spellcheck="true">//这个task可以获取到源码</span>
task <span class="token function">sourceJar</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Jar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    from sourceSets<span class="token operator">.</span>main<span class="token operator">.</span>allJava
<span class="token punctuation">}</span>

publishing <span class="token punctuation">{</span>
    publications <span class="token punctuation">{</span>
        <span class="token function">mavenJava</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ……
            <span class="token comment" spellcheck="true">//配置额外发布的artifact</span>
            artifact sourceJar <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//这个字符串会作为artifact文件的后缀</span>
                classifier <span class="token string">"sources"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行task<br><img src="/images/gradle_learn/publishing/build_repo_with_sources.png" alt="sources"></p>
<h4 id="发布到远程仓库"><a href="#发布到远程仓库" class="headerlink" title="发布到远程仓库"></a>发布到远程仓库</h4><p>只需要修改url指向远程仓库即可。同时由于远程仓库大多需要认证，因此通常需要通过<code>credentials{}</code>指定用户名和密码</p>
<p><strong>build.gradle</strong></p>
<pre class="line-numbers language-groovy"><code class="language-groovy">……
publishing <span class="token punctuation">{</span>
    repositories <span class="token punctuation">{</span>
        maven <span class="token punctuation">{</span>
            url <span class="token string">"http://172.10.10.66:8081/nexus/content/repositories/releases/"</span>
            credentials <span class="token punctuation">{</span>
                username <span class="token operator">=</span> <span class="token string">"admin"</span>
                password <span class="token operator">=</span> <span class="token string">"admin123"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="条件发布"><a href="#条件发布" class="headerlink" title="条件发布"></a>条件发布</h4><p>这点相信会点groovy的同学都不会觉得难，用<code>if/else</code>就可以完成。例如下面的配置实现根据version后缀来决定是发布到<code>snapshots</code>还是<code>releases</code>仓库中</p>
<p><strong>build.gralde</strong></p>
<pre class="line-numbers language-groovy"><code class="language-groovy">……
publishing <span class="token punctuation">{</span>
    repositories <span class="token punctuation">{</span>
        <span class="token keyword">def</span> NEXUS_URL <span class="token operator">=</span> <span class="token string">"http://172.10.10.66:8081/nexus/content/repositories/releases/"</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>project<span class="token operator">.</span>version<span class="token operator">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"SNAPSHOT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            NEXUS_URL <span class="token operator">=</span> <span class="token string">"http://172.10.10.66:8081/nexus/content/repositories/snapshots/"</span>
        <span class="token punctuation">}</span>
        maven <span class="token punctuation">{</span>
            url NEXUS_URL
            credentials <span class="token punctuation">{</span>
                username <span class="token operator">=</span> <span class="token string">"admin"</span>
                password <span class="token operator">=</span> <span class="token string">"admin123"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="发布多项目"><a href="#发布多项目" class="headerlink" title="发布多项目"></a>发布多项目</h4><p>父项目的task执行的同时会执行其所有子项目的同一task（最常见的如build任务），因此多项目发布只需要配置好所有子项目的发布配置即可。</p>
<p><strong>build.gradle</strong></p>
<pre class="line-numbers language-groovy"><code class="language-groovy">subprojects <span class="token punctuation">{</span>
    apply plugin<span class="token punctuation">:</span> <span class="token string">'java'</span>
    apply plugin<span class="token punctuation">:</span> <span class="token string">'maven-publish'</span>

    group <span class="token string">"cn.tac.test"</span>
    version <span class="token string">"1.0-SNAPSHOT"</span>

    <span class="token comment" spellcheck="true">//因为父项目不需要发布，所以只需要配置子项目的发布配置即可</span>
    publishing <span class="token punctuation">{</span>
        publications <span class="token punctuation">{</span>
            <span class="token function">mavenJava</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                from components<span class="token operator">.</span>java
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    publishing <span class="token punctuation">{</span>
        repositories <span class="token punctuation">{</span>
            maven <span class="token punctuation">{</span>
                url <span class="token string">"$buildDir/repo"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行task，可以看到每个子项目都发布到了其对应的<code>build/repo</code>中。</p>
<p><strong>tips</strong></p>
<ul>
<li>如果子模块之间互相有依赖，Gradle发布时会自动解析各模块的先后发布顺序，无需我们自己配置</li>
</ul>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="发布后pom-xml中项目的依赖scope为runtime的问题"><a href="#发布后pom-xml中项目的依赖scope为runtime的问题" class="headerlink" title="发布后pom.xml中项目的依赖scope为runtime的问题"></a>发布后pom.xml中项目的依赖scope为runtime的问题</h4><p>在发布的时候发现，项目中通过complie依赖的第三方库或其它模块，在发布后由Gradle生成的<code>pom.xml</code>文件中，依赖的scope默认变成了<code>runtime</code>，而非我们期望的<code>compile</code></p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
  ……
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>cn.tac.test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>publishing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>cn.tac.test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>module1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了达到期望的效果，只需要在发布配置中通过<code>withXML</code>对pom进行修改即可<br><strong>build.gradle</strong></p>
<pre class="line-numbers language-groovy"><code class="language-groovy">publishing <span class="token punctuation">{</span>
    publications <span class="token punctuation">{</span>
        <span class="token function">mavenJava</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            from components<span class="token operator">.</span>java

            pom<span class="token operator">.</span>withXml <span class="token punctuation">{</span>
                <span class="token function">asNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>dependencies<span class="token operator">.</span><span class="token string">'*'</span><span class="token operator">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    it<span class="token operator">.</span>scope<span class="token operator">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'runtime'</span> <span class="token operator">&amp;&amp;</span> project<span class="token operator">.</span>configurations<span class="token operator">.</span>compile<span class="token operator">.</span>allDependencies<span class="token operator">.</span>find <span class="token punctuation">{</span> dep <span class="token operator">-></span>
                        dep<span class="token operator">.</span>name <span class="token operator">==</span> it<span class="token operator">.</span>artifactId<span class="token operator">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token operator">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    it<span class="token operator">.</span>scope<span class="token operator">*.</span>value <span class="token operator">=</span> <span class="token string">'compile'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>再次发布</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
  ……
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>cn.tac.test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>publishing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>cn.tac.test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>module1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>tips</strong></p>
<ul>
<li>参考链接 <a href="https://stackoverflow.com/questions/31069666/how-to-change-artifactory-runtime-scope-to-compile-scope" target="_blank" rel="noopener">How to change artifactory runtime scope to compile scope?</a></li>
<li><a href="https://docs.gradle.org/current/dsl/org.gradle.api.publish.maven.MavenPom.html#org.gradle.api.publish.maven.MavenPom:withXml(org.gradle.api.Action" target="_blank" rel="noopener">更多withXML的信息</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/know_crawler.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taccisum 😉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/know_crawler.html" itemprop="url">了解爬虫</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-01T23:08:55+08:00">
                2017-10-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/爬虫/" itemprop="url" rel="index">
                    <span itemprop="name">爬虫</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是爬虫"><a href="#什么是爬虫" class="headerlink" title="什么是爬虫"></a>什么是爬虫</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>爬虫（Web Crawler），也叫<code>网络蜘蛛</code>（Splider），是一种用来自动浏览<code>www网页</code>的程序。<br>爬虫一般从一个URL出发，访问所有<code>关联的URL</code>，并从中提取出感兴趣的内容。<br>爬虫访问网站的过程会<code>消耗目标系统资源</code>，所以有不少网络系统并不默许爬虫工作。因此爬虫要考虑到<code>规划</code>、<code>负载</code>，并且要讲『礼貌』（参考<a href="https://zh.wikipedia.org/wiki/Robots.txt" target="_blank" rel="noopener">robots.txt</a>）。</p>
<p><a href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF%E7%88%AC%E8%9F%B2" target="_blank" rel="noopener">网络爬虫</a></p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>爬虫主要有以下应用场景</p>
<ul>
<li>科学研究<blockquote>
<p>如数据挖掘、机器学习、图片处理等</p>
</blockquote>
</li>
<li>Web安全<blockquote>
<p>如使用爬虫对网站是否存在某一漏洞进行批量验证、利用</p>
</blockquote>
</li>
<li>产品研发<blockquote>
<p>如采集各个商城物品价格，为用户提供市场最低价</p>
</blockquote>
</li>
<li>舆情监控<blockquote>
<p>如抓取、分析某社交平台的数据，从而识别出某用户是否为水军</p>
</blockquote>
</li>
<li>搜索引擎<blockquote>
<p>爬虫是搜索引擎的核心组成部分</p>
</blockquote>
</li>
</ul>
<h3 id="爬虫策略"><a href="#爬虫策略" class="headerlink" title="爬虫策略"></a>爬虫策略</h3><p>一个爬虫的实现主要由四大策略组成</p>
<ul>
<li>选择策略<blockquote>
<p>指定页面下载的策略，可细分为<br><code>链接跟随限制</code>，指的是爬虫只搜索特定类型（如HTML）的资源，避免发出过多的请求。或者避免请求一些带有”?”的资源，避免从网站下载无限量的URL<br><code>URL规范化</code>，指的是以某种一致的方式修改和标准化URL的过程，避免资源的重复爬取<br><code>路径上移爬取</code>，指爬取每个URL里提示的每个路径，例如对于”http: //<a href="http://www.tac.cn/a/b/c.html&quot;，还会爬取&quot;/a/b&quot;、&quot;/a&quot;和&quot;/&quot;路径。" target="_blank" rel="noopener">www.tac.cn/a/b/c.html&quot;，还会爬取&quot;/a/b&quot;、&quot;/a&quot;和&quot;/&quot;路径。</a><br><code>主题爬取</code>，指有条件地进行爬取（例如只爬取与python相关的页面）。</p>
</blockquote>
</li>
<li>重新访问策略<blockquote>
<p>网站是经常动态变化的，需要估算URL的<code>新鲜度</code>和<code>过时性</code>，以确保是否需要重新访问。</p>
</blockquote>
</li>
<li>平衡礼貌策略<blockquote>
<p>使用爬虫可能导致一个<code>站点瘫痪</code>，因此爬虫需要遵守一些协议来避免这个问题。</p>
</blockquote>
</li>
<li>并行策略<blockquote>
<p>并行运行<code>多个进程</code>的爬虫时，为了避免重复下载页面，爬虫系统需要策略来处理爬虫运行时新发现的URL。</p>
</blockquote>
</li>
</ul>
<h3 id="简单架构"><a href="#简单架构" class="headerlink" title="简单架构"></a>简单架构</h3><p><img src="/images/crawler_learn/framework.jpg" alt="framework"></p>
<p>如图，一个最简单的爬虫架构至少包括<code>爬虫调度端</code>、<code>URL管理器</code>、<code>网页下载器</code>、<code>网页解析器</code>。这几个模块相互作用，从而提取出<code>有价值的数据</code>。其时序图如下</p>
<p><img src="/images/crawler_learn/sequence_chart.jpg" alt="framework"></p>
<p>爬虫调度器从URL管理器中获取待爬取的URL，交由下载器进行下载。然后将下载器将下载的页面交由解析器进行解析，解析器又反过来将解析到的URL反馈给URL管理器。如此循环往复，直到没有待抓取的URL，则结束爬取。</p>
<p>——以上图片来自慕课网<a href="http://www.imooc.com/learn/563" target="_blank" rel="noopener">Python开发简单爬虫</a></p>
<h3 id="URL管理器"><a href="#URL管理器" class="headerlink" title="URL管理器"></a>URL管理器</h3><p>管理待抓取的URL集合和已抓取的URL集合，防止<code>重复抓取</code>、防止<code>循环抓取</code>。</p>
<p>实现方式</p>
<ul>
<li>内存</li>
<li>关系数据库</li>
<li>NoSQL</li>
</ul>
<h3 id="网页下载器"><a href="#网页下载器" class="headerlink" title="网页下载器"></a>网页下载器</h3><ul>
<li>urllib2 python官方 *</li>
</ul>
<ul>
<li>requests 第三方</li>
</ul>
<p>网页下载分几种场景</p>
<ul>
<li>直接通过url下载</li>
<li>需要添加请求参数，请求头（伪装浏览器）</li>
<li>需要伪装特殊情景，如cookie、proxy、https、http redirect</li>
</ul>
<h3 id="页面解析器"><a href="#页面解析器" class="headerlink" title="页面解析器"></a>页面解析器</h3><p>从网页中提取有价值数据的工具</p>
<p>python的网页解析器</p>
<ul>
<li>正则表达式</li>
<li>html.parser python官方</li>
<li>beautiful soup4 第三方 *</li>
<li>lxml </li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/learn_gradle_4.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taccisum 😉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/learn_gradle_4.html" itemprop="url">Gradle学习（四） - 自定义任务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-30T18:26:51+08:00">
                2017-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/gradle/" itemprop="url" rel="index">
                    <span itemprop="name">gradle</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>草稿</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/learn_gradle_3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taccisum 😉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/learn_gradle_3.html" itemprop="url">Gradle学习（三） - 多项目构建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-30T10:17:25+08:00">
                2017-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/gradle/" itemprop="url" rel="index">
                    <span itemprop="name">gradle</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>从<a href="/2017/09/26/Gradle学习（一）/">第一篇</a>中我们知道了如何构建一个单项目，但仅仅这样是不够的。实现多项目的构建有利于<code>模块化</code>，如此一来我们便能更好地在一个大型项目中分离我们的关注点。</p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><h3 id="创建根项目"><a href="#创建根项目" class="headerlink" title="创建根项目"></a>创建根项目</h3><p>新建一个文件夹作为根项目目录，执行gradle init</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ mkdir multi_project
$ gradle init
$ ls
build.gradle    gradle          gradlew         gradlew.bat     settings.gradle
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这次我们要关注的重点有两个文件</p>
<ul>
<li>build.gradle<blockquote>
<p>配置一些应用于所有子项目的公共配置</p>
</blockquote>
</li>
<li>settings.gradle<blockquote>
<p>描述各项目之间的关系</p>
</blockquote>
</li>
</ul>
<h3 id="创建子项目"><a href="#创建子项目" class="headerlink" title="创建子项目"></a>创建子项目</h3><p>在根目录下分别创建sub-project1和sub-project2目录，然后分别为其创建build.gradle</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ mkdir sub-project1 sub-project2
$ touch sub-project1/build.gradle sub-project2/build.gradle
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后在根项目的settings.gradle中添加下面内容以关联子项目</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">include <span class="token string">'sub-project1'</span>
include <span class="token string">'sub-project2'</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>tips</strong></p>
<ul>
<li>一定要注意子项目只需为其创建build.gradle即可，而非使用gradle init指令初始化，这点很重要</li>
<li>子项目的build.gradle只用于配置该项目特有的一些配置项，公共的配置通过根项目的build.gradle配置</li>
</ul>
<h3 id="公共配置"><a href="#公共配置" class="headerlink" title="公共配置"></a>公共配置</h3><p>在根项目的build.gradle中加入以下内容</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">allprojects<span class="token punctuation">{</span>
    group <span class="token operator">=</span> <span class="token string">'cn.tac'</span>
    version <span class="token operator">=</span> <span class="token string">'0.1'</span>
    repositories<span class="token punctuation">{</span>
        maven <span class="token punctuation">{</span>
            url <span class="token string">'http://maven.aliyun.com/nexus/content/groups/public/'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

subprojects <span class="token punctuation">{</span>
    apply plugin<span class="token punctuation">:</span> <span class="token string">'java'</span>
    sourceCompatibility <span class="token operator">=</span> <span class="token number">1.8</span>
    dependencies <span class="token punctuation">{</span>
        testCompile <span class="token string">'junit:junit:4.12'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>allprojects{}</code> 为所有项目添加配置项，所以group、version、repositories都放在了这个block下</li>
<li><code>subprojects{}</code> 仅仅为当前项目的子项目添加配置项（不包括当前项目本身），所以根项目不需要的内容（如依赖）放在了这个block下</li>
</ul>
<h3 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h3><p>分别为子项目创建src目录</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ mkdir -p sub-project1/src/test/java/cn/tac/gradle sub-project2/src/test/java/cn/tac/gradle
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>并创建单元测试</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>tac<span class="token punctuation">.</span>gradle<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Assert<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Test<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubProject1Test</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello, i'm sub project1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>tac<span class="token punctuation">.</span>gradle<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Assert<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Test<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubProject2Test</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello, i'm sub project2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="执行构建"><a href="#执行构建" class="headerlink" title="执行构建"></a>执行构建</h3><p>完成了上述步骤之后，不出意外此时的目录结构应该如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ tree .
.
├── build.gradle
├── gradle
│   └── wrapper
│       ├── gradle-wrapper.jar
│       └── gradle-wrapper.properties
├── gradlew
├── gradlew.bat
├── settings.gradle
├── sub-project1
│   ├── build.gradle
│   └── src
│       └── test
│           └── java
│               └── cn
│                   └── tac
│                       └── gradle
│                           └── SubProject1Test.java
└── sub-project2
    ├── build.gradle
    └── src
        └── test
            └── java
                └── cn
                    └── tac
                        └── gradle
                            └── SubProject2Test.java
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来我们切换到根目录下，执行</p>
<pre><code>$ sh gradlew build
</code></pre><p>再查看子项目的目录，发现分别多了一个build目录，可见在为根项目执行构建任务时，其include的所有子项目也分别进行了构建。以下分别是两个子项目的build reports<br><img src="/images/gradle_learn/multi_project/subproject1test.png" alt="sub project 1"><br><img src="/images/gradle_learn/multi_project/subproject2test.png" alt="sub project 2"></p>
<h3 id="依赖其它项目"><a href="#依赖其它项目" class="headerlink" title="依赖其它项目"></a>依赖其它项目</h3><p>在<code>dependencies{}</code>中添加依赖即可，例如sub-project2要依赖sub-project1，可以在sub-project2的build.gradle中添加</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">dependencies <span class="token punctuation">{</span>
  compile <span class="token function">project</span><span class="token punctuation">(</span><span class="token string">':sub-project1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/learn_gradle_2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taccisum 😉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/learn_gradle_2.html" itemprop="url">Gradle学习（二） - 常用插件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-26T17:56:40+08:00">
                2017-09-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/gradle/" itemprop="url" rel="index">
                    <span itemprop="name">gradle</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="build-scan（构建审视）插件"><a href="#build-scan（构建审视）插件" class="headerlink" title="build-scan（构建审视）插件"></a>build-scan（构建审视）插件</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><blockquote>
<p>A build scan is a shareable and centralized record of a build that provides insights into what happened and why. By applying the build scan plugin to your project, you can create a build scan in the Gradle Cloud for free.<br><a href="https://guides.gradle.org/creating-build-scans/" target="_blank" rel="noopener">Creating Build Scans</a></p>
</blockquote>
<p>大概的意思是build scan能为你提供构建过程中发生的what and why信息，在你构建的时候，插件会抓取数据提交到<code>Gradle Cloud</code>，同时返回一个包含构建信息的链接。</p>
<p><strong>工作流程</strong><br><img src="https://docs.gradle.com/build-scan-plugin/images/build-scan-service-overview.svg" alt="overview"></p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>配置方式很简单，只需要在build.gradle中加入</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">plugins <span class="token punctuation">{</span>
    id <span class="token string">'com.gradle.build-scan'</span> version <span class="token string">'1.9'</span> 
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>添加了插件后，可以通过buildScan块来配置插件，其中有两个<code>license</code>相关的属性是<strong><em>必需要配置</em></strong>的</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">buildScan <span class="token punctuation">{</span>
    licenseAgreementUrl <span class="token operator">=</span> <span class="token string">'https://gradle.com/terms-of-service'</span>
    licenseAgree <span class="token operator">=</span> <span class="token string">'yes'</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>import changes（如果没有勾选auto-import），可以看到Gradle Project面板上多了个task<br><img src="/images/gradle_build_scan_task.png" alt=""></p>
<p><strong>tip</strong></p>
<ul>
<li>如果添加新的plugin，应该确保build-scan<strong><em>总是在第一个位置</em></strong>，否则其之前的插件虽然仍然正常工作，但是无法到抓取相关的构建信息</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>先执行build -&gt; build，再执行这个build scan -&gt; buildScanPublishPrevious，不出意外可以看到terminal中返回了一个链接</p>
<pre class="line-numbers language-text"><code class="language-text">9:50:39 PM: Executing external task 'buildScanPublishPrevious'...
:buildScanPublishPrevious

Publishing build scan...
https://gradle.com/s/af72je4qbzhme

BUILD SUCCESSFUL

Total time: 1.283 secs
9:50:41 PM: External task execution finished 'buildScanPublishPrevious'.
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>打开链接后可以看到这样一个界面</p>
<p><img src="/images/gradle_build_scan_insight.png" alt="build scan"></p>
<p>接下来在任一个单元测试内加入一行让构建失败</p>
<pre class="line-numbers language-java"><code class="language-java">        Assert<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>再执行一次构建，打开链接查看<br><img src="/images/gradle_build_scan_insight_failure.png" alt="failed build scan"></p>
<p>可以看到有以下几大优点：</p>
<ul>
<li>信息展示非常全面丰富、直观</li>
<li>良好的分类、折叠，让用户自己选择展开感兴趣的内容，非常友好</li>
<li>网页形式，非常易于分享（这一点有点类似<code>AngularJS</code>的错误信息，不过没考察是谁借鉴谁的，或许两者都不是原创？）。</li>
</ul>
<p>相比之下，这里不得不提到一直被人吐槽的Maven的构建信息，真心是非常不友好😒</p>
<p><strong>tip</strong></p>
<ul>
<li>如果构建时出现”There is no previous build data available to publish.”，可能是没有先执行任一task。</li>
</ul>
<h2 id="Application插件"><a href="#Application插件" class="headerlink" title="Application插件"></a>Application插件</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>Application插件可以让你轻松地在本地开发环境下<code>执行JVM应用</code>，同时还可以帮助你将应用打包成一个包含了各类操作系统对应<code>启动脚本</code>的tar and/or zip文件。</p>
<p><a href="https://docs.gradle.org/3.5/userguide/application_plugin.html" target="_blank" rel="noopener">The Application Plugin</a></p>
<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p><strong>build.gradle</strong></p>
<pre class="line-numbers language-groovy"><code class="language-groovy">apply plugin<span class="token punctuation">:</span> <span class="token string">'application'</span>
mainClassName <span class="token operator">=</span> <span class="token string">"cn.tac.test.gradle.Application"</span>    <span class="token comment" spellcheck="true">//指定程序入口类</span>
<span class="token comment" spellcheck="true">//applicationDefaultJvmArgs = ["-Dgreeting.language=en"]      //应用程序启动时的jvm参数</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>添加了Application插件后，项目会多出以下几个task</p>
<ul>
<li>run</li>
<li>startScripts</li>
<li>installDist</li>
<li>distZip</li>
<li>distTar</li>
</ul>
<p>具体可以通过tasks任务查看</p>
<p><strong>tips</strong></p>
<ul>
<li>按照官方的说法，Application插件已经隐式地包括了<code>Java</code>插件和<code>Distribution</code>插件，因此如果你原来引入了这两个插件，现在可以去掉了</li>
</ul>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p>以我的main函数为例（注意要跟<code>mainClassName</code>属性指定的类一致）</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> cn<span class="token punctuation">.</span>tac<span class="token punctuation">.</span>test<span class="token punctuation">.</span>gradle<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello, it's you args: "</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
             System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello, you do not input any args"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="执行应用"><a href="#执行应用" class="headerlink" title="执行应用"></a>执行应用</h4><pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew run

> Task :run
hello, you do not input any args
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果要<code>传入参数</code>，可以配置一下run任务<br><strong>build.gradle</strong></p>
<pre class="line-numbers language-groovy"><code class="language-groovy">run <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">"myArgs"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      args myArgs
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面配置的意思是，如果当前项目的project对象包含有myArgs属性，那么在执行main函数时就将这个属性作为参数传递，之后我们可以这样执行</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew run -PmyArgs="123","abc","qaz"

> Task :run
hello, it s you args: [123,abc,qaz]
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中-PmyArgs分为两部分</p>
<ul>
<li>-P，命令行option。作用是指定一个属性的值run，不能省去</li>
<li>myArgs，我们刚刚在run任务中自定义的属性，通过-P指定</li>
</ul>
<h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><p>执行以下脚本可以进行打包</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew distTar distZip
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>打包好的内容在<code>/build/distributions</code>中，分别多了一个tar文件和一个zip文件，解压后查看目录结构如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ tree .
.
├── bin
│   ├── gradle_cli
│   └── gradle_cli.bat
└── lib
    └── gradle_cli-1.0.jar
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>tips</strong></p>
<ul>
<li>当然你也可以通过build任务来打包，build任务会自动将<code>distTar</code>和<code>distZip</code>任务包括进去</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/learn_gradle_1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taccisum 😉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/learn_gradle_1.html" itemprop="url">Gradle学习（一） - Getting Started</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-26T15:39:42+08:00">
                2017-09-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/gradle/" itemprop="url" rel="index">
                    <span itemprop="name">gradle</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>虽然一直以来都用Maven作为java项目的构建工具，但早就听说过Gradle大名，于是今天终于抽出时间来了解一下这款号称结合了Ant和Maven优点的构建工具。<br>虽然Gradle支持多种语言，但这个系列的文章主要以Java项目构建为主。由于本人不是做Android开发，所以这个系列的文章可能会更偏向于Java Web开发视角。</p>
<h2 id="学习资源推荐"><a href="#学习资源推荐" class="headerlink" title="学习资源推荐"></a>学习资源推荐</h2><p><a href="https://gradle.org/docs/#getting-started" target="_blank" rel="noopener">官方Documentation</a> 内容非常全面，缺点是全英文（对于英语差的同学简直是噩梦）<br><a href="https://pkaq.gitbooks.io/gradletraining/content/" target="_blank" rel="noopener">《跟我学Gradle》</a> Gralde中文用户组编写的中文系列教程，缺点是还不够完善，有些章节还没有内容<br><a href="https://lippiouyang.gitbooks.io/gradle-in-action-cn/content/index.html" target="_blank" rel="noopener">《Gradle In Action》中译版</a> 书我没完整看过，只是查资料时读过几个章节，感觉内容还不错</p>
<h2 id="概貌了解"><a href="#概貌了解" class="headerlink" title="概貌了解"></a>概貌了解</h2><h3 id="同类工具比对"><a href="#同类工具比对" class="headerlink" title="同类工具比对"></a>同类工具比对</h3><p><strong>Ant</strong><br>Ant是第一个“现代”构建工具，于2000年发布基于过程式编程的idea，具备<code>插件功能</code>及通过网络进行<code>依赖管理</code>的功能（结合Apache Ivy）。不足之处是采用XML作为脚本编写格式，不符合过程化编程的初衷。</p>
<p><strong>Maven</strong><br>Maven出现的目的是解决Ant带来的一些问题，发布于2004年。Maven依靠<code>约定</code>并提供现成的可调用的目标，首创了从网络下载依赖的功能。依然采用XML作为配置文件（因此同样有跟Ant一样难以定制化构建过程的缺点）。另外Maven虽然聚焦于依赖管理，但并不能很好地处理相同库文件不同版本之间的冲突（不如Ivy）。</p>
<p><strong>Gradle</strong><br>Gradle结合了两者的优点，并在此基础上做了许多改进。<br>Gradle使用基于Groovy的<code>DSL</code>编写构建脚本，可以更细致地控制编译打包过程（这也是为什么Android Studio默认采用Gradle作为构建工具的原因）。<br>Gradle对<code>多模块</code>项目有很好的支持。<br>Gradle支持<code>多语言</code>，包括java、groovy、scala、c++等。<br>Gradle使用Apache Ivy处理依赖，因此依赖管理方面优于Maven。同时Gradle可以使用<code>多种类型的远程仓库</code>，如Maven仓库、Ivy仓库。</p>
<h3 id="关于DSL"><a href="#关于DSL" class="headerlink" title="关于DSL"></a>关于DSL</h3><p>DSL是<code>Domain Specific Language</code>的缩写，即领域特定语言。同字面上的意思，就是专用于处理某一领域问题的特定语言，例如用于web页面开发的HTML语言、用于GNU Emacs的Emacs Lisp等，甚至有一些简单的DSL只用于某个单应用程序（也称为Mini-Languages）。</p>
<p>由此可见，Gradle使用的DSL应该是一种专用于项目构建的语言。</p>
<p><a href="https://en.wikipedia.org/wiki/Domain-specific_language" target="_blank" rel="noopener">更多内容</a></p>
<h2 id="Getting-Started-IntelliJ-IDEA"><a href="#Getting-Started-IntelliJ-IDEA" class="headerlink" title="Getting Started - IntelliJ IDEA"></a>Getting Started - IntelliJ IDEA</h2><p>初次接触为了能够快速看到效果，所以直接使用ide来入门。不过为了对Gradle有更深入的了解，往后的练习项目将全部使用命令行构建。</p>
<h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><ol>
<li>New -&gt; Project -&gt; Gradle，新建一个Gradle项目（就像Maven一样，IDEA内置了Gradle，所以不需要我们手动去安装了）</li>
<li>填写GroupId、ArtifactId、Version（这些跟Maven是一样的）</li>
<li>这里勾选上Create directories for empty content roots automatically选项，让IDEA帮我们创建好目录结构</li>
<li>Finish，初次构建可能会花费较长的时间（跟Maven一样，要从网络下载一些东西，比如项目模板），构建好后的目录结构如下<br><img src="/images/gradle_project_structure.png" alt="project structure"></li>
</ol>
<p>来看下各folder&amp;file的含义：</p>
<ul>
<li>.gradle<blockquote>
<p>Gradle相关的支持文件，一般不用关心</p>
</blockquote>
</li>
<li>gradle<ul>
<li>wrapper <blockquote>
<p>The wrapper is a small script and supporting jar and properties file that allows a user to execute Gradle tasks even if they don’t already have Gradle installed. Generating a wrapper also ensures that the user will use the same version of Gradle as the person who created the project.<br><a href="https://guides.gradle.org/creating-new-gradle-builds/" target="_blank" rel="noopener">Creating New Gradle Project</a></p>
</blockquote>
大意为，wrapper里面是一些简单的<code>脚本</code>、使用户能在没有安装Gradle的情况下也能执行Gradle任务的supporting <code>jar</code>及<code>properties</code>文件等，同时wrapper还能确保用户执行Gradle任务时使用的版本与项目创建者使用的Gradle版本相同。<strong>总之是一个开发人员基本不需要关心的目录。</strong></li>
</ul>
</li>
<li>src<blockquote>
<p>源码目录，采用了与Maven相同的结构</p>
</blockquote>
</li>
<li>build.gradle<blockquote>
<p>Gradle的构建配置文件（build file），<strong><em>需要我们编写内容</em></strong>（类似Maven的pom.xml）。<br>按照官方的描述，每个build.gradle都配置了一个<code>org.gradle.api.Project</code>类的实例，并且这个实例会有许多内建的方法和属性（稍后CLI项目中可以看到gradlew properties列出了一堆project的属性）。<br><a href="https://docs.gradle.org/current/dsl/" target="_blank" rel="noopener">build.gradle的DSL参考</a></p>
</blockquote>
</li>
<li>gradlew/gradlew.bat<blockquote>
<p>分别用于类unix系统和windows系统下的wrapper脚本，之后可以看到，创建了wrapper后我们所有的指令都通过wrapper脚本来执行</p>
</blockquote>
</li>
<li>settings.gradle<blockquote>
<p>与多模块项目配置有关的文件，用于描述项目模块之间的关系</p>
</blockquote>
</li>
</ul>
<h3 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h3><p>创建好项目后可以看到，已经有许多配置好的东西了，如junit依赖、Gradle wrapper等，所以现在已我们直接可以直接写单元测试</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GettingStarted</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello gradle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行可以看到控制台输出</p>
<pre class="line-numbers language-text"><code class="language-text">hello gradle
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Getting-Started-CLI"><a href="#Getting-Started-CLI" class="headerlink" title="Getting Started - CLI"></a>Getting Started - CLI</h2><p>使用ide写个Gradle的Hello World确实非常简单，但使用CLI来搭建项目，能让我们对Gradle有更加深入的了解。<br>接下来我们将尝试用CLI写一个Hello World。</p>
<h3 id="安装Gradle"><a href="#安装Gradle" class="headerlink" title="安装Gradle"></a>安装Gradle</h3><p>由于我们这次用的是CLI，所以必须手动安装Gradle。<br>以我用的MacOS为例，打开terminal，run</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ brew install gradle
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装前必须确保安装了<code>jdk1.7</code>以上版本（我用的Gradle 4.1版本的要求），其它系统用户可以参考<a href="https://gradle.org/install/" target="_blank" rel="noopener">Installation</a></p>
<p>然后run，若已成功安装可以看到</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ gradle --version
------------------------------------------------------------
Gradle 4.1
------------------------------------------------------------

Build time:   2017-08-07 14:38:48 UTC
Revision:     941559e020f6c357ebb08d5c67acdb858a3defc2

Groovy:       2.4.11
Ant:          Apache Ant(TM) version 1.9.6 compiled on June 29 2015
JVM:          1.8.0_121 (Oracle Corporation 25.121-b13)
OS:           Mac OS X 10.12.4 x86_64
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h3><p>创建一个空文件夹作为工程目录，同时创建一个build.gradle空文件</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ mkdir gradle_cli
$ cd gradle_cli
$ touch build.gradle
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后执行以下命令生成Gradle Wrapper</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ gradle wrapper
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可以看到当前目录的变化</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ tree .
.
├── build.gradle
├── gradle
│   └── wrapper
│       ├── gradle-wrapper.jar
│       └── gradle-wrapper.properties
├── gradlew
└── gradlew.bat
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在可以通过wrapper脚本来执行各项任务，这样可以确保在更换了环境后依然能使用创建项目时使用的Gradle版本进行构建。</p>
<p>查看properties信息（以下输出做了大量删减）</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew properties
> Task :properties

------------------------------------------------------------
Root project
------------------------------------------------------------

allprojects: [root project 'gradle_cli']
ant: org.gradle.api.internal.project.DefaultAntBuilder@70e298ee
……
buildDir: /Users/tac/Documents/studyspace/src/java/gradle_cli/build
buildFile: /Users/tac/Documents/studyspace/src/java/gradle_cli/build.gradle
buildScriptSource: org.gradle.groovy.scripts.UriScriptSource@460e8e7a
……
depth: 0
description: null
displayName: root project 'gradle_cli'
……
gradle: build 'gradle_cli'
group:
……
plugins: [org.gradle.api.plugins.HelpTasksPlugin@23fb712b]
……
project: root project 'gradle_cli'
……
projectDir: /Users/tac/Documents/studyspace/src/java/gradle_cli
……
repositories: repository container
resources: org.gradle.api.internal.resources.DefaultResourceHandler@7cad9556
rootDir: /Users/tac/Documents/studyspace/src/java/gradle_cli
rootProject: root project 'gradle_cli'
……
state: project state 'EXECUTED'
status: release
subprojects: []
tasks: task set
version: unspecified
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到其中大多数属性都已经有了默认的值，这也恰好验证了Gradle约定优于配置的原则。<br>如果我们需要修改一些属性值，可以通过写build.gradle文件来进行配置</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">description <span class="token operator">=</span> <span class="token string">'A Gradle build project for CLI'</span>
version <span class="token operator">=</span> <span class="token string">'1.0'</span>
group <span class="token operator">=</span> <span class="token string">'cn.tac.test'</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>再次查看properties可以看到属性已经更改了</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew properties | grep -E "group|description|version"
description: A Gradle build project for CLI
group: cn.tac.test
version: 1.0
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>tip</strong></p>
<ul>
<li>你也可以先生成Wrapper再创建build.gradle，并不会有影响</li>
<li>除了手动创建之外，还可以通过<code>gradle init</code>指令来初始化项目。初始化的内容包括执行gradle wrapper，以及自动生成build.gradle和settings.gradle，并且生成的文件里面已经有了一些自动生成的配置（默认是注释状态，即未启用）。</li>
</ul>
<h3 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h3><p>由于我们是手动创建的空build.gradle，要构建java项目，我们还需要做一些简单的配置。<br>在build.gradle加入目标工程语言（上面提过，Gradle是支持多语言的）及版本、依赖及下载依赖的仓库的配置</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">apply plugin<span class="token punctuation">:</span> <span class="token string">'java'</span>
sourceCompatibility <span class="token operator">=</span> <span class="token number">1.8</span>

repositories <span class="token punctuation">{</span>
    <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    testCompile group<span class="token punctuation">:</span> <span class="token string">'junit'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'junit'</span><span class="token punctuation">,</span> version<span class="token punctuation">:</span> <span class="token string">'4.12'</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>tips</strong></p>
<ul>
<li>可以通过<code>dependencies</code>任务查看当前项目的依赖信息。</li>
</ul>
<h3 id="Hello-World-1"><a href="#Hello-World-1" class="headerlink" title="Hello World"></a>Hello World</h3><p>配置好环境后，我们创建源码目录及单元测试类</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ mkdir -p src/main/java src/main/resources src/test/java src/test/resources
$ cd src/test/java
$ mkdir -p cn/tac/test
$ cd cn/tac/test
$ touch HelloWorld.java
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后执行构建，如果不知道有哪些tasks可以执行，可以通过以下命令来查看</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew tasks

> Task :tasks

------------------------------------------------------------
All tasks runnable from root project - A Gradle build project for CLI
------------------------------------------------------------

Build tasks
-----------
assemble - Assembles the outputs of this project.
build - Assembles and tests this project.
……
Build Setup tasks
-----------------
init - Initializes a new Gradle build.
wrapper - Generates Gradle wrapper files.
Documentation tasks
-------------------
javadoc - Generates Javadoc API documentation for the main source code.
Help tasks
----------
……
Verification tasks
------------------
check - Runs all checks.
test - Runs the unit tests.

Rules
-----
……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-shell"><code class="language-shell">$ sh gradlew build
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>完了可以看见项目根目录下多了一个build目录，里面的内容就是执行构建的产物。与Maven不同的是，有个reports目录是Gradle生成的HTML格式的构建报告，可以通过浏览器打开查看<br><img src="/images/gradle_build_reports.jpg" alt="build reports"></p>
<p><strong>tip</strong></p>
<ul>
<li>有没有发现sh gradlew tasks出来的列表有点像IDEA Gradle Project面板上的tasks节点？😃</li>
<li>在项目根目录下使用gradle跟gradlew执行task的效果基本是一样的，区别在于gradle会使用本地安装的Gradle版本进行构建，而gradlew会使用创建项目时使用的gradle版本进行构建，如果本地没有搜索到这个版本，则会自动下载</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/interpreter_pattern_in_action.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taccisum 😉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/interpreter_pattern_in_action.html" itemprop="url">解释器模式实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-25T17:12:13+08:00">
                2017-09-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/taccisum/interpreter_pattern" target="_blank" rel="noopener">Github</a></p>
<h2 id="关于解释器模式"><a href="#关于解释器模式" class="headerlink" title="关于解释器模式"></a>关于解释器模式</h2><p>解释器模式是行为型模式的一种，关于解释器模式的定义从网上摘抄了一段</p>
<blockquote>
<p>给定一种语言，并定义代表其文法的相应解释器，并用该解释器来解析使用该语言的编写的内容<br><a href="http://java-design-patterns.com/patterns/interpreter/" target="_blank" rel="noopener">JAVA Design pattern</a></p>
</blockquote>
<p>其中的关键字有，<code>语言文法</code>、<code>解释器</code>。</p>
<ul>
<li>语言文法，如：下面要提到的<code>四则运算表达式</code>、我们日常使用的各种<code>编程语言</code>、类英语语法的<code>SQL</code>语言、一些框架里面的特定语言（如Spring的SpEL）等等，都是具有固定文法的语言，这意味着这些语言均可以用解释器模式来解析。当然，除此之外你也可以根据你的需求自己创造一种语言。</li>
<li>解释器，用于让计算机『认识』这些语言的工具，需要由我们程序员编码实现。越复杂的语言文法，其相应的解释器实现难度越大，比如人类的『自然语言』。</li>
</ul>
<h2 id="UML图"><a href="#UML图" class="headerlink" title="UML图"></a>UML图</h2><blockquote>
<p><img src="http://java-design-patterns.com/patterns/interpreter/etc/interpreter_1.png" alt=""><br><a href="http://java-design-patterns.com/patterns/interpreter/" target="_blank" rel="noopener">JAVA Design pattern</a></p>
</blockquote>
<p>其实并不算复杂（因为解释器模式最复杂的部分在于将语言解析为对象的过程，稍后的实践中可以看到），跟组合模式的UML图有点相像（同为树型数据结构），下面是两个比较重要的类：</p>
<p><strong>NumberExpression</strong>: 数值表达式（也称<code>终结点表达式</code>，意为表达式解析的终结点，可以简单理解为树型结构的叶子节点），执行interpret()一般会得到一个常量供复合表达式计算</p>
<p><strong>MultiplyExpression</strong>: 复合表达式（也称<code>非终结点表达式</code>，可以简单理解为树型结构的枝节点），一般包括一个或多个Expression类型的子节点，子节点数即代表该复合表达式的操作数数量，执行interpret()一般会得到其子节点互相作用后的结果</p>
<h2 id="编码实践"><a href="#编码实践" class="headerlink" title="编码实践"></a>编码实践</h2><p>为了节省篇幅，这里只贴出部分重要代码，完整代码可从开头的源码地址下载。</p>
<h3 id="简单四则运算"><a href="#简单四则运算" class="headerlink" title="简单四则运算"></a>简单四则运算</h3><h4 id="单元测试类"><a href="#单元测试类" class="headerlink" title="单元测试类"></a>单元测试类</h4><pre class="line-numbers language-text"><code class="language-text">cn.tac.test.interpreter.arithmetic.simple.SimpleCalculatorTest
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h4><p>支持最简单的四则运算，不支持括弧运算，不支持优先级运算符。因为语言文法较简单，所以解析器较易实现，适合作为Hello World。</p>
<h4 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h4><p><strong>Node</strong>: 即Expression</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>ValueNode</strong>: 即NumberExpression，代表操作数</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ValueNode</span> <span class="token keyword">implements</span> <span class="token class-name">Node</span><span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">ValueNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>SymbolNode</strong>: 即MultiplyExpression，代表运算符（如+-*/），因为均为<code>二元操作符</code>，所以只有两个子节点</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SymbolNode</span> <span class="token keyword">implements</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> Node left<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> Node right<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">SymbolNode</span><span class="token punctuation">(</span>Node left<span class="token punctuation">,</span> Node right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> left<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> right<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>SimpleValueNode</strong>: 简单地返回数值本身</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleValueNode</span> <span class="token keyword">extends</span> <span class="token class-name">ValueNode</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">SimpleValueNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>运算符节点</strong>: 代表+-*/</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlusNode</span> <span class="token keyword">extends</span> <span class="token class-name">SymbolNode</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">PlusNode</span><span class="token punctuation">(</span>Node left<span class="token punctuation">,</span> Node right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> left<span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> right<span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MinusNode</span> extend SymbolNode<span class="token punctuation">{</span>……<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MulNode</span> extend SymbolNode<span class="token punctuation">{</span>……<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DivNode</span> extend SymbolNode<span class="token punctuation">{</span>……<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Parser</strong>:</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Parser</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SPLITTER <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//为了方便解析，用空格将表达式分隔开</span>
    <span class="token keyword">public</span> Node <span class="token function">parse</span><span class="token punctuation">(</span>String statement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>SPLITTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        LinkedList<span class="token operator">&lt;</span>Node<span class="token operator">></span> nodeStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> symbolFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        String symbol <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String item <span class="token operator">:</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbolNode</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                symbol <span class="token operator">=</span> item<span class="token punctuation">;</span>
                symbolFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValueNode</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                nodeStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleValueNode</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>symbolFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Node right <span class="token operator">=</span> nodeStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//后入先出</span>
                    Node left <span class="token operator">=</span> nodeStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    nodeStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">mapSymbolNode</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    symbolFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"表达式格式有误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> nodeStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ……
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Calculator</strong>: </p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleCalculator</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">calculate</span><span class="token punctuation">(</span>String statement<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Parser parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Parser解析过程"><a href="#Parser解析过程" class="headerlink" title="Parser解析过程"></a>Parser解析过程</h5><ol>
<li>将表达式分割为数组，并遍历</li>
<li>从数组中获取一个元素，若为数值，则直接转换为节点并入栈；若为运算符，则只进行标记，等待下一个节点入栈后，将其与上一个节点一同取出，并合并为一个复合表达式节点入栈；</li>
<li>反复执行步骤2，直到数组末尾</li>
<li>将栈中的元素pop并返回（如果表达式无误，最终栈中应该只有一个元素，否则应该在解析过程中抛出异常）</li>
</ol>
<h3 id="完整四则运算"><a href="#完整四则运算" class="headerlink" title="完整四则运算"></a>完整四则运算</h3><h4 id="单元测试类-1"><a href="#单元测试类-1" class="headerlink" title="单元测试类"></a>单元测试类</h4><pre class="line-numbers language-java"><code class="language-java">cn<span class="token punctuation">.</span>tac<span class="token punctuation">.</span>test<span class="token punctuation">.</span>interpreter<span class="token punctuation">.</span>arithmetic<span class="token punctuation">.</span>full<span class="token punctuation">.</span>FullCalculatorTest
cn<span class="token punctuation">.</span>tac<span class="token punctuation">.</span>test<span class="token punctuation">.</span>interpreter<span class="token punctuation">.</span>arithmetic<span class="token punctuation">.</span>full<span class="token punctuation">.</span>ParserTest
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="实现效果-1"><a href="#实现效果-1" class="headerlink" title="实现效果"></a>实现效果</h4><p>支持完整的四则运算，包括括弧运算，优先级运算。由于相较于上一个实践文法上复杂了许多，不能用同样的方式直接解析，而是应该先转换为<code>后缀表达式</code>再进行解析。</p>
<h4 id="后缀表达式"><a href="#后缀表达式" class="headerlink" title="后缀表达式"></a>后缀表达式</h4><p>// todo::</p>
<h4 id="相关类-1"><a href="#相关类-1" class="headerlink" title="相关类"></a>相关类</h4><p><strong>节点</strong><br>值节点和运算符节点类仍采用和上个实践相同的类。</p>
<p><strong>Parser</strong></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Parser</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SPLITTER <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> Node <span class="token function">parse</span><span class="token punctuation">(</span>String statement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LinkedList<span class="token operator">&lt;</span>Node<span class="token operator">></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> segments <span class="token operator">=</span> <span class="token function">convert2Postfix</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>SPLITTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String segment <span class="token operator">:</span> segments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValueNode</span><span class="token punctuation">(</span>segment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleValueNode</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>segment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOperator</span><span class="token punctuation">(</span>segment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Node rightNode <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Node leftNode <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">doOperate</span><span class="token punctuation">(</span>leftNode<span class="token punctuation">,</span> rightNode<span class="token punctuation">,</span> segment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">convert2Postfix</span><span class="token punctuation">(</span>String statement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LinkedList<span class="token operator">&lt;</span>String<span class="token operator">></span> symbolStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//临时存放符号节点的栈</span>
        LinkedList<span class="token operator">&lt;</span>String<span class="token operator">></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> nodes <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>SPLITTER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>String node <span class="token operator">:</span> nodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbolNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token string">"("</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    symbolStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOperator</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    String topSymbol <span class="token operator">=</span> symbolStack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">priority</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token function">priority</span><span class="token punctuation">(</span>topSymbol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">priority</span><span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">priority</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    symbolStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">")"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"("</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    symbolStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"不支持的运算符"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValueNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"不支持的运算符"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//到数组尾部后，还有一些符号在栈内</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>symbolStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String tmp<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isNull</span><span class="token punctuation">(</span>tmp <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pollLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>SPLITTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ……
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Calculator</strong></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FullCalculator</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">calculate</span><span class="token punctuation">(</span>String statement<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Parser parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Parser解析过程-1"><a href="#Parser解析过程-1" class="headerlink" title="Parser解析过程"></a>Parser解析过程</h5><p>主要分为两大步骤<br><strong>一、将中缀表达式转换为后缀表达式</strong></p>
<ol>
<li>将表达式分割为数组，并遍历</li>
<li>从数组中获取一个元素<ul>
<li>若为数值，则直接入存放结果的栈，以下简称<code>结果栈</code></li>
<li>若为符号，则判断<ul>
<li>若符号栈目前为空，或该符号为左括弧”(“，则直接入临时存放符号的栈，以下简称<code>符号栈</code></li>
<li>若当前符号为操作符（+-*/，不包括括弧），则从符号栈peek（<em>不是pop</em>）一个符号，比如两者优先级，若 当前符号优先级&lt;=从栈顶取出的符号优先级，则从符号栈pop一个符号并push至结果栈，直至 符号栈为空 or 栈顶符号优先级&lt;=当前符号优先级，然后将当前符号入符号栈。<em>这里需要注意的是，左右括弧也有优先级，且优先级应小于操作符，否则在这里需要单独处理pop时遇到左括弧的问题</em></li>
<li>若为右括弧”)”，则将符号栈pop符号并push至结果栈，直到遇到左括弧（遇到后pop并丢弃）</li>
</ul>
</li>
</ul>
</li>
<li>反复执行步骤2，直到数组末尾</li>
<li>到数组尾部后，多数情况都会有一些符号还留在符号栈内，应将其取出并push至结果栈</li>
<li>将结果栈构建为字符串，并返回</li>
</ol>
<p><strong>二、将后缀解析为java对象</strong></p>
<ol>
<li>将表达式分割为数组，并遍历</li>
<li>从数组中获取一个元素，若为数值，则直接转换成数值节点并入栈；若为操作符（转换成后缀表达式后已经没有括弧了），则从栈顶取出两个节点，并合并为一个复合表达式节点并入栈</li>
<li>反复执行步骤2，直到数组末尾</li>
<li>将栈中的元素pop并返回（如果表达式无误，最终栈中应该只有一个元素，否则应该在解析过程中抛出异常）</li>
</ol>
<p>当然，你也可以将这两个步骤合二为一，在转换的同时将其转换为java对象，但非实际应用中个人还是建议将两个步骤分离，原因有二：</p>
<ul>
<li>降低编码的复杂度</li>
<li>方便进行单元测试（尤其是将后缀表达式转换为中缀表达式的步骤，比较容易出错）</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/about_java.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taccisum 😉">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/about_java.html" itemprop="url">关于java</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-25T16:25:28+08:00">
                2017-09-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/jvm/" itemprop="url" rel="index">
                    <span itemprop="name">jvm</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="java体系"><a href="#java体系" class="headerlink" title="java体系"></a>java体系</h2><blockquote>
<p>java不仅仅是一门编程语言，还是由一系列计算机软件和规范形成的技术体系。<br>这个体系提供了完整的用于软件开发和跨平台部署的支持环境。</p>
</blockquote>
<p><strong>Sun官方定义的java技术体系包括以下内容</strong>：  </p>
<ol>
<li>java程序设计语言</li>
<li>各硬件平台上的java虚拟机（jvm）</li>
<li>Class文件格式</li>
<li>java api类库</li>
<li>来自商业机构和开源社区的第三方类库</li>
</ol>
<p>以上1、2、4点统称为jdk，jdk是支持java程序开发的最小环境.<br>java api中的java se api子集和java虚拟机统称为jre，jre是java程序运行的最小环境.</p>
<p>java除了一门优秀的编程语言外，还有许多不可忽视的优点：</p>
<ul>
<li>摆脱硬件平台束缚，实现跨平台</li>
<li>内存管理，避免绝大部分内存泄露和指针越界问题</li>
<li>热点代码检测和运行时编译及优化</li>
<li>完善的应用程序编程接口及丰富、优秀的第三方类库</li>
</ul>
<p>java技术体系按照所服务的领域来划分，可以分为四大模块：<code>java card</code> <code>java se</code> <code>java me</code> <code>java ee</code></p>
<h2 id="jdk发展史"><a href="#jdk发展史" class="headerlink" title="jdk发展史"></a>jdk发展史</h2><p>java语言前身：oak</p>
<ul>
<li>1995年，oak更名为java，同时sun正式提出”write once, run anywhere”的口号，标识着java正式诞生</li>
<li>1996年，jdk1.0发布，并提供了一个纯解释性的java虚拟机（Sun Classic VM）</li>
<li>1997年，jdk1.l发布，代表技术有：jdbc, rmi, java beans, .jar文件等</li>
<li>1998年，jdk1.2发布，正式把java技术体系划分为3个方向：java se, java me, java ee，代表技术较多，如ejb, java pluin-in, swing等。java虚拟机中第一次内置了jit编译器，且附带了HotSpot作为备选</li>
<li>2000年，jdk1.3发布，将HotSpot作为默认虚拟机，并提供jndi作为平台级服务，从此后Sun公司基本保持两年一个主版本的更新速度</li>
<li>2002年，jdk1.4发布，标志着java正式走向成熟，代表技术有：正则表达式、异常链、nio、日志类、xml解析器等等</li>
<li>2004年，jdk1.5(jdk5)发布，主要是对java语言的易用性方面做了改进</li>
<li>2006年，jdk1.6(jdk6)发布，除了改进之外，Sun正式将java开源（GPL协议），并建立了OpenJDK组织对其进行管理<br>jdk1.7(jdk7)开发，Sun公司由于各种原因，最终无法按计划完成。2009年Oracle公司将其收购后，对jdk1.7的内容进行大幅度裁剪，并把剩余内容延迟到jdk1.8中。jdk1.7于2011年正式发布</li>
<li>2013年，jdk1.8(jdk8)发布，加入了lambda表达式及函数式接口等支持</li>
</ul>
<h2 id="部分jvm介绍"><a href="#部分jvm介绍" class="headerlink" title="部分jvm介绍"></a>部分jvm介绍</h2><ul>
<li><p>Sun Classic VMr</p>
<ul>
<li>Classic VM是Sun公司发布的第一款商用java虚拟机，作为默认虚拟机与jdk1.0绑定发布，技术较为原始</li>
<li>在jdk1.2之前都是唯一存在的虚拟机</li>
<li>只能使用纯解释器方式来运行java程序</li>
<li>如果要使用JIT编译器，必须外挂</li>
</ul>
</li>
<li><p>Exact VM</p>
<ul>
<li>为了解决Classic VM存在的各种问题而开发，在jdk1.2期间发布</li>
<li>具备了现代高性能虚拟机的原型</li>
<li>在商用只存在了短暂的时间后，即被更为优秀的HotSpot取代</li>
</ul>
</li>
<li><p>Sun HotSpot VM</p>
<ul>
<li>是SunJDK及OpenJDK中所带的虚拟机，也是目前使用最广的虚拟机</li>
<li>最初是由一家名为”Longview Teconologies”的小公司设计，在1997年该公司被Sun收购</li>
<li>其即有Sun之前两款虚拟机的优点，也有许多自身的技术优势如热点代码探测能力</li>
</ul>
</li>
<li><p>Sun Mobile-Embedded VM/Meta-Circular VM</p>
<ul>
<li>Sun公司针对移动和嵌入式市场的虚拟机</li>
</ul>
</li>
<li><p>BEA JRockit</p>
<ul>
<li>一款专门为服务端硬件和服务端应用场景而专门优化的虚拟机</li>
<li>不关注应用程序的启动速度，因而其内部不含解析器的实现，全部代码靠JIT编译运行</li>
<li>除此之外，其垃圾收集器和MissionControl等服务套件的实现也一直在众多虚拟机中保持领先的水平</li>
</ul>
</li>
<li><p>IBM J9 VM</p>
</li>
<li>Azul VM/BEA Liquid VM</li>
<li>Apache Harmony/Google Android Dalvik VM</li>
<li>Microsoft JVM</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/Avatar.jpg"
               alt="taccisum" />
          <p class="site-author-name" itemprop="name">taccisum</p>
           
              <p class="site-description motion-element" itemprop="description">el psy congroo.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/taccisum" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://gitee.com/taccisum/projects" target="_blank" title="Gitee">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      Gitee
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">taccisum</span>
</div>

<div>
  <span class="post-count">28.0k words</span>
</div>
        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
