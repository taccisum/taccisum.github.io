<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5J42R3VH2D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5J42R3VH2D');
</script>

  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.7.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"taccisum.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="el psy congroo.">
<meta property="og:type" content="website">
<meta property="og:title" content="Taccisum&#39;s blog 😉">
<meta property="og:url" content="https://taccisum.github.io/index.html">
<meta property="og:site_name" content="Taccisum&#39;s blog 😉">
<meta property="og:description" content="el psy congroo.">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Taccisum&#39;s blog 😉">
<meta name="twitter:description" content="el psy congroo.">

<link rel="canonical" href="https://taccisum.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Taccisum's blog 😉</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-ghcolors.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Taccisum's blog 😉</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/list_vs_stream_in_spring_data_mongodb.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="el psy congroo.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Taccisum's blog 😉">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/list_vs_stream_in_spring_data_mongodb.html" class="post-title-link" itemprop="url">List 与 Stream 在 Spring Data MongoDB 场景下的比较</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-20 17:36:23" itemprop="dateCreated datePublished" datetime="2023-01-20T17:36:23+08:00">2023-01-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-01-31 09:57:14" itemprop="dateModified" datetime="2023-01-31T09:57:14+08:00">2023-01-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/mongodb/" itemprop="url" rel="index"><span itemprop="name">mongodb</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/mongodb/client/" itemprop="url" rel="index"><span itemprop="name">client</span></a>
                </span>
            </span>

          
            <span id="/list_vs_stream_in_spring_data_mongodb.html" class="post-meta-item leancloud_visitors" data-flag-title="List 与 Stream 在 Spring Data MongoDB 场景下的比较" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/list_vs_stream_in_spring_data_mongodb.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/list_vs_stream_in_spring_data_mongodb.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><p>如果只是简单地用在接口返回，List 与 Stream 并没有差异<br>例如以下两段代码，返回的结果是一样的</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"list"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> Object <span class="token function">listAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> repository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"stream"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> Object <span class="token function">streamAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> repository<span class="token punctuation">.</span><span class="token function">streamAllBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>但如果你需要在业务逻辑中处理大量的数据，List 和 Stream 的差异就体现出来了。</p>
<p>如果不用 Stream，在处理海量数据的时候，为了避免一次性将全部数据 Load 到内存导致内存溢出，一般我们会进行分页处理。但 skip &amp; limit 跳页会导致较低的的查询性能，因此一般我们会采用 lastId 配合索引的方式来进行分页，如下所示</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> PAGE_SIZE <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
String lastId <span class="token operator">=</span> <span class="token string">'000000000000000000000000'</span><span class="token punctuation">;</span>

List<span class="token operator">&lt;</span>MyDoc<span class="token operator">></span> rows <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">findAllByGreaterThanId</span><span class="token punctuation">(</span>lastId<span class="token punctuation">,</span> PageRequest<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>rows<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>row in rows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// do something for current row</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// read next page</span>
    lastId <span class="token operator">=</span> <span class="token function">lastOne</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rows <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">findAllByGreaterThanId</span><span class="token punctuation">(</span>lastId<span class="token punctuation">,</span> PageRequest<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但这种方式仍然存在一些问题：</p>
<ol>
<li>仍然会占用一些内存（取决于你设定的 PAGE SIZE），当然这不是什么大问题</li>
<li>在等待传输完当前页数据的 I/O 期间，应用程序什么也干不了</li>
<li>如果哪天要修改成多线程版本以提升处理效率，会有比较大的改动</li>
<li>代码复杂度稍高</li>
</ol>
<p>相比之下，如果我们用 Stream 来处理，代码就简单多了</p>
<pre class="line-numbers language-java"><code class="language-java">repo<span class="token punctuation">.</span><span class="token function">streamAllBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>doc <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// do something for cuurent row</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果要修改为并行版本也非常简单</p>
<pre class="line-numbers language-java"><code class="language-java">repository<span class="token punctuation">.</span><span class="token function">streamAllBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>doc <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// do something for cuurent row</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>Stream 的缺点：</strong></p>
<ol>
<li>批处理的场景下没有分页直观（例如滑动窗口），这点主要是 JDK8 缺乏支持，其它类似的框架如 RxJava 或 ProjectReactor 都是支持的，<a href="https://spring.io/blog/2016/11/28/going-reactive-with-spring-data" target="_blank" rel="noopener">Spring Data Reactive</a> 也有相关的支持（当然，学习成本也是很高。。）</li>
<li>【实际与我猜想的不一样，见实测章节】Stream 处理任务的期间会持续占用一个连接，不利于资源的复用。相比之下 List 只有每次拉取页的 I/O 期间才占用连接（假如不加事务的话）。如果连接资源很紧张，使用 Stream 可能会出较大的问题</li>
</ol>
<h3 id="性能实测"><a href="#性能实测" class="headerlink" title="性能实测"></a>性能实测</h3><p><strong>环境</strong>：</p>
<ul>
<li>单 collection 约 130w 数据</li>
<li>客户端：Java + MacOS</li>
</ul>
<h4 id="List"><a href="#List" class="headerlink" title="List"></a>List</h4><p><img src="images/list-vs-stream/jvm_list.png" alt="list performance"></p>
<p><img src="images/list-vs-stream/idea_list_breakpoint.png" alt="idea list breakpoint"></p>
<p>可以看到，调用 List 的过程，JVM 内存只增不减，且 GC 频率越来越高。整个过程花了接近 15min 时间。</p>
<p><img src="images/list-vs-stream/jvm_list_gc.png" alt="list gc"></p>
<p>而在执行完后，触发一次 GC，直接内存占用就清零了。</p>
<p>原因显而易见，List 操作需要在 JVM 内存中构建 <code>ArrayList</code> 对象，加上数据量过于庞大，会导致不断地进行扩容，因此性能极差。同时由于所有数据均被一个 <code>ArrayList</code> 对象持有，导致<strong>内存占用只升不降</strong>（无法被 GC 回收）</p>
<h4 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h4><p><img src="images/list-vs-stream/jvm_stream.png" alt="stream performance"></p>
<pre class="line-numbers language-plain"><code class="language-plain">handle count: 1391665. time elapsed: 11500ms
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>首先性能上远远高于 List（没有扩容和 GC，只花了 11s 左右）</p>
<p>由于不需要通过 <code>ArrayList</code> 去保存数据，内存利用率会迅速增加(约 700MB)，后面有一段维持直线的，猜测是因为一直没有触发 GC。</p>
<p>将代码稍微改动下，在 stream 的处理期间手动触发一些 GC</p>
<pre class="line-numbers language-java"><code class="language-java">repository<span class="token punctuation">.</span><span class="token function">streamAllBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>doc <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            String itemInMemory <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            c<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="images/list-vs-stream/jvm_stream_with_gc.png" alt="stream performance"></p>
<pre class="line-numbers language-plain"><code class="language-plain">handle count: 1391665. time elapsed: 15226ms
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可以看到相比于 List，Stream 的处理期间是可以释放被占用的内存的。另外由于多了取余和 GC 的操作，整个时间花费也由 11s 上升到 15s，CPU 也有所上升。</p>
<h3 id="缺点-2-实测"><a href="#缺点-2-实测" class="headerlink" title="缺点 2 实测"></a>缺点 2 实测</h3><p>为了验证上述的缺点 2，我准备了一个简单的服务以及两个接口</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"list"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> Object <span class="token function">listAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> repository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"stream"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> Object <span class="token function">streamAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    repository<span class="token punctuation">.</span><span class="token function">streamAllBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>doc <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，<code>/stream</code>接口中针对每条数据会 sleep 200ms 的时间以模拟慢操作（数据库中预先准备了 100 条数据，因此该接口需要执行约 20s 的时间），<code>/list</code>接口则只是简单的返回所有数据。我们通过交叉用这两个接口来观察应用中的连接使用情况</p>
<ol>
<li>我们先重启应用，确保连接池为空</li>
<li>先调用<code>/list</code>接口，观察日志会发现 Spring Data Mongo 创建了一个连接</li>
</ol>
<pre><code>2023-01-20 17:09:19.576  INFO 77750 --- [nio-8080-exec-1] org.mongodb.driver.connection            : Opened connection [connectionId{localValue:2, serverValue:1859}] to 192.168.11.180:32017
</code></pre><p>如果此时进入断点查看，会发现连接池数量为 1<br><img src="images/list-vs-stream/pool_size1.png" alt="pool size 1"><br>继续调用<code>/list</code>接口（非并发场景）会发现 Mongo Client 将一直复用此连接，不会创建新的连接。这符合连接池的设计机制</p>
<ol start="3">
<li>我们先调用<code>/stream</code>接口，在其处理期间再调用<code>/list</code>接口，如果如我们所猜想的一样 Stream 会长时间占用一个连接的话，那么我们在调用<code>/list</code>接口的时候 Mongo Client 应该会再创建一个连接用于处理查询才对</li>
</ol>
<p><strong>实际情况是：</strong>在我们<code>/stream</code>接口执行期间，调用<code>/list</code>接口并没有使得 Mongo Client 创建新的连接。打断点观察<code>ServerSessionPool</code>的可用连接数也会发现其仍然为 1。显然 Mongo Client 及 JDK Stream 底层是针对这种情况做过优化的，<strong>猜想被推翻</strong></p>
<ol start="4">
<li>为了证明在资源不够用的时候 Mongo Client 确实是会自动创建新的连接的，我们也用 ab 来做一个简单的压测</li>
</ol>
<p><strong>压测命令：</strong><code>ab -n 100 -c 5 &#39;localhost:8080/mongo/list&#39;</code><br>可以看到控制台输出了 4 个连接创建的事件</p>
<pre><code>2023-01-20 17:19:42.172  INFO 77750 --- [nio-8080-exec-3] org.mongodb.driver.connection            : Opened connection [connectionId{localValue:6, serverValue:1865}] to 192.168.11.180:32017
2023-01-20 17:19:42.172  INFO 77750 --- [nio-8080-exec-4] org.mongodb.driver.connection            : Opened connection [connectionId{localValue:5, serverValue:1863}] to 192.168.11.180:32017
2023-01-20 17:19:42.172  INFO 77750 --- [nio-8080-exec-2] org.mongodb.driver.connection            : Opened connection [connectionId{localValue:4, serverValue:1864}] to 192.168.11.180:32017
2023-01-20 17:19:42.172  INFO 77750 --- [io-8080-exec-10] org.mongodb.driver.connection            : Opened connection [connectionId{localValue:3, serverValue:1866}] to 192.168.11.180:32017
</code></pre><p>断点观察连接池可用连接数也变成了 5<br><img src="images/list-vs-stream/pool_size5.png" alt="pool size 5"></p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>除了如批处理之类的少数场景下，Stream 几乎总是优于分页 List（更不用说全量 List），因此在单次要处理的数据量达到一定量级时（比如超过 1000），应该优先考虑使用 Stream。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://stackoverflow.com/questions/63115831/spring-data-repository-list-vs-stream" target="_blank" rel="noopener">https://stackoverflow.com/questions/63115831/spring-data-repository-list-vs-stream</a></li>
<li><a href="https://stackoverflow.com/questions/50698222/connection-pooling-in-spring-boot-and-mongo-db" target="_blank" rel="noopener">https://stackoverflow.com/questions/50698222/connection-pooling-in-spring-boot-and-mongo-db</a></li>
<li><a href="https://stackoverflow.com/questions/23808264/how-to-get-connected-clients-in-mongodb" target="_blank" rel="noopener">https://stackoverflow.com/questions/23808264/how-to-get-connected-clients-in-mongodb</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/redis-wireshark.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="el psy congroo.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Taccisum's blog 😉">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/redis-wireshark.html" class="post-title-link" itemprop="url">用 Wireshark 抓包 Redis</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-29 10:01:15 / Modified: 21:41:07" itemprop="dateCreated datePublished" datetime="2022-12-29T10:01:15+08:00">2022-12-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middlewire/" itemprop="url" rel="index"><span itemprop="name">middlewire</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middlewire/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/redis-wireshark.html" class="post-meta-item leancloud_visitors" data-flag-title="用 Wireshark 抓包 Redis" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/redis-wireshark.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/redis-wireshark.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Redis 有自己的一套传输协议（RESP），因此想通过 Wireshark 抓包 Redis 得先安装插件，具体步骤如下：</p>
<ol>
<li>找到你的 Wireshark 安装目录下的 <code>init.lua</code> 所在的文件夹</li>
</ol>
<p>例如我的是 MacOS，通过 DMG 安装的，是在 <code>/Applications/Wireshark.app/Contents/Resources/share/wireshark</code> 目录下</p>
<ol start="2">
<li><p>把 <a href="https://github.com/jzwinck/redis-wireshark/blob/master/redis-wireshark.lua" target="_blank" rel="noopener">redis-wireshark.conf</a> 整个文件 copy 放在上述目录下</p>
</li>
<li><p>编辑 <code>init.lua</code> 添加以下内容，加载第 2 步放进去的 lua 脚本</p>
</li>
</ol>
<pre class="line-numbers language-lua"><code class="language-lua"><span class="token comment" spellcheck="true">-- 其它内容...</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> running_superuser <span class="token keyword">or</span> run_user_scripts_when_superuser <span class="token keyword">then</span>
    <span class="token function">dofile</span><span class="token punctuation">(</span>DATA_DIR<span class="token operator">..</span><span class="token string">"console.lua"</span><span class="token punctuation">)</span>
    <span class="token function">dofile</span><span class="token punctuation">(</span>DATA_DIR<span class="token operator">..</span><span class="token string">"redis-wireshark.lua"</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">-- 这行是你要新加的，其它都是原有的</span>
<span class="token keyword">end</span>
<span class="token comment" spellcheck="true">-- 其它内容...</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li><p>重启 Wireshark 或使用 UI 上的 <code>Analyse -&gt; Reload Lua Plugins</code> 功能（CMD + SHIFT + L）重新加载插件</p>
</li>
<li><p>启动抓包，用 <code>redis-cli</code> 连接你的 Redis，随便输入一些命令（我这里示例是 <code>get tac</code>），在 Wireshark filter 框框中输入 <code>redis</code> 或 <code>tcp.port == 6379</code> 过滤协议，看到类似以下的数据就说明成功了</p>
</li>
</ol>
<p><img src="images/redis-wireshark/example.jpg" alt="redis-wireshark-example"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/bathroom_automation.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="el psy congroo.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Taccisum's blog 😉">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bathroom_automation.html" class="post-title-link" itemprop="url">只靠一个米家门窗传感器搞定浴室自动化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-04-04 09:42:55 / Modified: 15:53:23" itemprop="dateCreated datePublished" datetime="2022-04-04T09:42:55+08:00">2022-04-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/home-automation/" itemprop="url" rel="index"><span itemprop="name">home automation</span></a>
                </span>
            </span>

          
            <span id="/bathroom_automation.html" class="post-meta-item leancloud_visitors" data-flag-title="只靠一个米家门窗传感器搞定浴室自动化" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/bathroom_automation.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/bathroom_automation.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近心血来潮买了个<a href="https://www.xiaomiyoupin.com/detail?gid=101464" target="_blank" rel="noopener">米家门窗传感器</a>，打算用在浴室实现一种<strong>人来灯亮，人走灯灭</strong>的效果，但买回来后却发现实际场景比我想象中要复杂得多。为啥呢？门窗传感器最大的问题在于只能感知开/合两种状态，所以无法得知是否有人在浴室内。如果你仅靠闭门来触发关灯的话，就会有一个大问题：当你触发开门的时候灯亮了，然后你走进浴室，这时关门，pa 的一下，灯灭了。。尴尬。。</p>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><p>如果要解决这个问题，首先想到的是再买个人体红外感应器配合来用。但一来吧，总觉得为了这一个小自动化功能买两个传感器不经济；二来红外感应器在浴室的表现并不好（覆盖角度有限制而且有些浴室设计还是分区的，加上浴室水蒸气有时会干扰红外检）因此不是个很好的方案。</p>
<p>但东西都买回来了，总不能丢一边吃灰吧。好在办法总比困难多。门窗传感器本身虽然不足以检测到人，但米家给我们提供了其它逻辑工具啊~</p>
<p>来看看这个问题，其实可以抽象成如何设计一个<strong>有限状态机（Finite Automate）</strong>以保证浴室自动化符合我们的要求的问题，其中：</p>
<p>要处理的浴室状态有：</p>
<ul>
<li><strong>close_out</strong>: 室内无人且门属于关闭状态（此状态时灯与排气扇关闭）</li>
<li><strong>open_wait</strong>: 室内无人且门属于打开等待进入状态（此状态时灯与排气扇打开）</li>
<li><strong>close_in</strong>: 室内有人且门属于关闭状态（此状态时灯与排气扇保持打开）</li>
<li><strong>open_in</strong>: 室内有人且门属于打开状态（此状态时灯与排气扇区保持打开）</li>
</ul>
<blockquote>
<p>tips: 因为还要考虑人是否在内，所以要考虑的状态有四个而非简单的开和闭两个。</p>
</blockquote>
<p>影响状态变换的条件有：</p>
<ul>
<li><strong>open</strong>: 浴室门打开</li>
<li><strong>close</strong>: 浴室门关闭</li>
</ul>
<p>但实际上还有个隐藏条件可以利用：</p>
<ul>
<li><strong>time_elaspe</strong>: 时间流逝 ns（比如我们假定现实中 90% 的场景下人进入浴室，都会在 15s 内关上门）</li>
</ul>
<p>如果把人工干预也算上，那还可以加上：</p>
<ul>
<li><strong>manual</strong>: 检测到手动操作（例如，手动关灯）</li>
</ul>
<p>最终设计出来的状态变换图如下</p>
<p><img src="/images/toilet_fa/tfa.jpg" alt="toilet fa"></p>
<p>其中 <code>close_out</code> 即是起始状态也是最终状态。</p>
<p>对应状态转换表如下</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center"><strong>open</strong></th>
<th style="text-align:center"><strong>close</strong></th>
<th style="text-align:center"><strong>time elaspe</strong></th>
<th style="text-align:center"><strong>manual</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>close_out</strong></td>
<td style="text-align:center">open_wait</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center"><strong>open_wait</strong></td>
<td style="text-align:center">-</td>
<td style="text-align:center">close_out</td>
<td style="text-align:center">open_in</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center"><strong>close_in</strong></td>
<td style="text-align:center">close_out</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">close_out</td>
</tr>
<tr>
<td style="text-align:center"><strong>open_in</strong></td>
<td style="text-align:center">-</td>
<td style="text-align:center">close_out</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<blockquote>
<p>横杠 - 表示该状态下不接受此输入的意思</p>
</blockquote>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>接下来我们把要处理的场景跑一遍，看上述 FA 能否满足我们的要求。</p>
<p>为了简化表述，我们把状态和条件均用数字代替：</p>
<ul>
<li>state set: close_out(1), open_wait(2), close_in(3), open_in(4)</li>
<li>criteria: open(1), close(2), time_elaspe(3)</li>
</ul>
<p><img src="/images/toilet_fa/tfa_num.jpg" alt="toilet fa with numbers"></p>
<h3 id="场景一：长时间事务，会关门进行（如洗澡，蹲坑）"><a href="#场景一：长时间事务，会关门进行（如洗澡，蹲坑）" class="headerlink" title="场景一：长时间事务，会关门进行（如洗澡，蹲坑）"></a>场景一：长时间事务，会关门进行（如洗澡，蹲坑）</h3><p>输入：1, 2, 1, 2<br>状态变换过程：1-&gt;2-&gt;3-&gt;4-&gt;1</p>
<p><img src="/images/toilet_fa/tfa_scene1.jpg" alt="toilet fa scene 1"></p>
<p>最终状态为 <code>close_out</code>，可接受，符合预期</p>
<h4 id="子场景-1-1：人在里边临时开门（不超时）"><a href="#子场景-1-1：人在里边临时开门（不超时）" class="headerlink" title="子场景 1.1：人在里边临时开门（不超时）"></a>子场景 1.1：人在里边临时开门（不超时）</h4><p>输入：1, 2, 1, 2<br>状态变换过程：1-&gt;2-&gt;3-&gt;4-&gt;1<br>最终状态为为 <code>close_out</code>，可接受，但<strong>不符合预期</strong>（预期状态是保持 <code>close_in</code>），需要将输入调整为 1, 2, 1, 2, 1, 2（也就是临时开门后再执行一次开关门，中间会经历一次灯断电，体验稍差）<br>状态变换过程：1-&gt;2-&gt;3-&gt;4-&gt;1-&gt;2-&gt;3，符合预期</p>
<p><img src="/images/toilet_fa/tfa_scene1_1.jpg" alt="toilet fa scene 1.1"></p>
<h3 id="场景二：短时间事务，不关门（如洗手，时间足以触发条件-3）"><a href="#场景二：短时间事务，不关门（如洗手，时间足以触发条件-3）" class="headerlink" title="场景二：短时间事务，不关门（如洗手，时间足以触发条件 3）"></a>场景二：短时间事务，不关门（如洗手，时间足以触发条件 3）</h3><p>输入：1, 3, 2<br>状态变换过程：1-&gt;2-&gt;4-&gt;1</p>
<p><img src="/images/toilet_fa/tfa_scene2.jpg" alt="toilet fa scene 2"></p>
<p>最终状态为 <code>close_out</code>，可接受，符合预期</p>
<h3 id="场景三：误操作，开门后立马关门（时间不足以触发条件-3）"><a href="#场景三：误操作，开门后立马关门（时间不足以触发条件-3）" class="headerlink" title="场景三：误操作，开门后立马关门（时间不足以触发条件 3）"></a>场景三：误操作，开门后立马关门（时间不足以触发条件 3）</h3><p>输入：1, 2<br>状态变换过程：1-&gt;2-&gt;3<br>最终状态为 <code>close_in</code>，非可接受状态，因此要人工介入，使得</p>
<p>输入变为： 1, 2, 4<br>状态变换过程：1-&gt;2-&gt;3-&gt;1</p>
<p><img src="/images/toilet_fa/tfa_scene3.jpg" alt="toilet fa scene 3"></p>
<p>最终状态回到 <code>close_out</code>，可接受，符合预期</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>可以看到在场景 1.1 &amp; 3 下若没有人工介入依然是无法很好地处理的。好在 1&amp;2 占了我们日常场景的 90% 以上，总的来说此方案还是利大于弊。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>由于笔者使用的是米家 APP，因此这里仅展示基于米家『场景』模块的实现（理论上只要支持上述触发条件的平台都能实现）</p>
<blockquote>
<p>这里的场景指的是米家 APP 上的『场景』模块，与我们文章上述提到的场景并非同一概念<br>米家场景分为自动（又称作<strong>智能</strong>）和手动两类，手类执行的场景除了手动操作外，还可以通过自动场景来触发</p>
</blockquote>
<p>我们把浴室的状态与米家的场景对应起来（有些状态可能会对应多个场景），得到以下场景</p>
<h3 id="close-out"><a href="#close-out" class="headerlink" title="close_out"></a>close_out</h3><ul>
<li>触发条件：门窗传感器开</li>
<li>执行动作：<ol>
<li>开浴室灯 &amp; 排气扇（这块可以根据实际需求自行调整）</li>
<li>关闭智能 <code>close_out</code></li>
<li>开启智能 <code>open_wait</code></li>
<li>关闭智能 <code>open_in</code></li>
<li>执行手动场景 <code>open_wait.time_elaspe</code></li>
</ol>
</li>
</ul>
<blockquote>
<p>tips: 其中命名 <code>close_out</code> 代表该米家场景打开时我们的浴室是处在状态 <code>close_out</code> 的，一旦检测到门窗传感器打开将执行相应动作。动作 2&amp;3 组合起来实现了状态切换的效果（关闭当前智能，打开目标状态对应的智能，也就是 <code>open_in</code>）；动作 5 是模拟以时间条件为输入的效果，详见 <code>open_wait.time_elaspe</code> 的配置<br>此外，这里还出现了一个看似没啥用的动作 <strong>关闭 open_in</strong>，将在后面作解答</p>
</blockquote>
<h3 id="open-wait-time-elaspe"><a href="#open-wait-time-elaspe" class="headerlink" title="open_wait.time_elaspe"></a>open_wait.time_elaspe</h3><ul>
<li>触发条件：手动触发</li>
<li>执行动作：<ol>
<li>延时 15s（时间可以自行调整成符合家庭习惯的数值）</li>
<li>开启 <code>open_in</code></li>
</ol>
</li>
</ul>
<h3 id="open-wait"><a href="#open-wait" class="headerlink" title="open_wait"></a>open_wait</h3><ul>
<li>触发条件：门窗传感器关</li>
<li>执行动作：<ol>
<li>关闭智能 <code>open_wait</code></li>
<li>开启智能 <code>close_in</code></li>
<li>开启智能 <code>close_in.manual</code></li>
<li>关闭智能 <code>open_in</code></li>
</ol>
</li>
</ul>
<blockquote>
<p>tips: 这里的状态切换是由动作 1&amp;2&amp;3 共同组成的，这是因为在我们的状态转换表里面 <code>close_in</code> 状态是可以被条件 <code>open</code> / <code>manual</code> 任其一触发转换到其它状态，所以状态 <code>close_in</code> 其实是对应了两个米家智能，这两个智能只能是<strong>同时开启</strong>或<strong>同时关闭</strong>，才能保证自动化不会出现混乱</p>
</blockquote>
<h3 id="close-in"><a href="#close-in" class="headerlink" title="close_in"></a>close_in</h3><ul>
<li>触发条件：门窗传感器开</li>
<li>执行动作：<ol>
<li>关闭智能 <code>close_in</code></li>
<li>关闭智能 <code>close_in.manual</code></li>
<li>开启智能 <code>open_in</code></li>
</ol>
</li>
</ul>
<h3 id="close-in-manual"><a href="#close-in-manual" class="headerlink" title="close_in.manual"></a>close_in.manual</h3><ul>
<li>触发条件：浴室灯 or 排气扇任一关闭（这块可以根据实际需求自行调整）</li>
<li>执行动作：<ol>
<li>关浴室灯 &amp; 排气扇（这块可以根据实际需求自行调整）</li>
<li>关闭智能 <code>close_in</code></li>
<li>关闭智能 <code>close_in.manual</code></li>
<li>开启智能 <code>close_out</code></li>
<li>关闭智能 <code>open_in</code></li>
</ol>
</li>
</ul>
<h3 id="open-in"><a href="#open-in" class="headerlink" title="open_in"></a>open_in</h3><ul>
<li>触发条件：门窗传感器关</li>
<li>执行动作：<ol>
<li>关浴室灯 &amp; 排气扇（这块可以根据实际需求自行调整）</li>
<li>关闭智能 <code>open_in</code></li>
<li>开启智能 <code>close_out</code></li>
</ol>
</li>
</ul>
<p>最后，还记得上面提到的 <strong>关闭 open_in</strong> 这个看似没啥用的动作吗，其实不仅在 <code>close_out</code> 状态中，在除 <code>open_in</code> 外的每一个状态动作执行时都要加上这个动作。这是因为利用米家 APP 的延时模拟时间条件的输入这个是无法取消的，即是说一旦执行了 <code>open_wait.time_elaspe</code>，15s 后必定会打开 <code>open_in</code> 场景，而这时我们的浴室可能处在任何一个状态。为了避免因此导致的混乱，我们才需要在每个状态的动作加入此动作</p>
<blockquote>
<p>tips: 超时效果也可以通过门窗传感器自带的超时未关通知能力来实现，这样就相当于是可中断的，不需要上述的的补偿操作了。但有个问题是，目前我这款传感器好像只支持配置分钟时间粒度</p>
</blockquote>
<p>手机截图如下</p>
<p><img src="/images/toilet_fa/tfa_mihome.JPG" alt="toilet fa scene 1"></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>以上配置对于普通用户（尤其是没有编程基础的）来说还是有些过于复杂了，建议厂家可以将状态机直接集成到门窗传感器中的，用户只要决定用或不用即可。</p>
<p>另外，米家平台提供的基础能力也比较有限（可能是基于易用性及安全性的考虑？），导致很多效果实现起来还是比较困难。不管怎样，希望希望米家能加入一些变量能力，可以通过动作来设置变量值，也可以根据变量值的不同来触发不同的智能，这样会有更高的可玩性。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/记一次 springfox 扩展之旅 —— 动态 api 文档.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="el psy congroo.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Taccisum's blog 😉">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/记一次 springfox 扩展之旅 —— 动态 api 文档.html" class="post-title-link" itemprop="url">记一次 springfox 扩展之旅 —— 动态 api 文档</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-25 15:44:05" itemprop="dateCreated datePublished" datetime="2022-03-25T15:44:05+08:00">2022-03-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-01-04 16:18:48" itemprop="dateModified" datetime="2023-01-04T16:18:48+08:00">2023-01-04</time>
              </span>

          
            <span id="/记一次 springfox 扩展之旅 —— 动态 api 文档.html" class="post-meta-item leancloud_visitors" data-flag-title="记一次 springfox 扩展之旅 —— 动态 api 文档" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/记一次 springfox 扩展之旅 —— 动态 api 文档.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/记一次 springfox 扩展之旅 —— 动态 api 文档.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>出于 <a href="https://github.com/pigeon-cp/pigeon" target="_blank" rel="noopener">Pigeon</a> 项目的需要，我需要把通过插件支持的扩展信息在 swagger api 文档中动态展示出来。</p>
<p>项目使用的是 springfox 框架生成的 swagger 文档，众所周知 springfox 是注解型的文档框架，而且文档内容是直接写死的，不支持动态化，估摸着是需要自己扩展了。</p>
<p>按照惯例，先了解代码架构（由于以前都是使用为主，没有深入了解，也不知道有哪些拓展点）。发现 springfox 其实是在应用启动时 scan 带有 swagger 注解的类和字段，生成一个叫 <code>Documentation</code> 的类，然后通过 mapper 转换成相应的 swagger model（v1.2 or v2）。</p>
<p>可见，我们要分析的 code 可以缩小到 Docuementation 生成的过程，主要关注 @ApiParam, @ApiPropertyModel 这几个注解的解析步骤。</p>
<p>继续深入，发现 Documentation 的生成是通过 DocumentationPlugin 来做的，而调度 plugins 则是在 DocumentationPluginsBootstrapper 中。DocumentationPluginsBootstrapper 又是从哪里被调用的呢？没错，是通过 SpringfoxWebMvcConfiguration scan package <code>springfox.documentation.spring.web.plugins</code> 时被加载到 spring context 中的，由于这是一个 SmartLifecycle，因此会自动执行 <code>#start</code> 方法。在这个方法中会 foreach plugins，通过 plugin 得到的文档 context（context 中包含了 api 信息，而这些信息其实正是 spring mvc 维护着的 request handlers），再经由 scanner scan 整个 context 生成 Documentation 后加入到 DocumentationCache 中，后续通过 <code>/api-v2/docs</code> 接口访问时就是直接从 cache 中去获取到 Documentation 的。</p>
<p>上面提到的 plugins 又是什么呢？这个概念大家可能比较陌生，但只要是用过 springfox 的小伙伴，对 <code>Docket</code> 这个类肯定不陌生。没错，Docket 其实也是实现了 DocumentationPlugin 的一个类，根据官方的描述</p>
<blockquote>
<p>Docket is a builder which is intended to be the primary interface into the Springfox framework.<br>Provides sensible defaults and convenience methods for configuration.</p>
</blockquote>
<p>回归主题，DocumentationPluginsBootstrapper 使用的 scanner 是 ApiDocumentationScanner。追踪源码发现，这个 scanner 中又细分为 ApiListingReferenceScanner（扫描引用 model 的）ApiListingScanner （扫描 apis 的），后者正是关键类。继续深入，在 ApiListingScanner -&gt; ApiDescriptionReader -&gt; ApiOperationReader 中发现，Operation（即维护 api 的路径、参数等具体描述的类）正是在其中通过 20+ OperationBuilderPlugin 组成的 filter 器链共同构建而成。根据名称大概筛选了一下，最终锁定了 OperationParameterReader 这个类。该类在处理参数时又会分成需要 expand 的（@RequestBody 之流）和不需要 expand 的（@ApiParam 直接标注的参数）。</p>
<p>先来看不需要 expand 的，最终会交由 ParameterBuilderPlugin 链处理，因此我简单写了一个扩展</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PigeonExtendParamBuilder</span> <span class="token keyword">implements</span> <span class="token class-name">ParameterBuilderPlugin</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span>ParameterContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">resolvedMethodParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInstanceOf</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">parameterBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">allowableValues</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AllowableListValues</span><span class="token punctuation">(</span>Lists<span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token string">"MAIL"</span><span class="token punctuation">,</span> <span class="token string">"SMS"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"String"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span>DocumentationType documentationType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>跑下程序，果然所有 @ApiParam 标注的 string 类型参数都被加上了 Available values : MAIL, SMS 限制。但在 body 定义里面的参数没有效果，一开始推测是跟上述的 expand 概念有关，但后来发现不是，而是这类参数最终会指向一个 ModelRef，因此应该是与 Model 的解析有关。那 Model 的解析是在什么时候呢，同样是在 <code>ApiListingScanner#scan</code> 方法中，交由 ApiModelReader 完成。 ApiModelReader 会通过由 Spring MVC 维护的 RequestMapping 信息提取 model 信息（例如 @RequestBody, @Requestpart 之流），然后交给  <code>ModelProvied#modelFor</code> 转换成 springfox 的 Model 对象，此 Model 对象即是 ModelRef 引用的 Model。</p>
<p>在 <code>#modelFor</code> 中，会通过反射解析出 Model 对应的 class 中的所有字段信息（称为 ModelProperty），而这个过程则是交给 <code>ModelPropertiesProvider#propertiesFor</code> 完成的，其中细节比较多，但总的来说，最终都是交由 <code>ModelPropertyBuilderPlugin</code> 链来处理的，这个类也正是我们要找的扩展点。后续简单验证了一下，确实是有效的。</p>
<p>最终效果：TODO</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/thinking_about_cost_of_communication.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="el psy congroo.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Taccisum's blog 😉">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/thinking_about_cost_of_communication.html" class="post-title-link" itemprop="url">有关沟通成本的一点点思考</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-11-22 15:59:59" itemprop="dateCreated datePublished" datetime="2021-11-22T15:59:59+08:00">2021-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-12-06 11:15:42" itemprop="dateModified" datetime="2021-12-06T11:15:42+08:00">2021-12-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/个人思考/" itemprop="url" rel="index"><span itemprop="name">个人思考</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/个人思考/软件工程/" itemprop="url" rel="index"><span itemprop="name">软件工程</span></a>
                </span>
            </span>

          
            <span id="/thinking_about_cost_of_communication.html" class="post-meta-item leancloud_visitors" data-flag-title="有关沟通成本的一点点思考" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/thinking_about_cost_of_communication.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/thinking_about_cost_of_communication.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>团队协作最大的成本是沟通成本。如何降低沟通成本，是管理者需要持续思考的问题。</p>
</blockquote>
<p>日常沟通的本质，究其根本其实是由<strong>一系列的逻辑推理构成</strong>。而所谓的达成一致意见，即是我们<strong>对同一个命题推导出了同样的结论</strong>。</p>
<p>对于这一点，可能有些同学并不认同。这是因为我们的交流往往不会以十分正式的逻辑推理过程进行，而是更多的<strong>口语化</strong>进行。</p>
<p><strong>比方说</strong>：今天应该会下雨。这样简单的一句话就包括了逻辑推理，只是大前提小前提均没有明确而以，需要我们根据当时聊天的语境来确定。假如你是因为昨天看了天气预报，那你的大前提是：按以往经验，如果天气预报预测说会下雨，那大概率会下雨；小前提是：昨天的天气预报说今天会下雨；结论就是：今天应该会下雨。如果换一种场景，是因为你看到今天的天空，那你的大前提是：阴云密布的天气大概念会下雨；小前提是：今天是阴天；结论就是：今天应该会下雨。</p>
<p>可见，简单的一句话，也是包含了完整的逻辑推理在内的。只不过出于方便，我们在交流时往往会简化许多步骤，并通过我们的大脑运算去补全其它的信息。否则，我们在沟通时的对话便会冗长而啰嗦，<strong>有效信息比低</strong>，因而沟通成本高。</p>
<p>但这样做也有缺点，就是我们有可能意会错别人的意思，这时就出现了所谓的<strong>误解</strong>。</p>
<p>假设甲对乙说今天应该会下雨，实际上是因为甲昨天看了天气预报。但乙并没有看，而且乙今天出门时看到天气晴朗，因此并不同意甲的说法。此时要保证沟通顺畅，需要甲补充自己的大前提。如果甲也并没有意识到这个问题，不去向乙解析清楚，那么两个人之间就产生了分岐，产生的原因是沟通中信息的缺失。</p>
<p>除了信息缺失外，<strong>信息畸变</strong>（想要传递的信息，因为表述不当，导致别人理解错误）也会带来误解，这可能是有意的（偷换概念），也可能是无意的（混淆概念），但导致的结果一样。像同样是偷，偷窃、偷笑就完全不是同一个概念。</p>
<p>上面讨论的是在信息传递本身，但如果沟通本身<strong>缺少主题</strong>（即没有要讨论的命题），自然也谈不上得出结论，就是在白白浪费时间而以。</p>
<p>知道了原因，我们便可以确定下来沟通中<strong>应尽力遵守的一些原则</strong>：</p>
<ul>
<li><strong>讨论前确定命题</strong>（有时比较迷茫的时候，想借讨论过程本身找到问题其实也是一个命题）</li>
<li><strong>尽可能使用术语</strong>（术语即是某个领域中的专用概念，保证双方都理解术语的前提下，使用术语可以很有效地降低沟通成本）</li>
<li><strong>尽可能复用现有术语</strong>（少用一些不常见或自创的概念）</li>
<li><strong>有意识地创造一些概念</strong>，但需要做到<ul>
<li>尽力保证其定义准确</li>
<li>做好概念普及工作，让团队能在一个上下文沟通</li>
<li>一经确定便不要再修改，这容易带来混乱</li>
</ul>
</li>
<li><strong>避免大量创造不准确、难以理解的概念</strong>（这点在编码中的类、方法、变量命名尤为常见）</li>
</ul>
<h2 id="用人过程中常见的雷区"><a href="#用人过程中常见的雷区" class="headerlink" title="用人过程中常见的雷区"></a>用人过程中常见的雷区</h2><h3 id="专业基础太差"><a href="#专业基础太差" class="headerlink" title="专业基础太差"></a>专业基础太差</h3><p>专业基础太差的另一种解释是：<strong>对这个专业领域的概念理解得太少</strong>。</p>
<p>这会导致你在解释一些问题给他听的时候，需要费非常大的工夫。因为逻辑推理是一层嵌一层的结果，一个上层概念往往是由无数下层概念支撑起来的，如果他对下层概念的理解不够，他是很难去理解一个上层概念的。</p>
<p>我听到很多朋友问过我一个问题：什么是 Java？内行人士可能完全能理解什么是 Java，但是如果让你向外行解释清楚，你会发现这其实是很困难的一件事。</p>
<p>这是为什么？因为<strong>我们要真正理解一个概念，不仅要知道其定义，更要理解其内涵</strong>。</p>
<p>Java 是一个上层概念，它是一门静态的、面向对象的编程语言。但如果你照搬此定义向你的朋友解释，他听完肯定依然一脸懵圈。要对这个概念有深刻的理解，你首先要理解更下一层的概念：语法、框架、虚拟机、IDE 等等。而要理解下一层的概念又要理解更下一层的概念，比如：</p>
<ul>
<li>语法的下一层概念有：修饰符、关键字、变量、常量、类、方法等等</li>
<li>虚拟机的下一层概念有：字节码、堆、栈、class 文件、垃圾回收、操作系统、等等</li>
</ul>
<p>如此循环往复，每个上层概念都会牵扯出一堆组成<strong>树状结构</strong>的概念，在不理解底层概念的情况下试图直接去理解上层概念，那必然会非常困难而且理解得也不深刻。</p>
<p>这些下层的概念其实都已经内化在内行人士心中了，所以跟他们交流时无需过多地解释。但对于外行则完全不一样，这就导致很多时候我们面对这种问题非常无奈。</p>
<h3 id="理解能力太差"><a href="#理解能力太差" class="headerlink" title="理解能力太差"></a>理解能力太差</h3><p>专业基础差还有一种情况，就是许多概念都知道一点，但不深入，或者理解有错误。这种情况其实比上面更可怕，不懂的人会直接表现出来，而理解有偏差的人，不仅不会表现出来，他们往往还会表现得自己是正确的一样，进而把不明就理的人带歪。</p>
<p>这也是为什么有人主张在面试的时候，遇到不懂的问题，直接说不懂也好过硬答。</p>
<h3 id="学习能力太差"><a href="#学习能力太差" class="headerlink" title="学习能力太差"></a>学习能力太差</h3><p>这是个信息爆炸的时代，每天都有新的知识产生、旧的知识消失，学习能力差的人终究会逐渐无法跟上时代的脚步。</p>
<p>但这个问题会在相对而言的中长期才体现出来，应该视团队当前情况决定是否要与此类人共事。</p>
<h3 id="三观不合"><a href="#三观不合" class="headerlink" title="三观不合"></a>三观不合</h3><p>所谓三观不合，其实是在一些<strong>基础认知上存在分岐</strong>。比如甲是一个追求完美的人，而乙是一个得过且过的人，那他们在同一个问题上就很可能出现意见不合。而所谓江山易改、本性难移，基础认知是没那么容易改变的。多数人在某一个团队工作短则几月长也就几年，这点时间你是很难去改变一个人的。</p>
<p>最好的方法是不要与三观不合的人一起共事，这并不一定因为他的认知是错的，只是你们不适合。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/ddd_practice_in_java_server_side.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="el psy congroo.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Taccisum's blog 😉">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ddd_practice_in_java_server_side.html" class="post-title-link" itemprop="url">DDD 战术设计之 Java 服务端落地简要方案探讨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-11-16 16:04:22" itemprop="dateCreated datePublished" datetime="2021-11-16T16:04:22+08:00">2021-11-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-01-04 16:26:00" itemprop="dateModified" datetime="2023-01-04T16:26:00+08:00">2023-01-04</time>
              </span>

          
            <span id="/ddd_practice_in_java_server_side.html" class="post-meta-item leancloud_visitors" data-flag-title="DDD 战术设计之 Java 服务端落地简要方案探讨" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/ddd_practice_in_java_server_side.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/ddd_practice_in_java_server_side.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>DDD 全称<strong>领域驱动设计</strong>，最初由 Eric Evans 提出。此文章仅探讨 DDD 在 Java 服务端的落地可行性简要方案，以期不需要太过复杂的前期准备也能够快速在项目中运用 DDD 编写代码</p>
<p>注意，此文章：</p>
<ul>
<li>假定读者有一定的 DDD 理论基础</li>
<li>假定读者有 Java 服务端开发经验，并掌握主流的开发框架（如 Spring），本文的许多章节将会结合这些框架进行实现</li>
<li>以经典的 RBAC 权限模型为示例进行 DDD 建模</li>
</ul>
<h3 id="DDD-编写的代码所属层次"><a href="#DDD-编写的代码所属层次" class="headerlink" title="DDD 编写的代码所属层次"></a>DDD 编写的代码所属层次</h3><p>我们把 DDD 设计的相关代码放到 Domain 层，这一层是介于经典三层架构中 Service 与 DAO 层之间的特殊的一层，但严格意义上来说还是属于 Service 层（处理业务逻辑），可以想象成在原先的 Service 层上又划分了一层出来。</p>
<p>如下图所示</p>
<p>TODO::</p>
<p>示例<br>下面是我们在 JAVA 工程中采用的一个 DDD 包结构规范</p>
<p>TODO::</p>
<p>如果是现有项目，可以在与 controller, service 平级的 package 中再创建一个 domain，这样做的好处是不需要改动现有代码，domain 与 service 可以共存</p>
<p>TODO::</p>
<p>也可以设计得更复杂，但成本较高，一般建议在新的、核心的项目中使用</p>
<p>TODO::</p>
<h2 id="核心概念的落地"><a href="#核心概念的落地" class="headerlink" title="核心概念的落地"></a>核心概念的落地</h2><h3 id="实体"><a href="#实体" class="headerlink" title="实体"></a>实体</h3><blockquote>
<p>以标识作为其基本定义的对象称为实体 - Eric Evans </p>
</blockquote>
<p>实体至少有两个字段：唯一标识 <code>id</code> 和 负责该实体持久化工作的 <code>DAO</code>。</p>
<p>服务端比较流行 ORM 框架（如 MyBatis），这些框架操作的数据对象（DO）往往是一些纯数据模型，不适合将实体与 DO 混用，最好是以实体依赖 DO 的方式设计，将 DO 定位为存储实体属性的承载者</p>
<p>最终得到一个最小的实体定义如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> UserDAO dao<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span>Long id<span class="token punctuation">,</span> UserDAO dao<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dao <span class="token operator">=</span> dao<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> UserDO <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dao<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">sayhello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" say: hello."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用时的代码如下</p>
<pre class="line-numbers language-java"><code class="language-java">User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>1L<span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">sayhello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>实际项目中，实体往往还有很多其它依赖，而且随着业务的发展依赖还会不断增多。依赖多了以后，实体的构造就成了一个大问题，不可能再以 new 的方式去创建实体。因此，需要引入工厂的概念，这将在下文讨论</p>
<h4 id="实体与数据对象的关系"><a href="#实体与数据对象的关系" class="headerlink" title="实体与数据对象的关系"></a>实体与数据对象的关系</h4><p>初学者的经常存在一个误区是，喜欢把实体与数据对象（或者说数据库表设计）一一对应起来。这种观念一定要纠正过来，在这里给出的建议是：实体的设计要更多从业务概念的角度去考虑（比如从技术的角度可能会细分出 user_info, user_ext, user_login_history 等等数据对象，但从业务的角度其实都应该是对应到用户这一个实体）。</p>
<p>常见的有以下情况</p>
<ul>
<li>一个实体的属性拆分为多张表存储</li>
<li>实体之间的关联关系信息</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDAO</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> UserInfoMapper userInfoMapper<span class="token punctuation">;</span>
    <span class="token keyword">private</span> UserExtMapper userExtMapper<span class="token punctuation">;</span>
    <span class="token keyword">private</span> UserLoginHistoryMapper userLoginHistoryMapper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> UserDO <span class="token function">selectById</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">build</span><span class="token punctuation">(</span>
            userInfoMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
            userExtMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
            userLoginHistoryMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>多封装一层 DAO 可以屏蔽持久化的底层实现，方便后续替换（比如某天要对现有服务进行拆分，只需将 mapper 替换成 feign client 即可），但同时也会增加工作量。</p>
<p>一种更加简便的方式是直接在实体中引用 mapper 进行操作。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> UserInfoMapper userInfoMapper<span class="token punctuation">;</span>
    <span class="token keyword">private</span> UserExtMapper userExtMapper<span class="token punctuation">;</span>
    <span class="token keyword">private</span> UserLoginHistoryMapper userLoginHistoryMapper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> UserDO <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此外，出于高内聚考虑，实体不应该直接操作不属于自己管辖的数据对象。如，User 不应该通过 RoleMapper 直接操作 RoleDO</p>
<h4 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h4><p>考虑到在服务端开发中，有状态的对象朝生夕灭的情况非常常见（服务端要管理的对象非常多，不可能将所有实体都存在内存中，一般一个请求过来时会创建对象，请求结束后在下一次 GC 这个对象就会被销毁），而实体之间的关联可能是非常复杂的，每次使用时都构建一个完整的聚合非常不划算，比较建议实体间的聚合采用软关联的方式</p>
<p>可以看到以下两种方式的区别：</p>
<h5 id="硬关联"><a href="#硬关联" class="headerlink" title="硬关联"></a>硬关联</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>Role<span class="token operator">></span> roles<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span>Long id<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Role<span class="token operator">></span> roles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>roles <span class="token operator">=</span> roles<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Role<span class="token operator">></span> <span class="token function">listAllRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>roles<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="软关联"><a href="#软关联" class="headerlink" title="软关联"></a>软关联</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> RoleRepository roleRepo<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span>Long id<span class="token punctuation">,</span> RoleRepository roleRepo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>roleRepo <span class="token operator">=</span> roleRepo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Role<span class="token operator">></span> <span class="token function">listAllRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>roleRepo<span class="token punctuation">.</span><span class="token function">listAllByUserId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>两者在使用方式并没有区别</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span>Role role <span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token function">listAllRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    role<span class="token punctuation">.</span><span class="token function">dosomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="工厂"><a href="#工厂" class="headerlink" title="工厂"></a>工厂</h3><p>虽然在上面我们采用了软关联的方式建立实体之间的引用关系，但这并不代表要构建一个实体就非常简单了，原因是我们的实体除了依赖其它实体外，往往还需要依赖许多其它对象（如领域服务、仓储、DAO 等），并且随着业务的变化，实体的依赖往往还会随之发生变化，如果还是通过传统的 new 方式去创建一个实体，会产生一些灾难性的问题：</p>
<ul>
<li>使用者必须清楚实体的创建细节，这会大大增加代码的复杂度</li>
<li>每当实体的构造方式发生变化时，不得不调整所有创建实体的代码逻辑以解决代码编译问题</li>
</ul>
<p>这个时候就需要引入工厂（Factory）的概念了，一个通用 Factory 的实现示例如下</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Factory</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> UserRepository userRepo<span class="token punctuation">;</span>

    <span class="token keyword">public</span> User <span class="token function">getUser</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> userRepo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结合 Spring，可以把实体的依赖注入做得更简单，并且在实体 User 的依赖变化后不需要做任何代码变更</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Factory</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> User <span class="token function">getUser</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        SpringUtils<span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// 结合 AOP 可以进一步简化装配逻辑</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="实体仓储（Repository）-TODO"><a href="#实体仓储（Repository）-TODO" class="headerlink" title="实体仓储（Repository） TODO::"></a>实体仓储（Repository） TODO::</h3><p>仓储可以为使用者提供实体的创建、删除及条件查询操作。在 C/S 中，仓储还要负责内存中的实体的更新（保证数据一致性）及缓存管理（防止频繁地重复创建，影响性能）</p>
<p>在 B/S 架构中，我们将实体与数据对象分离，因此数据一致性问题交给 ORM 去控制即可，仓储</p>
<p>仓储往往依赖 DAO（查询持久化数据）及工厂（创建实体），并且应可以发布领域事件。</p>
<pre class="line-numbers language-java"><code class="language-java">
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="领域服务"><a href="#领域服务" class="headerlink" title="领域服务"></a>领域服务</h3><p>领域服务用于处理一些在概念上不属于实体的操作，这些操作本质上往往是一些活动或行为，并且是无状态的。对于这类操作，将其强制进行归类会显得非常别扭，于是便引入了领域服务这一概念。</p>
<p>需要明确的是，其与三层架构的 Service 层（业务逻辑层）并不是一个概念。另外与 Evans 在书中提及的示例不同，为了避免混乱，一般不建议为领域服务的类命名加上 Service 后缀。<br>可以简单理解为，领域中没有任何实体适合承载该职责，因此我们创造了一个『实体』来承担，只不过这个特殊的『实体』是一个无状态的单例而以。</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>在某个应用中，由于用户量较大，用户登录历史可能会逐渐变得非常庞大，因此需要需要定时查找超过 15 天的记录并将其清理。</p>
<p>显然，我们需要完成的这个操作无法归类到任何一个实体中，因此我们需要一个名为 LoginHistoryClearer 的领域服务来承接此职责</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Compoment</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginHistoryClearer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> UserRepository userRepo<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearOutDated</span><span class="token punctuation">(</span>Integer interval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>User user <span class="token operator">:</span> userRepo<span class="token punctuation">.</span><span class="token function">listAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            user<span class="token punctuation">.</span><span class="token function">removeOutDatedLoginHistory</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在其它地方，我们可以直接注入该领域服务，并使用</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserScheduledTask</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> LoginHistoryClearer clearer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${exec.output.interval.days:15}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> Integer intervalDays<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0 0 0 * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteExecData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"starting clear out dated data, intervalDays=>{}"</span><span class="token punctuation">,</span> intervalDays<span class="token punctuation">)</span><span class="token punctuation">;</span>
        clearer<span class="token punctuation">.</span><span class="token function">clearOutDated</span><span class="token punctuation">(</span>intervalDays<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"clear out dated data end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="领域事件"><a href="#领域事件" class="headerlink" title="领域事件"></a>领域事件</h3><p>在我们的领域活动（实体、仓储等操作）中会出现一系列的重要的事件，而这些事件的订阅者，往往需要对这些事件作出响应（例如，新增用户后，可能会触发一系列动作：发送欢迎信息、发放优惠券等等）。领域事件可以简单地理解为是发布订阅模式在 DDD 中的一种运用。</p>
<p>在我们的实践中，一般采用事件总线来快速地发布一个领域事件。</p>
<p>事件总线的接口定义一般如下</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">EventBus</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">post</span><span class="token punctuation">(</span>Event event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>通过调用 EventBus.post() 方法，我们可以快速发布一个事件。</p>
<p>同时我们还会提供一个抽象类 AbstractEventPublisher </p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AbstractEventPublisher</span> <span class="token keyword">implements</span> <span class="token class-name">EventPublisher</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> EventBus eventBus<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEventBus</span><span class="token punctuation">(</span>EventBus eventBus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventBus <span class="token operator">=</span> eventBus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span>Event event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventBus <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eventBus<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"event bus is null. event "</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" will not be published!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">EventPublisher</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span>Event event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这样我们可以让实体或 Manager 继承自 AbstractEventPublisher，其便有了发布事件的能力。至于如何订阅并处理这些事件，取决于 EventBus 的实现方式。举个例子，我们一般使用 Guava 的 EventBus，定义相关的 handler 并注册到 EventBus 中便可方便地处理这些事件</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DomainEventBus</span> <span class="token keyword">extends</span> <span class="token class-name">EventBus</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> FooEventHandler fooEventHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>fooEventHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FooEventHandler</span> <span class="token keyword">implements</span> <span class="token class-name">DomainEventHandler</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Subscribe</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listen</span><span class="token punctuation">(</span>ProjectCreatEvent e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// do something here...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其它<br>TODO::<br>● ddd-support</p>
<h3 id="DDD-设计"><a href="#DDD-设计" class="headerlink" title="DDD 设计"></a>DDD 设计</h3><p>理解了 DDD 中的全部概念，也并不意味着就能做出一个好的设计了。</p>
<!-- DDD 设计中最重要的其实是实体的定义， -->
<p>DDD 的设计最重要的是做好以下几点：</p>
<ol>
<li>准确地定义实体</li>
<li>准确地定义实体应该有哪些方法</li>
<li>确立实体与实体之间的关系</li>
</ol>
<p>实体的设计其实是一个建模的过程。面向对象的设计方法本质就是将现实世界的对象关系以简化的形式提炼为模型。关于这一块，已经是一个更大的话题了，不在这里讨论。</p>
<p>案例工程<br>TODO::</p>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><h3 id="与现有三层架构是否冲突"><a href="#与现有三层架构是否冲突" class="headerlink" title="与现有三层架构是否冲突"></a>与现有三层架构是否冲突</h3><p>并不冲突， 甚至是可以混用的</p>
<h3 id="事务问题如何解决"><a href="#事务问题如何解决" class="headerlink" title="事务问题如何解决"></a>事务问题如何解决</h3><p>实体操作是可以兼容 JDBC 事务，在编排实体的应用层中加上 Spring 事务注解 @Transaction 即可</p>
<h3 id="重复查询的性能问题"><a href="#重复查询的性能问题" class="headerlink" title="重复查询的性能问题"></a>重复查询的性能问题</h3><p>如下，会执行三次数据库查询</p>
<pre class="line-numbers language-java"><code class="language-java">log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>实际项目中，应使用带缓存的 ORM 框架（如 MyBatis），这样便可避免同一事务中重复查询带来的性能问题。否则应注意优化编码方式，如下</p>
<pre class="line-numbers language-java"><code class="language-java">UserDO data <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="复杂查询场景下的性能问题"><a href="#复杂查询场景下的性能问题" class="headerlink" title="复杂查询场景下的性能问题"></a>复杂查询场景下的性能问题</h3><p>DDD 要求将数据对象转换为内存中的实体对象后再进行业务操作，这注定了 DDD 不擅长批量查询以及联表查询等复杂的查询场景。业界采用的方案是 CQRS 模式，将查询操作从领域模型中分离出去。</p>
<p>要实现也很简单，有查询业务时，直接定义一个相应的 Service，在里面操作数据库完成查询即可。</p>
<p>更复杂一点，可以专门为查询操作开一个微服务，实现物理上的分离。</p>
<p>示例如下</p>
<p>不分离，会存在对 dto, vo 等对象的直接引用，导致领域模型被污染</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>UserLoginHistoryVO<span class="token operator">></span> <span class="token function">queryLoginHistory</span><span class="token punctuation">(</span>QueryDTO dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> dao<span class="token punctuation">.</span><span class="token function">queryLoginHistory</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分离后，查询操作转移到专门的查询 Service 中</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserQueryService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>UserLoginHistoryVO<span class="token operator">></span> <span class="token function">queryLoginHistory</span><span class="token punctuation">(</span>QueryDTO dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> dao<span class="token punctuation">.</span><span class="token function">queryLoginHistory</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/how_to_manage_a_complex_software_system.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="el psy congroo.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Taccisum's blog 😉">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/how_to_manage_a_complex_software_system.html" class="post-title-link" itemprop="url">程序猿加班真的是常态吗? —— 浅谈如何治理一个复杂软件系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-11-09 17:37:42" itemprop="dateCreated datePublished" datetime="2021-11-09T17:37:42+08:00">2021-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-12-06 11:15:39" itemprop="dateModified" datetime="2021-12-06T11:15:39+08:00">2021-12-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/个人思考/" itemprop="url" rel="index"><span itemprop="name">个人思考</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/个人思考/软件工程/" itemprop="url" rel="index"><span itemprop="name">软件工程</span></a>
                </span>
            </span>

          
            <span id="/how_to_manage_a_complex_software_system.html" class="post-meta-item leancloud_visitors" data-flag-title="程序猿加班真的是常态吗? —— 浅谈如何治理一个复杂软件系统" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/how_to_manage_a_complex_software_system.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/how_to_manage_a_complex_software_system.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>经常听到一些<strong>程序猿加班是常态</strong>的言论，在这里我想尝试下进行反驳。</p>
<p>先来分析一下这个命题：</p>
<blockquote>
<p>程序猿加班是常态 =&gt; 程序猿的工作量巨大 =&gt; 软件系统过于复杂，难以处理。</p>
</blockquote>
<p>可见，反驳这个命题的关键就在于回答『<strong>如何治理一个复杂的软件系统</strong>』这个问题。</p>
<p>接下来深入看下这个问题。<strong>软件系统是什么</strong>？我认为软件系统无非是一个<strong>巨大的逻辑体</strong>。你的任何操作（如点击 web 的一个按钮），其实背后都是一层又一层的逻辑堆砌的结果。</p>
<p>以浏览器渲染一个按钮（<code>&lt;button&gt;click&lt;/button&gt;</code>）为例，这其实是浏览器解析 HTML 代码的结果。HTML 本身是有逻辑可循的，你必须要按照他的规则编写才能正确地展示 UI，而 HTML 本身又需要浏览器进行解析，这个过程需要用到许多更低一层的逻辑（比如语法解释器，比如图形渲染的接口），这些被依赖的逻辑本身又会依赖更底层的逻辑（比如显卡接口）。 这些逻辑一层嵌一层的，直至最底层的 CPU 指令集。</p>
<p><strong>因此任何一个复杂系统，本质上其实就是一个庞大的逻辑体</strong>。而这个逻辑体，必然是<strong>分层</strong>的（你见过谁直接用 GPU 的接口来渲染网站吗），否则描述它的复杂度就是<strong>指数级增长</strong>了，以人脑的计算能力很快就无法处理这么复杂的系统了（这就好比在概率论里面，让你连续抛掷10次硬币，再用文字表示其样本空间，你要是用枚举法来表示，可能得写到手软，但要是用笛卡尔积来表示，只需要一行即可）。</p>
<p>整个网站开发，其实也是分层的，其中最经典的莫过于<strong>三层架构</strong>了（视图层、业务逻辑层、持久层），演化到今天，视图层独立出去成了前端领域，业务逻辑与持久层则归为后端领域（当然，还有更底层的东西，比如说数据库，操作系统，只是大多数开发仔都不需要参与这一块的开发）。</p>
<p>看起来很完美，前人已经把分层都设计好了，并且那些高难度的底层开发工作往往也有开源组织在承担，稳定性都是经过验证的。我们做应用开发的，只要搞定视图层（前端）跟业务逻辑层（后端）不就好了吗？这点事情都搞不定吗？问题究竟出在哪呢？</p>
<p>其一是，<strong>单独某一层内的复杂度，其实很多时候是超乎我们想象的，因此需要进一步分层</strong>。</p>
<p>以业务逻辑层为例，一个简单的用户注册，可能就包括了验证码校验，密码复杂度检测，手机绑定，注册成功欢迎邮件发送，发放优惠券等等业务逻辑，以及缓存、冗余之类的非业务逻辑。这些被依赖的逻辑其实也是同属于业务逻辑层的，并且也会被其他业务逻辑依赖，一旦没有做好划分，那又是重复造轮子，复杂度和工作量都会指数级增长！关于这一块，不同领域的解决方案不同，前端是组件化，而后端是面向对象（虽然是很标准的答案，但我认为真正掌握这两技能的研发同学其实很少，最典型的莫过于拿着面向对象语言，写着面向过程代码），非要抽象出一个更通用的方案的话，我认为可以称之为『<strong>建模</strong>』。前端通过建模，将视图层进一步分拆出<strong>组件层</strong>；后端通过建模，将业务逻辑层进一步分拆出<strong>领域模型层</strong>（在微服务架构中亦称之为<strong>业务中台</strong>）。</p>
<p>其二则是工程问题了，即<strong>沟通成本的问题</strong>。举个例子，HTML 语言提供了 button 标签，但这个标签除了渲染一个按钮外，还会同时渲染一个文本输入框给我们。这显然不是我们需要的，好在这个标签同时提供了一个配置给我们，可能显式地指定避免渲染文本框（额外的工作是你需要指定该配置 <code>&lt;button disable-input=&#39;true&#39;&gt;click&lt;/button&gt;</code>）。这样子虽然最终实现了想要的效果，但却让代码变得不优雅，不仅你花费了不必要的时间，还导致后来的维护者看到会迷惑，沟通成本由此产生。 尝试把这个现象无限放大，如果你在代码中看到的每一个概念定义都是不可信的，都是与现实世界有偏差的，那么当你要解决一个问题或开发一个新功能的时候，你工作中花在的这些无谓的沟通中的时间就会成倍地提升（尤其是当没有人或文档能解答你的问题的时候），最终远远大于你的编码时间。</p>
<p>问题分析到这，答案也就出来了。如何治理一个复杂的软件系统？私以为<strong>关键在于做好模型设计，以及维护好概念一致性</strong>。前者可以通过组合逻辑空间的不同维度，使得复杂度的表示难度指数下降，最终达到人脑可以处理的水平。后者则保证模型中的概念跟现实世界是一致的，易于理解，可减少不必要的沟通成本。两者任一没有处理好，均会导致复杂度指数上升，进而导致工作量增大，因此程序猿加班也就成了常态了。经常加班的猿们，都应该先反问下自己，这两点是不是都做得足够好了？如果是，再来问是不是人手不够之类的问题。</p>
<p>当然现实往往更复杂，很多同学都会以业务方不给时间，上级不支持为由，写出一堆烂代码来。确实这也是一些阻力，但并不能成为人云亦云的借口。有这种想法的同学，要么是选择躺平了，不想去改变现状；要么是缺乏对事物发展规律的认识的，推荐学习一下教员的《<strong>矛盾论</strong>》。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/my_swagger_spring_boot_starter.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="el psy congroo.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Taccisum's blog 😉">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my_swagger_spring_boot_starter.html" class="post-title-link" itemprop="url">一个很好用的Spring Boot Starter Swagger</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-02-14 14:17:43" itemprop="dateCreated datePublished" datetime="2019-02-14T14:17:43+08:00">2019-02-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-13 18:05:01" itemprop="dateModified" datetime="2020-03-13T18:05:01+08:00">2020-03-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/framework/" itemprop="url" rel="index"><span itemprop="name">framework</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/framework/starter/" itemprop="url" rel="index"><span itemprop="name">starter</span></a>
                </span>
            </span>

          
            <span id="/my_swagger_spring_boot_starter.html" class="post-meta-item leancloud_visitors" data-flag-title="一个很好用的Spring Boot Starter Swagger" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/my_swagger_spring_boot_starter.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/my_swagger_spring_boot_starter.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Spring-Boot-Starter-Swagger"><a href="#Spring-Boot-Starter-Swagger" class="headerlink" title="Spring Boot Starter Swagger"></a>Spring Boot Starter Swagger</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Swagger与Spring Boot现在在Java Web开发领域是再常用不过的两个框架了。集成这两者的Starter现在在Github上也存在很多（基本都是非官方的，官方好像没有提供Starter），但是大多数或多或少都存在以下问题：</p>
<ul>
<li><strong>整合程度低</strong>，许多Springfox-Swagger2提供的功能无法通过Spring Boot的方式进行配置或者配置方式复杂</li>
<li><strong>项目疏于维护</strong>，许多Issue没人去解决</li>
<li><strong>扩展性不足</strong>，当用户出现一些需求时只能祈求项目更新或者自行修改源码</li>
<li><strong>无法同时兼容Spring Boot1.x和Spring Boot2.x</strong></li>
</ul>
<p>我曾在Github上找了许久都没找到，索性自行开发了一个。</p>
<p>这个Starter具有以下特点：</p>
<ul>
<li>完美适配springfox-swagger2，几乎支持通过yaml文件进行所有配置</li>
<li>提供拦截器，允许用户自行扩展自定义配置</li>
<li>同时支持spring boot1和spring boot2</li>
<li>扩展了一些小功能，如展示当前hostname等</li>
</ul>
<p><a href="https://github.com/taccisum/spring-boot-starter-swagger" target="_blank" rel="noopener"><strong>项目地址</strong></a></p>
<h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><p>引入依赖</p>
<p><strong>pom.xml</strong></p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- spring boot1用户 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.github.taccisum<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>swagger-spring-boot1-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>{lastest.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment" spellcheck="true">&lt;!-- spring boot2用户 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.github.taccisum<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>swagger-spring-boot2-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>{lastest.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>application.yml</strong></p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">swagger</span><span class="token punctuation">:</span>
  <span class="token key atrule">base-package</span><span class="token punctuation">:</span> com.github.taccisum.controller
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动项目，打开 <a href="http://localhost:8080/swagger-ui.html" target="_blank" rel="noopener">http://localhost:8080/swagger-ui.html</a> 即可查看API文档。</p>
<p>更多功能可以到 <a href="https://github.com/taccisum/spring-boot-starter-swagger" target="_blank" rel="noopener">https://github.com/taccisum/spring-boot-starter-swagger</a> 了解。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/sourece/flowable/startup/spring_boot.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="el psy congroo.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Taccisum's blog 😉">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/sourece/flowable/startup/spring_boot.html" class="post-title-link" itemprop="url">flowable启动流程解析（spring boot）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-10 17:56:00" itemprop="dateCreated datePublished" datetime="2018-12-10T17:56:00+08:00">2018-12-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-13 18:05:01" itemprop="dateModified" datetime="2020-03-13T18:05:01+08:00">2020-03-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/source/" itemprop="url" rel="index"><span itemprop="name">source</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/source/flowable/" itemprop="url" rel="index"><span itemprop="name">flowable</span></a>
                </span>
            </span>

          
            <span id="/sourece/flowable/startup/spring_boot.html" class="post-meta-item leancloud_visitors" data-flag-title="flowable启动流程解析（spring boot）" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/sourece/flowable/startup/spring_boot.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/sourece/flowable/startup/spring_boot.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>flowable engine一共有5种：App, CMMN, DMN, Form, Process(即BPMN)。</p>
<p><code>flowable-spring-boot-starter</code>提供了零配置集成flowable的功能，主要包括各类型engine的自动配置、流程/表单定义自动部署，其次还有rest-api，spring boot aucuator集成等。</p>
<p>这篇文章主要是解析flowable在spring boot环境下的启动流程，不涉及flowable内部原理。</p>
<h1 id="flowable相关的AutoConfiguration"><a href="#flowable相关的AutoConfiguration" class="headerlink" title="flowable相关的AutoConfiguration"></a>flowable相关的AutoConfiguration</h1><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># flowable-spring-boot-autoconfigure: spring.factories</span>

<span class="token attr-name">org.springframework.boot.env.EnvironmentPostProcessor</span><span class="token punctuation">=</span><span class="token attr-value">\
  org.flowable.spring.boot.environment.FlowableDefaultPropertiesEnvironmentPostProcessor,\
  org.flowable.spring.boot.environment.FlowableLiquibaseEnvironmentPostProcessor</span>

<span class="token comment" spellcheck="true"># Flowable auto-configurations</span>

<span class="token attr-name">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="token punctuation">=</span><span class="token attr-value">\
    org.flowable.spring.boot.actuate.info.FlowableInfoAutoConfiguration,\
    org.flowable.spring.boot.EndpointAutoConfiguration,\
    org.flowable.spring.boot.RestApiAutoConfiguration,\
    org.flowable.spring.boot.app.AppEngineServicesAutoConfiguration,\
    org.flowable.spring.boot.app.AppEngineAutoConfiguration,\
    org.flowable.spring.boot.ProcessEngineServicesAutoConfiguration,\
    org.flowable.spring.boot.ProcessEngineAutoConfiguration,\
    org.flowable.spring.boot.FlowableJpaAutoConfiguration,\
    org.flowable.spring.boot.form.FormEngineAutoConfiguration,\
    org.flowable.spring.boot.form.FormEngineServicesAutoConfiguration,\
    org.flowable.spring.boot.content.ContentEngineAutoConfiguration,\
    org.flowable.spring.boot.content.ContentEngineServicesAutoConfiguration,\
    org.flowable.spring.boot.dmn.DmnEngineAutoConfiguration,\
    org.flowable.spring.boot.dmn.DmnEngineServicesAutoConfiguration,\
    org.flowable.spring.boot.idm.IdmEngineAutoConfiguration,\
    org.flowable.spring.boot.idm.IdmEngineServicesAutoConfiguration,\
    org.flowable.spring.boot.cmmn.CmmnEngineAutoConfiguration,\
    org.flowable.spring.boot.cmmn.CmmnEngineServicesAutoConfiguration,\
    org.flowable.spring.boot.ldap.FlowableLdapAutoConfiguration,\
    org.flowable.spring.boot.FlowableSecurityAutoConfiguration</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看起来比较多，不过大多数AutoConfiguration逻辑还是比较简单的。</p>
<h1 id="engine自动配置"><a href="#engine自动配置" class="headerlink" title="engine自动配置"></a>engine自动配置</h1><p>各engine的配置方式大同小异，以ProcessEngine为例，其涉及到的AutoConfiguration主要是</p>
<ul>
<li>ProcessEngineAutoConfiguration</li>
<li>ProcessEngineServicesAutoConfiguration</li>
</ul>
<h2 id="ProcessEngineAutoConfiguration"><a href="#ProcessEngineAutoConfiguration" class="headerlink" title="ProcessEngineAutoConfiguration"></a>ProcessEngineAutoConfiguration</h2><p>ProcessEngineAutoConfiguration类图</p>
<p><img src="/images/flowable/class_diagram_ProcessEngineAutoConfiguration.png" alt="ProcessEngineAutoConfiguration"></p>
<p>从红框部分可以看到，在ProcessEngineAutoConfiguration中配置了一个类型为<strong>SpringProcessEngineConfiguration</strong>的bean，其类图如下</p>
<p><img src="/images/flowable/class_diagram_SpringProcessEngineConfiguration.png" alt="SpringProcessEngineConfiguration"></p>
<p>可知，SpringProcessEngineConfiguration是ProcessEngineConfiguration的子类，而ProcessEngineConfiguration正是用于创建ProcessEngine的类。</p>
<p>不过这里只是注册了一个bean，并没有调用其buildProcessEngine()方法来创建ProcessEngine。ProcessEngine实例是在<a href="#ProcessEngineFactoryBean">ProcessEngineFactoryBean</a>中创建的。</p>
<h2 id="ProcessEngineServicesAutoConfiguration"><a href="#ProcessEngineServicesAutoConfiguration" class="headerlink" title="ProcessEngineServicesAutoConfiguration"></a>ProcessEngineServicesAutoConfiguration</h2><p>这个AutoConfiguration主要负责配置ProcessEngineFactoryBean及各个Service（RuntimeService, RepositoryService, TaskService等）。</p>
<p>各Service的配置比较简单，主要来看看ProcessEngineFactoryBean</p>
<h3 id="ProcessEngineFactoryBean"><a href="#ProcessEngineFactoryBean" class="headerlink" title="ProcessEngineFactoryBean"></a>ProcessEngineFactoryBean</h3><p>需要注意的是ProcessEngineFactoryBean是在内部类ProcessEngineServicesAutoConfiguration#StandaloneEngineConfiguration中注册的。</p>
<p>这是一个FactoryBean，我们知道Spring通过FactoryBean的getObject()方法来创建bean，来看看其代码</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ProcessEngineFactoryBean.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProcessEngineFactoryBean</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span><span class="token operator">&lt;</span>ProcessEngine<span class="token operator">></span><span class="token punctuation">,</span> DisposableBean<span class="token punctuation">,</span> ApplicationContextAware <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> ProcessEngineConfigurationImpl processEngineConfiguration<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ProcessEngine <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 省略无关代码...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>processEngine <span class="token operator">=</span> processEngineConfiguration<span class="token punctuation">.</span><span class="token function">buildProcessEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processEngine<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，ProcessEngineFactoryBean通过调用processEngineConfiguration.buildProcessEngine()创建了ProcessEngine的实例。</p>
<p>对于processEngineConfiguration这个对象的构建，可以参考<a href="#ProcessEngineAutoConfiguration">ProcessEngineAutoConfiguration</a></p>
<h1 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h1><p>flowable spring boot starter能够自动将classpath的相关目录（如processes, forms）下的资源自动部署。</p>
<p>不同的engine逻辑大同小异，以ProcessEngine为例，其核心在于SpringProcessEngineConfiguration这个类。</p>
<p>SpringProcessEngineConfiguration实现了spring的SmartLifecycle接口，相关代码如下</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// SpringProcessEngineConfiguration.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lifeCycleMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 遍历engines实例进行部署</span>
            enginesBuild<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>name <span class="token operator">-</span><span class="token operator">></span> <span class="token function">autoDeployResources</span><span class="token punctuation">(</span>ProcessEngines<span class="token punctuation">.</span><span class="token function">getProcessEngine</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lifeCycleMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> running<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中start方法正是对process engines所需要的资源进行自动部署，会在spring应用完成初始化后进行回调。</p>
<p>来看看autoDeployResources方法</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// SpringProcessEngineConfiguration.java</span>
<span class="token keyword">protected</span> Resource<span class="token punctuation">[</span><span class="token punctuation">]</span> deploymentResources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">autoDeployResources</span><span class="token punctuation">(</span>ProcessEngine processEngine<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deploymentResources <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> deploymentResources<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> AutoDeploymentStrategy strategy <span class="token operator">=</span> <span class="token function">getAutoDeploymentStrategy</span><span class="token punctuation">(</span>deploymentMode<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 选择部署策略</span>
        strategy<span class="token punctuation">.</span><span class="token function">deployResources</span><span class="token punctuation">(</span>deploymentName<span class="token punctuation">,</span> deploymentResources<span class="token punctuation">,</span> processEngine<span class="token punctuation">.</span><span class="token function">getRepositoryService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>字段deploymentResources的值是关键，通过调试，发现该字段是在ProcessEngineAutoConfiguration中进行赋值的</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ProcessEngineAutoConfiguration</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> SpringProcessEngineConfiguration <span class="token function">springProcessEngineConfiguration</span><span class="token punctuation">(</span>DataSource dataSource<span class="token punctuation">,</span> PlatformTransactionManager platformTransactionManager<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@Process</span> ObjectProvider<span class="token operator">&lt;</span>IdGenerator<span class="token operator">></span> processIdGenerator<span class="token punctuation">,</span>
        ObjectProvider<span class="token operator">&lt;</span>IdGenerator<span class="token operator">></span> globalIdGenerator<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@ProcessAsync</span> ObjectProvider<span class="token operator">&lt;</span>AsyncExecutor<span class="token operator">></span> asyncExecutorProvider<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@ProcessAsyncHistory</span> ObjectProvider<span class="token operator">&lt;</span>AsyncExecutor<span class="token operator">></span> asyncHistoryExecutorProvider<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>

    SpringProcessEngineConfiguration conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringProcessEngineConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 根据配置的规则找到相关的资源</span>
    List<span class="token operator">&lt;</span>Resource<span class="token operator">></span> resources <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">discoverDeploymentResources</span><span class="token punctuation">(</span>
        flowableProperties<span class="token punctuation">.</span><span class="token function">getProcessDefinitionLocationPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        flowableProperties<span class="token punctuation">.</span><span class="token function">getProcessDefinitionLocationSuffixes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        flowableProperties<span class="token punctuation">.</span><span class="token function">isCheckProcessDefinitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>resources <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>resources<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        conf<span class="token punctuation">.</span><span class="token function">setDeploymentResources</span><span class="token punctuation">(</span>resources<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conf<span class="token punctuation">.</span><span class="token function">setDeploymentName</span><span class="token punctuation">(</span>flowableProperties<span class="token punctuation">.</span><span class="token function">getDeploymentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...省略无关代码</span>

    <span class="token keyword">return</span> conf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="TODO-LIST"><a href="#TODO-LIST" class="headerlink" title="TODO LIST"></a>TODO LIST</h1><ul>
<li style="list-style: none"><input type="checkbox"> List&lt;EngineConfigurationConfigurer></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://taccisum.github.io/source/zuul/filter/dynamic_load.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="taccisum">
      <meta itemprop="description" content="el psy congroo.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Taccisum's blog 😉">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/source/zuul/filter/dynamic_load.html" class="post-title-link" itemprop="url">zuul源码解析 —— 动态加载Filter（未完成）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-01 14:19:14" itemprop="dateCreated datePublished" datetime="2018-12-01T14:19:14+08:00">2018-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-13 18:05:01" itemprop="dateModified" datetime="2020-03-13T18:05:01+08:00">2020-03-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/source/" itemprop="url" rel="index"><span itemprop="name">source</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/source/zuul/" itemprop="url" rel="index"><span itemprop="name">zuul</span></a>
                </span>
            </span>

          
            <span id="/source/zuul/filter/dynamic_load.html" class="post-meta-item leancloud_visitors" data-flag-title="zuul源码解析 —— 动态加载Filter（未完成）" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/source/zuul/filter/dynamic_load.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/source/zuul/filter/dynamic_load.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>zuul支持用两种语言编写的过滤器，分别是Groovy和Java。不过只有Groovy编写的过滤器才支持动态加载。</p>
<p>所谓动态加载，即是可以在应用的运行时对filter进行CRUD的操作，以达到动态调整zuul行为的目的。</p>
<p>以下我们看看zuul是如何实现这一点的。</p>
<h2 id="FilterLoader"><a href="#FilterLoader" class="headerlink" title="FilterLoader"></a>FilterLoader</h2><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// FilterLoader.java</span>
    <span class="token comment" spellcheck="true">/**
     * 获取所有指定类型的filter并排序，通过ZuulFilter.filterOrder()方法
     * Returns a list of filters by the filterType specified
     */</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>ZuulFilter<span class="token operator">></span> <span class="token function">getFiltersByType</span><span class="token punctuation">(</span>String filterType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 尝试从缓存中获取，如果存在缓存，则直接返回</span>
        List<span class="token operator">&lt;</span>ZuulFilter<span class="token operator">></span> list <span class="token operator">=</span> hashFiltersByType<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filterType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> list<span class="token punctuation">;</span>

        list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>ZuulFilter<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 从registry获取所有filter，从中找出需要的filter，最终进行排序</span>
        Collection<span class="token operator">&lt;</span>ZuulFilter<span class="token operator">></span> filters <span class="token operator">=</span> filterRegistry<span class="token punctuation">.</span><span class="token function">getAllFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator<span class="token operator">&lt;</span>ZuulFilter<span class="token operator">></span> iterator <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ZuulFilter filter <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span><span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>filterType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// sort by priority</span>

        <span class="token comment" spellcheck="true">// 将结果缓存起来</span>
        hashFiltersByType<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>filterType<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面代码可以看到，<code>getFiltersByType()</code>依赖于对象filterRegistry，zuul正是通过对该registry的CRUD实现动态加载filter的功能。</p>
<p>filterRegistry是FilterRegistry的一个唯一实例（单例模式）。FilterRegistry的代码很简单，就是简单地维护了一个用于存放filter的ConcurrentHashMap而以。关键需要找出zuul是如何维护这份registry的。</p>
<h2 id="FilterScriptManagerServlet"><a href="#FilterScriptManagerServlet" class="headerlink" title="FilterScriptManagerServlet"></a>FilterScriptManagerServlet</h2><p>需要在运行时维护registry，必然需要有一个入口。这个入口就是<code>FilterScriptManagerServlet</code>，这是一个HttpServlet，提供了以下HTTP资源：</p>
<table>
<thead>
<tr>
<th>路径</th>
<th>请求方式</th>
<th>Servlet对应的处理方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>LIST</td>
<td>GET</td>
<td>handleListAction</td>
<td>获取filter脚本</td>
</tr>
<tr>
<td>DOWNLOAD</td>
<td>GET</td>
<td>handleDownloadAction</td>
<td>下载脚本</td>
</tr>
<tr>
<td>UPLOAD</td>
<td>PUT/POST</td>
<td>handleUploadAction</td>
<td>上传脚本</td>
</tr>
<tr>
<td>ACTIVATE</td>
<td>PUT/POST</td>
<td>handleActivateAction</td>
<td>启用脚本</td>
</tr>
<tr>
<td>CANARY</td>
<td>PUT/POST</td>
<td>handleCanaryAction</td>
<td>TODO::还不知道干啥用的</td>
</tr>
<tr>
<td>DEACTIVATE</td>
<td>PUT/POST</td>
<td>handledeActivateAction</td>
<td>禁用脚本</td>
</tr>
</tbody>
</table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="taccisum"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">taccisum</p>
  <div class="site-description" itemprop="description">el psy congroo.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/taccisum" title="GitHub → https://github.com/taccisum" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/taccisum@gmail.com" title="G-Mail → taccisum@gmail.com"><i class="fa fa-envelope fa-fw"></i>G-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">taccisum</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'q1GTC85aQcIvQIf3p9tWLTvW-gzGzoHsz',
      appKey     : 'OjWCd5UV1xcOyCEfsSzu9w7z',
      placeholder: "欢迎畅所欲言",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
